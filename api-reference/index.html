
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A streamlined protocol for agent-to-agent communication">
      
      
      
        <link rel="canonical" href="https://asap-protocol.org/api-reference/">
      
      
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>API Reference - ASAP Protocol</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ASAP Protocol" class="md-header__button md-logo" aria-label="ASAP Protocol" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ASAP Protocol
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/asap-protocol/asap-protocol" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    asap-protocol/asap-protocol
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ASAP Protocol" class="md-nav__button md-logo" aria-label="ASAP Protocol" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ASAP Protocol
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/asap-protocol/asap-protocol" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    asap-protocol/asap-protocol
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/first-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building Your First Agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/stateful-workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stateful Workflows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/multi-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Agent Orchestration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/resilience/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building Resilient Agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/production-checklist/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Production Deployment Checklist
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture Decision Records
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture Decision Records
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Index
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-001-ulid-for-id-generation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-001 ULID for ID Generation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-002-async-first-api-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-002 Async-First API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-003-jsonrpc20-binding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-003 JSON-RPC 2.0
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-004-pydantic-for-models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-004 Pydantic for Models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-005-state-machine-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-005 State Machine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-006-security-defaults/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-006 Security Defaults
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-007-fastapi-for-server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-007 FastAPI for Server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-008-httpx-for-client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-008 httpx for Client
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-009-snapshot-vs-event-sourced/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-009 Snapshot vs Event-Sourced
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-010-python-313-requirement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-010 Python 3.13+
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-011-per-sender-rate-limiting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-011 Per-Sender Rate Limiting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-012-error-taxonomy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-012 Error Taxonomy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-013-mcp-integration-approach/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-013 MCP Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-014-testing-strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-014 Testing Strategy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-015-observability-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-015 Observability Design
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-016-versioning-policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-016 Versioning Policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adr/ADR-017-failure-injection-strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADR-017 Failure Injection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/identity-signing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Identity Signing (v1.2)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/compliance-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compliance Testing (v1.2)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/migration-v1.1-to-v1.2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Migration v1.1 â†’ v1.2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Security
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../state-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    State Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../transport/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Transport
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Migration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deployment/kubernetes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployment (Kubernetes)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Models
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Models
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/models/entities.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Entities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/models/payloads.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Payloads
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/models/parts.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/transport.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Transport
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/state.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    State
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Observability
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../error-handling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Error Handling
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-models" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Models
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#base" class="md-nav__link">
    <span class="md-ellipsis">
      
        Base
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asap.models.base" class="md-nav__link">
    <span class="md-ellipsis">
      
        base
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.base.ASAPBaseModel" class="md-nav__link">
    <span class="md-ellipsis">
      
        ASAPBaseModel
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        IDs
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asap.models.ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        ids
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ids">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.ids.extract_timestamp" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_timestamp
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.ids.generate_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_id
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enums" class="md-nav__link">
    <span class="md-ellipsis">
      
        Enums
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asap.models.enums" class="md-nav__link">
    <span class="md-ellipsis">
      
        enums
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="enums">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.enums.MessageRole" class="md-nav__link">
    <span class="md-ellipsis">
      
        MessageRole
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.enums.TaskStatus" class="md-nav__link">
    <span class="md-ellipsis">
      
        TaskStatus
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TaskStatus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.enums.TaskStatus.is_terminal" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_terminal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.enums.TaskStatus.terminal_states" class="md-nav__link">
    <span class="md-ellipsis">
      
        terminal_states
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.enums.UpdateType" class="md-nav__link">
    <span class="md-ellipsis">
      
        UpdateType
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.enums.VerificationState" class="md-nav__link">
    <span class="md-ellipsis">
      
        VerificationState
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Types
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asap.models.types" class="md-nav__link">
    <span class="md-ellipsis">
      
        types
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.types.AgentURN" class="md-nav__link">
    <span class="md-ellipsis">
      
        AgentURN
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.types.ArtifactID" class="md-nav__link">
    <span class="md-ellipsis">
      
        ArtifactID
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.types.ConversationID" class="md-nav__link">
    <span class="md-ellipsis">
      
        ConversationID
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.types.MIMEType" class="md-nav__link">
    <span class="md-ellipsis">
      
        MIMEType
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.types.MessageID" class="md-nav__link">
    <span class="md-ellipsis">
      
        MessageID
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.types.PartID" class="md-nav__link">
    <span class="md-ellipsis">
      
        PartID
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.types.SemanticVersion" class="md-nav__link">
    <span class="md-ellipsis">
      
        SemanticVersion
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.types.SnapshotID" class="md-nav__link">
    <span class="md-ellipsis">
      
        SnapshotID
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.types.TaskID" class="md-nav__link">
    <span class="md-ellipsis">
      
        TaskID
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.types.URI" class="md-nav__link">
    <span class="md-ellipsis">
      
        URI
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#entities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Entities
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asap.models.entities" class="md-nav__link">
    <span class="md-ellipsis">
      
        entities
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="entities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Agent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Artifact" class="md-nav__link">
    <span class="md-ellipsis">
      
        Artifact
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.AuthScheme" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuthScheme
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Capability" class="md-nav__link">
    <span class="md-ellipsis">
      
        Capability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.CommonMetadata" class="md-nav__link">
    <span class="md-ellipsis">
      
        CommonMetadata
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Conversation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conversation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      
        Endpoint
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Manifest" class="md-nav__link">
    <span class="md-ellipsis">
      
        Manifest
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manifest">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Manifest--with-sla-optional" class="md-nav__link">
    <span class="md-ellipsis">
      
        With SLA (optional):
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Message" class="md-nav__link">
    <span class="md-ellipsis">
      
        Message
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.SLADefinition" class="md-nav__link">
    <span class="md-ellipsis">
      
        SLADefinition
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Skill" class="md-nav__link">
    <span class="md-ellipsis">
      
        Skill
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.StateSnapshot" class="md-nav__link">
    <span class="md-ellipsis">
      
        StateSnapshot
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Task" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Task.can_be_cancelled" class="md-nav__link">
    <span class="md-ellipsis">
      
        can_be_cancelled
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.Task.is_terminal" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_terminal
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.entities.VerificationStatus" class="md-nav__link">
    <span class="md-ellipsis">
      
        VerificationStatus
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asap.models.parts" class="md-nav__link">
    <span class="md-ellipsis">
      
        parts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="parts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.Part" class="md-nav__link">
    <span class="md-ellipsis">
      
        Part
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.Part--deserializes-to-textpart" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deserializes to TextPart
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.Part--deserializes-to-datapart" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deserializes to DataPart
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.Part--deserializes-to-filepart" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deserializes to FilePart
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.DataPart" class="md-nav__link">
    <span class="md-ellipsis">
      
        DataPart
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.FilePart" class="md-nav__link">
    <span class="md-ellipsis">
      
        FilePart
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FilePart">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.FilePart--with-inline-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        With inline data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.FilePart.validate_base64" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate_base64
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.FilePart.validate_mime_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate_mime_type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.FilePart.validate_uri" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate_uri
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.ResourcePart" class="md-nav__link">
    <span class="md-ellipsis">
      
        ResourcePart
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.TemplatePart" class="md-nav__link">
    <span class="md-ellipsis">
      
        TemplatePart
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.parts.TextPart" class="md-nav__link">
    <span class="md-ellipsis">
      
        TextPart
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payloads" class="md-nav__link">
    <span class="md-ellipsis">
      
        Payloads
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asap.models.payloads" class="md-nav__link">
    <span class="md-ellipsis">
      
        payloads
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="payloads">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.PayloadType" class="md-nav__link">
    <span class="md-ellipsis">
      
        PayloadType
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.ArtifactNotify" class="md-nav__link">
    <span class="md-ellipsis">
      
        ArtifactNotify
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.McpResourceData" class="md-nav__link">
    <span class="md-ellipsis">
      
        McpResourceData
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.McpResourceFetch" class="md-nav__link">
    <span class="md-ellipsis">
      
        McpResourceFetch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.McpToolCall" class="md-nav__link">
    <span class="md-ellipsis">
      
        McpToolCall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.McpToolResult" class="md-nav__link">
    <span class="md-ellipsis">
      
        McpToolResult
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.MessageAck" class="md-nav__link">
    <span class="md-ellipsis">
      
        MessageAck
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.MessageSend" class="md-nav__link">
    <span class="md-ellipsis">
      
        MessageSend
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.StateQuery" class="md-nav__link">
    <span class="md-ellipsis">
      
        StateQuery
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.StateRestore" class="md-nav__link">
    <span class="md-ellipsis">
      
        StateRestore
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.TaskCancel" class="md-nav__link">
    <span class="md-ellipsis">
      
        TaskCancel
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.TaskMetrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        TaskMetrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.TaskRequest" class="md-nav__link">
    <span class="md-ellipsis">
      
        TaskRequest
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.TaskRequestConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        TaskRequestConfig
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.TaskResponse" class="md-nav__link">
    <span class="md-ellipsis">
      
        TaskResponse
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.payloads.TaskUpdate" class="md-nav__link">
    <span class="md-ellipsis">
      
        TaskUpdate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#envelope" class="md-nav__link">
    <span class="md-ellipsis">
      
        Envelope
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asap.models.envelope" class="md-nav__link">
    <span class="md-ellipsis">
      
        envelope
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="envelope">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.envelope.Envelope" class="md-nav__link">
    <span class="md-ellipsis">
      
        Envelope
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Envelope">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.models.envelope.Envelope--id-and-timestamp-are-auto-generated" class="md-nav__link">
    <span class="md-ellipsis">
      
        id and timestamp are auto-generated
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.envelope.Envelope.generate_id_if_missing" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_id_if_missing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.envelope.Envelope.generate_timestamp_if_missing" class="md-nav__link">
    <span class="md-ellipsis">
      
        generate_timestamp_if_missing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.models.envelope.Envelope.validate_sender_recipient_urn" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate_sender_recipient_urn
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#state" class="md-nav__link">
    <span class="md-ellipsis">
      
        State
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asap.state" class="md-nav__link">
    <span class="md-ellipsis">
      
        state
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="state">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemoryMeteringStore" class="md-nav__link">
    <span class="md-ellipsis">
      
        InMemoryMeteringStore
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InMemoryMeteringStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemoryMeteringStore.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemoryMeteringStore.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemoryMeteringStore.query" class="md-nav__link">
    <span class="md-ellipsis">
      
        query
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemoryMeteringStore.record" class="md-nav__link">
    <span class="md-ellipsis">
      
        record
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemorySnapshotStore" class="md-nav__link">
    <span class="md-ellipsis">
      
        InMemorySnapshotStore
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="InMemorySnapshotStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemorySnapshotStore.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemorySnapshotStore.delete" class="md-nav__link">
    <span class="md-ellipsis">
      
        delete
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemorySnapshotStore.get" class="md-nav__link">
    <span class="md-ellipsis">
      
        get
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemorySnapshotStore.list_versions" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_versions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.InMemorySnapshotStore.save" class="md-nav__link">
    <span class="md-ellipsis">
      
        save
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.MeteringStore" class="md-nav__link">
    <span class="md-ellipsis">
      
        MeteringStore
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MeteringStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.state.MeteringStore.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.MeteringStore.query" class="md-nav__link">
    <span class="md-ellipsis">
      
        query
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.MeteringStore.record" class="md-nav__link">
    <span class="md-ellipsis">
      
        record
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteMeteringStore" class="md-nav__link">
    <span class="md-ellipsis">
      
        SQLiteMeteringStore
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SQLiteMeteringStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteMeteringStore.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteMeteringStore.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteMeteringStore.initialize" class="md-nav__link">
    <span class="md-ellipsis">
      
        initialize
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteMeteringStore.query" class="md-nav__link">
    <span class="md-ellipsis">
      
        query
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteMeteringStore.record" class="md-nav__link">
    <span class="md-ellipsis">
      
        record
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteSnapshotStore" class="md-nav__link">
    <span class="md-ellipsis">
      
        SQLiteSnapshotStore
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SQLiteSnapshotStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteSnapshotStore.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteSnapshotStore.delete" class="md-nav__link">
    <span class="md-ellipsis">
      
        delete
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteSnapshotStore.get" class="md-nav__link">
    <span class="md-ellipsis">
      
        get
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteSnapshotStore.initialize" class="md-nav__link">
    <span class="md-ellipsis">
      
        initialize
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteSnapshotStore.list_versions" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_versions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SQLiteSnapshotStore.save" class="md-nav__link">
    <span class="md-ellipsis">
      
        save
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SnapshotStore" class="md-nav__link">
    <span class="md-ellipsis">
      
        SnapshotStore
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SnapshotStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.state.SnapshotStore.delete" class="md-nav__link">
    <span class="md-ellipsis">
      
        delete
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SnapshotStore.get" class="md-nav__link">
    <span class="md-ellipsis">
      
        get
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SnapshotStore.list_versions" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_versions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.SnapshotStore.save" class="md-nav__link">
    <span class="md-ellipsis">
      
        save
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.TaskStatus" class="md-nav__link">
    <span class="md-ellipsis">
      
        TaskStatus
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TaskStatus">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.state.TaskStatus.is_terminal" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_terminal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.TaskStatus.terminal_states" class="md-nav__link">
    <span class="md-ellipsis">
      
        terminal_states
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.UsageAggregate" class="md-nav__link">
    <span class="md-ellipsis">
      
        UsageAggregate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.UsageEvent" class="md-nav__link">
    <span class="md-ellipsis">
      
        UsageEvent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.UsageMetrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        UsageMetrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.can_transition" class="md-nav__link">
    <span class="md-ellipsis">
      
        can_transition
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.create_snapshot_store" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_snapshot_store
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.state.transition" class="md-nav__link">
    <span class="md-ellipsis">
      
        transition
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transport" class="md-nav__link">
    <span class="md-ellipsis">
      
        Transport
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asap.transport" class="md-nav__link">
    <span class="md-ellipsis">
      
        transport
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="transport">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.transport.DEFAULT_MAX_RETRIES" class="md-nav__link">
    <span class="md-ellipsis">
      
        DEFAULT_MAX_RETRIES
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.DEFAULT_RETRY_BASE_DELAY" class="md-nav__link">
    <span class="md-ellipsis">
      
        DEFAULT_RETRY_BASE_DELAY
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.DEFAULT_RETRY_MAX_DELAY" class="md-nav__link">
    <span class="md-ellipsis">
      
        DEFAULT_RETRY_MAX_DELAY
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.DEFAULT_WEBHOOK_RATE_PER_SECOND" class="md-nav__link">
    <span class="md-ellipsis">
      
        DEFAULT_WEBHOOK_RATE_PER_SECOND
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPClient" class="md-nav__link">
    <span class="md-ellipsis">
      
        ASAPClient
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ASAPClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPClient--batch-operations-with-http2-multiplexing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Batch operations with HTTP/2 multiplexing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPClient--disable-compression-for-specific-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        Disable compression for specific client
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPClient.is_connected" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_connected
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPClient.discover" class="md-nav__link">
    <span class="md-ellipsis">
      
        discover
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPClient.get_manifest" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_manifest
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPClient.health_check" class="md-nav__link">
    <span class="md-ellipsis">
      
        health_check
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPClient.send" class="md-nav__link">
    <span class="md-ellipsis">
      
        send
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPClient.send_batch" class="md-nav__link">
    <span class="md-ellipsis">
      
        send_batch
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="send_batch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPClient.send_batch--with-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        With error handling
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPConnectionError" class="md-nav__link">
    <span class="md-ellipsis">
      
        ASAPConnectionError
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPRemoteError" class="md-nav__link">
    <span class="md-ellipsis">
      
        ASAPRemoteError
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPRequestHandler" class="md-nav__link">
    <span class="md-ellipsis">
      
        ASAPRequestHandler
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ASAPRequestHandler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPRequestHandler.handle_message" class="md-nav__link">
    <span class="md-ellipsis">
      
        handle_message
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPRequestHandler.parse_json_body" class="md-nav__link">
    <span class="md-ellipsis">
      
        parse_json_body
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPRequestHandler.validate_jsonrpc_request" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate_jsonrpc_request
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ASAPTimeoutError" class="md-nav__link">
    <span class="md-ellipsis">
      
        ASAPTimeoutError
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.CompressionAlgorithm" class="md-nav__link">
    <span class="md-ellipsis">
      
        CompressionAlgorithm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.DeadLetterEntry" class="md-nav__link">
    <span class="md-ellipsis">
      
        DeadLetterEntry
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.HandlerNotFoundError" class="md-nav__link">
    <span class="md-ellipsis">
      
        HandlerNotFoundError
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.HandlerRegistry" class="md-nav__link">
    <span class="md-ellipsis">
      
        HandlerRegistry
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HandlerRegistry">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.transport.HandlerRegistry.dispatch" class="md-nav__link">
    <span class="md-ellipsis">
      
        dispatch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.HandlerRegistry.dispatch_async" class="md-nav__link">
    <span class="md-ellipsis">
      
        dispatch_async
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.HandlerRegistry.list_handlers" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_handlers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.HandlerRegistry.set_metering_store" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_metering_store
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.JsonRpcError" class="md-nav__link">
    <span class="md-ellipsis">
      
        JsonRpcError
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JsonRpcError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.transport.JsonRpcError.from_code" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_code
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.JsonRpcErrorResponse" class="md-nav__link">
    <span class="md-ellipsis">
      
        JsonRpcErrorResponse
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.JsonRpcRequest" class="md-nav__link">
    <span class="md-ellipsis">
      
        JsonRpcRequest
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.JsonRpcResponse" class="md-nav__link">
    <span class="md-ellipsis">
      
        JsonRpcResponse
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.ManifestCache" class="md-nav__link">
    <span class="md-ellipsis">
      
        ManifestCache
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ManifestCache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.transport.ManifestCache.cleanup_expired" class="md-nav__link">
    <span class="md-ellipsis">
      
        cleanup_expired
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.RetryConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        RetryConfig
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.RetryPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      
        RetryPolicy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RetryPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.transport.RetryPolicy.backoff_delay" class="md-nav__link">
    <span class="md-ellipsis">
      
        backoff_delay
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.WebhookDelivery" class="md-nav__link">
    <span class="md-ellipsis">
      
        WebhookDelivery
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.WebhookRetryManager" class="md-nav__link">
    <span class="md-ellipsis">
      
        WebhookRetryManager
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WebhookRetryManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.transport.WebhookRetryManager.deliver_with_retry" class="md-nav__link">
    <span class="md-ellipsis">
      
        deliver_with_retry
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.compress_payload" class="md-nav__link">
    <span class="md-ellipsis">
      
        compress_payload
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.compute_signature" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_signature
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.create_app" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_app
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_app">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asap.transport.create_app--with-sla-optional-add-slasladefinitionavailability995-max_latency_p95_ms500" class="md-nav__link">
    <span class="md-ellipsis">
      
        With SLA (optional): add sla=SLADefinition(availability="99.5%", max_latency_p95_ms=500)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.create_app--with-authentication" class="md-nav__link">
    <span class="md-ellipsis">
      
        With authentication:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.create_app--with-custom-registry" class="md-nav__link">
    <span class="md-ellipsis">
      
        With custom registry:
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.create_app--run-with-uvicorn-uvicorn-moduleapp" class="md-nav__link">
    <span class="md-ellipsis">
      
        Run with uvicorn: uvicorn module:app
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.create_default_registry" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_default_registry
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.create_echo_handler" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_echo_handler
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.decompress_payload" class="md-nav__link">
    <span class="md-ellipsis">
      
        decompress_payload
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.select_best_encoding" class="md-nav__link">
    <span class="md-ellipsis">
      
        select_best_encoding
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.validate_callback_url" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate_callback_url
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asap.transport.verify_signature" class="md-nav__link">
    <span class="md-ellipsis">
      
        verify_signature
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="api-reference">API Reference</h1>
<p>This reference is generated via mkdocstrings and reflects the public API.</p>
<h2 id="core-models">Core Models</h2>
<h3 id="base">Base</h3>


<div class="doc doc-object doc-module">



<h2 id="asap.models.base" class="doc doc-heading">
            <code>asap.models.base</code>


</h2>

    <div class="doc doc-contents first">

        <p>Base Pydantic model configuration for ASAP protocol models.</p>
<p>All ASAP models inherit from ASAPBaseModel to ensure consistent behavior:
- Immutability (frozen=True) for thread-safety and predictability
- Strict validation (extra="forbid") to catch typos and invalid fields
- Flexible field naming (populate_by_name=True) for alias support
- JSON Schema generation with proper metadata</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="asap.models.base.ASAPBaseModel" class="doc doc-heading">
            <code>ASAPBaseModel</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>



        <p>Base model for all ASAP protocol entities.</p>
<p>This base class provides:
- <strong>Immutability</strong>: Models are frozen after creation (thread-safe)
- <strong>Strict validation</strong>: Extra fields are forbidden (catches errors early)
- <strong>Flexible naming</strong>: Fields can be populated by name or alias
- <strong>JSON Schema</strong>: Proper schema generation for interoperability</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from pydantic import Field
class MyModel(ASAPBaseModel):
...     name: str
...     count: int = Field(default=0, ge=0)</p>
<p>obj = MyModel(name="test", count=5)
obj.name
'test'
obj.count = 10  # Raises ValidationError (frozen)
Traceback (most recent call last):
...
pydantic_core._pydantic_core.ValidationError: ...</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ASAPBaseModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base model for all ASAP protocol entities.</span>

<span class="sd">    This base class provides:</span>
<span class="sd">    - **Immutability**: Models are frozen after creation (thread-safe)</span>
<span class="sd">    - **Strict validation**: Extra fields are forbidden (catches errors early)</span>
<span class="sd">    - **Flexible naming**: Fields can be populated by name or alias</span>
<span class="sd">    - **JSON Schema**: Proper schema generation for interoperability</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from pydantic import Field</span>
<span class="sd">        &gt;&gt;&gt; class MyModel(ASAPBaseModel):</span>
<span class="sd">        ...     name: str</span>
<span class="sd">        ...     count: int = Field(default=0, ge=0)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; obj = MyModel(name=&quot;test&quot;, count=5)</span>
<span class="sd">        &gt;&gt;&gt; obj.name</span>
<span class="sd">        &#39;test&#39;</span>
<span class="sd">        &gt;&gt;&gt; obj.count = 10  # Raises ValidationError (frozen)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        pydantic_core._pydantic_core.ValidationError: ...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span>
        <span class="c1"># Immutability: prevents accidental mutations after creation</span>
        <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># Strict validation: reject unknown fields to catch typos</span>
        <span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">,</span>
        <span class="c1"># Allow populating fields by both name and alias</span>
        <span class="n">populate_by_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># JSON Schema configuration</span>
        <span class="n">use_enum_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">validate_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validate_assignment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="c1"># JSON Schema extras for better documentation</span>
        <span class="n">json_schema_extra</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="ids">IDs</h3>


<div class="doc doc-object doc-module">



<h2 id="asap.models.ids" class="doc doc-heading">
            <code>asap.models.ids</code>


</h2>

    <div class="doc doc-contents first">

        <p>ULID-based ID generation for ASAP protocol entities.</p>
<p>ULIDs (Universally Unique Lexicographically Sortable Identifiers) provide:
- 128-bit compatibility with UUID
- Lexicographic sorting by creation time when timestamps differ (millisecond precision)
- Canonically encoded as 26-character string (Crockford's Base32)</p>
<p>Note: Order is guaranteed only across different milliseconds. Two ULIDs generated
within the same millisecond share the same timestamp prefix; their lexicographic
order is then determined by the random component and may not match generation order.</p>










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="asap.models.ids.extract_timestamp" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_timestamp</span><span class="p">(</span><span class="n">ulid</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Extract the timestamp from a ULID string.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ulid</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 26-character ULID string</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A timezone-aware datetime in UTC representing when the ULID was created</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the ULID string is invalid</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>ulid = generate_id()
timestamp = extract_timestamp(ulid)
timestamp.tzinfo == timezone.utc
True</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/ids.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_timestamp</span><span class="p">(</span><span class="n">ulid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract the timestamp from a ULID string.</span>

<span class="sd">    Args:</span>
<span class="sd">        ulid: A 26-character ULID string</span>

<span class="sd">    Returns:</span>
<span class="sd">        A timezone-aware datetime in UTC representing when the ULID was created</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the ULID string is invalid</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; ulid = generate_id()</span>
<span class="sd">        &gt;&gt;&gt; timestamp = extract_timestamp(ulid)</span>
<span class="sd">        &gt;&gt;&gt; timestamp.tzinfo == timezone.utc</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ulid_obj</span> <span class="o">=</span> <span class="n">ULID</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="n">ulid</span><span class="p">)</span>
    <span class="c1"># ULID.datetime returns a timezone-aware datetime in UTC</span>
    <span class="k">return</span> <span class="n">ulid_obj</span><span class="o">.</span><span class="n">datetime</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.models.ids.generate_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_id</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a new ULID string.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A 26-character ULID string that is:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>Globally unique</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>Lexicographically sortable by creation time when generated in different
milliseconds (within the same millisecond, order is not guaranteed)</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>URL-safe (uses Crockford's Base32 alphabet)</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>id1 = generate_id()
len(id1)
26
id2 = generate_id()
id1 &lt; id2  # True when timestamps differ (e.g. different ms)
True</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/ids.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_id</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a new ULID string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A 26-character ULID string that is:</span>
<span class="sd">        - Globally unique</span>
<span class="sd">        - Lexicographically sortable by creation time when generated in different</span>
<span class="sd">          milliseconds (within the same millisecond, order is not guaranteed)</span>
<span class="sd">        - URL-safe (uses Crockford&#39;s Base32 alphabet)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; id1 = generate_id()</span>
<span class="sd">        &gt;&gt;&gt; len(id1)</span>
<span class="sd">        26</span>
<span class="sd">        &gt;&gt;&gt; id2 = generate_id()</span>
<span class="sd">        &gt;&gt;&gt; id1 &lt; id2  # True when timestamps differ (e.g. different ms)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">ULID</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="enums">Enums</h3>


<div class="doc doc-object doc-module">



<h2 id="asap.models.enums" class="doc doc-heading">
            <code>asap.models.enums</code>


</h2>

    <div class="doc doc-contents first">

        <p>Enumerations for ASAP protocol.</p>
<p>This module defines all enum types used in the protocol to ensure
type safety and prevent magic strings.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="asap.models.enums.MessageRole" class="doc doc-heading">
            <code>MessageRole</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Message sender roles.</p>
<p>Defines the role of the entity sending a message in a conversation.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>MessageRole.USER.value
'user'</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/enums.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MessageRole</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Message sender roles.</span>

<span class="sd">    Defines the role of the entity sending a message in a conversation.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; MessageRole.USER.value</span>
<span class="sd">        &#39;user&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">USER</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
    <span class="n">ASSISTANT</span> <span class="o">=</span> <span class="s2">&quot;assistant&quot;</span>
    <span class="n">SYSTEM</span> <span class="o">=</span> <span class="s2">&quot;system&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.enums.TaskStatus" class="doc doc-heading">
            <code>TaskStatus</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Task lifecycle states.</p>
<p>Tasks progress through these states during their lifecycle.
Terminal states are: COMPLETED, FAILED, CANCELLED.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>TaskStatus.COMPLETED.is_terminal()
True
TaskStatus.WORKING.is_terminal()
False</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/enums.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TaskStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Task lifecycle states.</span>

<span class="sd">    Tasks progress through these states during their lifecycle.</span>
<span class="sd">    Terminal states are: COMPLETED, FAILED, CANCELLED.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; TaskStatus.COMPLETED.is_terminal()</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; TaskStatus.WORKING.is_terminal()</span>
<span class="sd">        False</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMITTED</span> <span class="o">=</span> <span class="s2">&quot;submitted&quot;</span>
    <span class="n">WORKING</span> <span class="o">=</span> <span class="s2">&quot;working&quot;</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
    <span class="n">INPUT_REQUIRED</span> <span class="o">=</span> <span class="s2">&quot;input_required&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">terminal_states</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="s2">&quot;TaskStatus&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all terminal states.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Frozen set containing all terminal task states</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">({</span><span class="bp">cls</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this status represents a terminal state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_states</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.models.enums.TaskStatus.is_terminal" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_terminal</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Check if this status represents a terminal state.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/enums.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if this status represents a terminal state.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_states</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.models.enums.TaskStatus.terminal_states" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">terminal_states</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Return all terminal states.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="frozenset">frozenset</span>[<a class="autorefs autorefs-internal" title="TaskStatus (asap.models.enums.TaskStatus)" href="#asap.models.enums.TaskStatus">TaskStatus</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frozen set containing all terminal task states</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/enums.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">terminal_states</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="s2">&quot;TaskStatus&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return all terminal states.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Frozen set containing all terminal task states</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">frozenset</span><span class="p">({</span><span class="bp">cls</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.enums.UpdateType" class="doc doc-heading">
            <code>UpdateType</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Task update types.</p>
<p>Defines the type of update being sent for a task.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>UpdateType.PROGRESS.value
'progress'</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/enums.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UpdateType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Task update types.</span>

<span class="sd">    Defines the type of update being sent for a task.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; UpdateType.PROGRESS.value</span>
<span class="sd">        &#39;progress&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">PROGRESS</span> <span class="o">=</span> <span class="s2">&quot;progress&quot;</span>
    <span class="n">INPUT_REQUIRED</span> <span class="o">=</span> <span class="s2">&quot;input_required&quot;</span>
    <span class="n">STATUS_CHANGE</span> <span class="o">=</span> <span class="s2">&quot;status_change&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.enums.VerificationState" class="doc doc-heading">
            <code>VerificationState</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Verification status for marketplace trust badge (Task 3.6).</p>
<p>When status is VERIFIED, the agent displays a Verified badge in the registry UI.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/enums.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VerificationState</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verification status for marketplace trust badge (Task 3.6).</span>

<span class="sd">    When status is VERIFIED, the agent displays a Verified badge in the registry UI.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">VERIFIED</span> <span class="o">=</span> <span class="s2">&quot;verified&quot;</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">REJECTED</span> <span class="o">=</span> <span class="s2">&quot;rejected&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="types">Types</h3>


<div class="doc doc-object doc-module">



<h2 id="asap.models.types" class="doc doc-heading">
            <code>asap.models.types</code>


</h2>

    <div class="doc doc-contents first">

        <p>Type aliases for ASAP protocol.</p>
<p>This module defines type aliases to improve code readability and
document the semantic meaning of string types.</p>










<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="asap.models.types.AgentURN" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">AgentURN</span> <span class="o">=</span> <span class="nb">str</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Agent identifier in URN format: urn:asap:agent:{name}</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.models.types.ArtifactID" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ArtifactID</span> <span class="o">=</span> <span class="nb">str</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Unique artifact identifier (ULID format)</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.models.types.ConversationID" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ConversationID</span> <span class="o">=</span> <span class="nb">str</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Unique conversation identifier (ULID format)</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.models.types.MIMEType" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">MIMEType</span> <span class="o">=</span> <span class="nb">str</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>MIME type string (e.g., 'application/json')</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.models.types.MessageID" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">MessageID</span> <span class="o">=</span> <span class="nb">str</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Unique message identifier (ULID format)</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.models.types.PartID" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">PartID</span> <span class="o">=</span> <span class="nb">str</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Unique part identifier (ULID format)</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.models.types.SemanticVersion" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">SemanticVersion</span> <span class="o">=</span> <span class="nb">str</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Semantic version string (e.g., '1.0.0')</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.models.types.SnapshotID" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">SnapshotID</span> <span class="o">=</span> <span class="nb">str</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Unique state snapshot identifier (ULID format)</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.models.types.TaskID" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">TaskID</span> <span class="o">=</span> <span class="nb">str</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Unique task identifier (ULID format)</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.models.types.URI" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">URI</span> <span class="o">=</span> <span class="nb">str</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Uniform Resource Identifier</p>

    </div>

</div>






  </div>

    </div>

</div><h3 id="entities">Entities</h3>


<div class="doc doc-object doc-module">



<h2 id="asap.models.entities" class="doc doc-heading">
            <code>asap.models.entities</code>


</h2>

    <div class="doc doc-contents first">

        <p>Core entity models for the ASAP protocol.</p>
<p>This module defines the fundamental entities used in agent-to-agent communication:
- Agent: An autonomous entity capable of sending/receiving ASAP messages
- Manifest: Self-describing metadata about an agent's capabilities
- Conversation: Context for related interactions between agents
- Task: Fundamental unit of work with lifecycle management
- Message: Single communication turn containing parts
- Artifact: Concrete output produced by task execution
- StateSnapshot: First-class state persistence mechanism
- Skill: A specific capability that an agent can perform
- Capability: Collection of an agent's features and supported operations
- Endpoint: Network endpoints for agent communication
- AuthScheme: Authentication configuration for agent access
- SLADefinition: Service level agreement guarantees (availability, latency, error rate)</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.Agent" class="doc doc-heading">
            <code>Agent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>An autonomous entity capable of sending and receiving ASAP messages.</p>
<p>Agents are symmetric peers with no inherent client/server distinction.
Each agent has a unique identifier and publishes a manifest describing
its capabilities.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Agent.id">id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AgentURN = str

  
      module-attribute
   (asap.models.types.AgentURN)" href="#asap.models.types.AgentURN">AgentURN</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique agent identifier (URN format, e.g., "urn:asap:agent:research-v1")</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Agent.manifest_uri">manifest_uri</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URL where the agent's manifest can be retrieved</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Agent.capabilities">capabilities</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of capability strings (e.g., ["task.execute", "mcp.tools"])</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>agent = Agent(
...     id="urn:asap:agent:research-v1",
...     manifest_uri="https://agents.example.com/.well-known/asap/research-v1.json",
...     capabilities=["task.execute", "state.persist", "mcp.tools"]
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Agent</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An autonomous entity capable of sending and receiving ASAP messages.</span>

<span class="sd">    Agents are symmetric peers with no inherent client/server distinction.</span>
<span class="sd">    Each agent has a unique identifier and publishes a manifest describing</span>
<span class="sd">    its capabilities.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique agent identifier (URN format, e.g., &quot;urn:asap:agent:research-v1&quot;)</span>
<span class="sd">        manifest_uri: URL where the agent&#39;s manifest can be retrieved</span>
<span class="sd">        capabilities: List of capability strings (e.g., [&quot;task.execute&quot;, &quot;mcp.tools&quot;])</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; agent = Agent(</span>
<span class="sd">        ...     id=&quot;urn:asap:agent:research-v1&quot;,</span>
<span class="sd">        ...     manifest_uri=&quot;https://agents.example.com/.well-known/asap/research-v1.json&quot;,</span>
<span class="sd">        ...     capabilities=[&quot;task.execute&quot;, &quot;state.persist&quot;, &quot;mcp.tools&quot;]</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">AgentURN</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique agent identifier (URN format)&quot;</span><span class="p">)</span>
    <span class="n">manifest_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;URL to agent&#39;s manifest&quot;</span><span class="p">)</span>
    <span class="n">capabilities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Agent capability strings&quot;</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_urn_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">validate_agent_urn</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.Artifact" class="doc doc-heading">
            <code>Artifact</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Concrete output produced by task execution.</p>
<p>Artifacts represent the tangible results of task completion,
such as reports, data files, or other generated content.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Artifact.id">id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ArtifactID = str

  
      module-attribute
   (asap.models.types.ArtifactID)" href="#asap.models.types.ArtifactID">ArtifactID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique artifact identifier (ULID format)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Artifact.task_id">task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the task that produced this artifact</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Artifact.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Human-readable artifact name</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Artifact.parts">parts</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="PartID = str

  
      module-attribute
   (asap.models.types.PartID)" href="#asap.models.types.PartID">PartID</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of part IDs that make up this artifact</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Artifact.created_at">created_at</span></code></td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When the artifact was created (UTC)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from datetime import datetime, timezone
artifact = Artifact(
...     id="art_01HX5K6Q...",
...     task_id="task_01HX5K4N...",
...     name="Q3 Market Analysis Report",
...     parts=["part_01HX5K..."],
...     created_at=datetime.now(timezone.utc)
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Artifact</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Concrete output produced by task execution.</span>

<span class="sd">    Artifacts represent the tangible results of task completion,</span>
<span class="sd">    such as reports, data files, or other generated content.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique artifact identifier (ULID format)</span>
<span class="sd">        task_id: ID of the task that produced this artifact</span>
<span class="sd">        name: Human-readable artifact name</span>
<span class="sd">        parts: List of part IDs that make up this artifact</span>
<span class="sd">        created_at: When the artifact was created (UTC)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime, timezone</span>
<span class="sd">        &gt;&gt;&gt; artifact = Artifact(</span>
<span class="sd">        ...     id=&quot;art_01HX5K6Q...&quot;,</span>
<span class="sd">        ...     task_id=&quot;task_01HX5K4N...&quot;,</span>
<span class="sd">        ...     name=&quot;Q3 Market Analysis Report&quot;,</span>
<span class="sd">        ...     parts=[&quot;part_01HX5K...&quot;],</span>
<span class="sd">        ...     created_at=datetime.now(timezone.utc)</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">ArtifactID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique artifact identifier (ULID)&quot;</span><span class="p">)</span>
    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parent task ID&quot;</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Human-readable artifact name&quot;</span><span class="p">)</span>
    <span class="n">parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PartID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Part IDs making up this artifact&quot;</span><span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Creation timestamp (UTC)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.AuthScheme" class="doc doc-heading">
            <code>AuthScheme</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Authentication configuration for agent access.</p>
<p>Defines the authentication methods supported by an agent and
optional OAuth2 configuration.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.AuthScheme.schemes">schemes</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of supported auth schemes (e.g., ["bearer", "oauth2"])</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.AuthScheme.oauth2">oauth2</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional OAuth2 configuration with URLs and scopes</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>auth = AuthScheme(
...     schemes=["bearer", "oauth2"],
...     oauth2={
...         "authorization_url": "https://auth.example.com/authorize",
...         "token_url": "https://auth.example.com/token",
...         "scopes": ["asap:execute", "asap:read"]
...     }
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AuthScheme</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Authentication configuration for agent access.</span>

<span class="sd">    Defines the authentication methods supported by an agent and</span>
<span class="sd">    optional OAuth2 configuration.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        schemes: List of supported auth schemes (e.g., [&quot;bearer&quot;, &quot;oauth2&quot;])</span>
<span class="sd">        oauth2: Optional OAuth2 configuration with URLs and scopes</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; auth = AuthScheme(</span>
<span class="sd">        ...     schemes=[&quot;bearer&quot;, &quot;oauth2&quot;],</span>
<span class="sd">        ...     oauth2={</span>
<span class="sd">        ...         &quot;authorization_url&quot;: &quot;https://auth.example.com/authorize&quot;,</span>
<span class="sd">        ...         &quot;token_url&quot;: &quot;https://auth.example.com/token&quot;,</span>
<span class="sd">        ...         &quot;scopes&quot;: [&quot;asap:execute&quot;, &quot;asap:read&quot;]</span>
<span class="sd">        ...     }</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">schemes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Supported authentication schemes&quot;</span><span class="p">)</span>
    <span class="n">oauth2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;OAuth2 configuration if oauth2 is in schemes&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.Capability" class="doc doc-heading">
            <code>Capability</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Collection of an agent's features and supported operations.</p>
<p>Capabilities describe what an agent can do, including skills,
state persistence, streaming support, and MCP tool integration.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Capability.asap_version">asap_version</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ASAP protocol version supported (e.g., "0.1")</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Capability.skills">skills</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Skill (asap.models.entities.Skill)" href="#asap.models.entities.Skill">Skill</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of skills the agent can perform</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Capability.state_persistence">state_persistence</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the agent supports state snapshots</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Capability.streaming">streaming</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the agent supports streaming responses</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Capability.mcp_tools">mcp_tools</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of MCP tool names the agent can execute</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>capability = Capability(
...     asap_version="0.1",
...     skills=[Skill(id="research", description="Research skill")],
...     state_persistence=True,
...     streaming=True,
...     mcp_tools=["web_search"]
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Capability</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collection of an agent&#39;s features and supported operations.</span>

<span class="sd">    Capabilities describe what an agent can do, including skills,</span>
<span class="sd">    state persistence, streaming support, and MCP tool integration.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        asap_version: ASAP protocol version supported (e.g., &quot;0.1&quot;)</span>
<span class="sd">        skills: List of skills the agent can perform</span>
<span class="sd">        state_persistence: Whether the agent supports state snapshots</span>
<span class="sd">        streaming: Whether the agent supports streaming responses</span>
<span class="sd">        mcp_tools: List of MCP tool names the agent can execute</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; capability = Capability(</span>
<span class="sd">        ...     asap_version=&quot;0.1&quot;,</span>
<span class="sd">        ...     skills=[Skill(id=&quot;research&quot;, description=&quot;Research skill&quot;)],</span>
<span class="sd">        ...     state_persistence=True,</span>
<span class="sd">        ...     streaming=True,</span>
<span class="sd">        ...     mcp_tools=[&quot;web_search&quot;]</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">asap_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">ASAP_PROTOCOL_VERSION</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ASAP protocol version&quot;</span><span class="p">)</span>
    <span class="n">skills</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Skill</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Available skills&quot;</span><span class="p">)</span>
    <span class="n">state_persistence</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Supports state snapshots&quot;</span><span class="p">)</span>
    <span class="n">streaming</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Supports streaming responses&quot;</span><span class="p">)</span>
    <span class="n">mcp_tools</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Available MCP tools&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.CommonMetadata" class="doc doc-heading">
            <code>CommonMetadata</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Common metadata keys (extra allowed).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CommonMetadata</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Common metadata keys (extra allowed).&quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;allow&quot;</span><span class="p">)</span>

    <span class="n">purpose</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Conversation purpose&quot;</span><span class="p">)</span>
    <span class="n">ttl_hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Time-to-live in hours&quot;</span><span class="p">)</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Source identifier&quot;</span><span class="p">)</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ISO timestamp&quot;</span><span class="p">)</span>
    <span class="n">tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Tags for categorization&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.Conversation" class="doc doc-heading">
            <code>Conversation</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>A context for related interactions between agents.</p>
<p>Conversations enable shared context accumulation, task grouping,
and state isolation between unrelated work.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Conversation.id">id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ConversationID = str

  
      module-attribute
   (asap.models.types.ConversationID)" href="#asap.models.types.ConversationID">ConversationID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique conversation identifier (ULID format)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Conversation.participants">participants</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="AgentURN = str

  
      module-attribute
   (asap.models.types.AgentURN)" href="#asap.models.types.AgentURN">AgentURN</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of agent URNs participating in the conversation</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Conversation.created_at">created_at</span></code></td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timestamp when the conversation was created (UTC)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Conversation.metadata">metadata</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="CommonMetadata (asap.models.entities.CommonMetadata)" href="#asap.models.entities.CommonMetadata">CommonMetadata</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional metadata (e.g., purpose, TTL, tags)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from datetime import datetime, timezone
conversation = Conversation(
...     id="conv_01HX5K3MQVN8...",
...     participants=["urn:asap:agent:coordinator", "urn:asap:agent:research-v1"],
...     created_at=datetime.now(timezone.utc),
...     metadata={"purpose": "quarterly_report_research", "ttl_hours": 72}
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Conversation</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A context for related interactions between agents.</span>

<span class="sd">    Conversations enable shared context accumulation, task grouping,</span>
<span class="sd">    and state isolation between unrelated work.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique conversation identifier (ULID format)</span>
<span class="sd">        participants: List of agent URNs participating in the conversation</span>
<span class="sd">        created_at: Timestamp when the conversation was created (UTC)</span>
<span class="sd">        metadata: Optional metadata (e.g., purpose, TTL, tags)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime, timezone</span>
<span class="sd">        &gt;&gt;&gt; conversation = Conversation(</span>
<span class="sd">        ...     id=&quot;conv_01HX5K3MQVN8...&quot;,</span>
<span class="sd">        ...     participants=[&quot;urn:asap:agent:coordinator&quot;, &quot;urn:asap:agent:research-v1&quot;],</span>
<span class="sd">        ...     created_at=datetime.now(timezone.utc),</span>
<span class="sd">        ...     metadata={&quot;purpose&quot;: &quot;quarterly_report_research&quot;, &quot;ttl_hours&quot;: 72}</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">ConversationID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique conversation identifier (ULID)&quot;</span><span class="p">)</span>
    <span class="n">participants</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AgentURN</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Agent URNs in conversation&quot;</span>
    <span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Creation timestamp (UTC)&quot;</span><span class="p">)</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">CommonMetadata</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional metadata (purpose, TTL, etc.)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.Endpoint" class="doc doc-heading">
            <code>Endpoint</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Network endpoints for agent communication.</p>
<p>Defines the URLs where an agent can be reached for different
types of communication.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Endpoint.asap">asap</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HTTP endpoint for ASAP protocol messages (required)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Endpoint.events">events</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional WebSocket endpoint for streaming events</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>endpoint = Endpoint(
...     asap="https://api.example.com/asap",
...     events="wss://api.example.com/asap/events"
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Endpoint</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Network endpoints for agent communication.</span>

<span class="sd">    Defines the URLs where an agent can be reached for different</span>
<span class="sd">    types of communication.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        asap: HTTP endpoint for ASAP protocol messages (required)</span>
<span class="sd">        events: Optional WebSocket endpoint for streaming events</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; endpoint = Endpoint(</span>
<span class="sd">        ...     asap=&quot;https://api.example.com/asap&quot;,</span>
<span class="sd">        ...     events=&quot;wss://api.example.com/asap/events&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">asap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;HTTP endpoint for ASAP messages&quot;</span><span class="p">)</span>
    <span class="n">events</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;WebSocket endpoint for streaming events&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.Manifest" class="doc doc-heading">
            <code>Manifest</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Self-describing metadata about an agent's capabilities.</p>
<p>The manifest is analogous to A2A's Agent Card but extended with
additional ASAP-specific features. It provides all information
needed to interact with an agent.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Manifest.id">id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AgentURN = str

  
      module-attribute
   (asap.models.types.AgentURN)" href="#asap.models.types.AgentURN">AgentURN</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique agent identifier (matches Agent.id)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Manifest.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Human-readable agent name</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Manifest.version">version</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SemanticVersion = str

  
      module-attribute
   (asap.models.types.SemanticVersion)" href="#asap.models.types.SemanticVersion">SemanticVersion</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Semantic version of the agent</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Manifest.description">description</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Description of what the agent does</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Manifest.capabilities">capabilities</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Capability (asap.models.entities.Capability)" href="#asap.models.entities.Capability">Capability</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Detailed capability information</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Manifest.endpoints">endpoints</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Endpoint (asap.models.entities.Endpoint)" href="#asap.models.entities.Endpoint">Endpoint</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Network endpoints for communication</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Manifest.auth">auth</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AuthScheme (asap.models.entities.AuthScheme)" href="#asap.models.entities.AuthScheme">AuthScheme</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional authentication configuration</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Manifest.signature">signature</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional cryptographic signature for manifest verification</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Manifest.sla">sla</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SLADefinition (asap.models.entities.SLADefinition)" href="#asap.models.entities.SLADefinition">SLADefinition</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional SLA guarantees (availability, latency, error rate)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Manifest.ttl_seconds">ttl_seconds</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How long to consider agent alive without re-check (default 300)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>manifest = Manifest(
...     id="urn:asap:agent:research-v1",
...     name="Research Agent",
...     version="1.0.0",
...     description="Performs web research and summarization",
...     capabilities=Capability(
...         asap_version="0.1",
...         skills=[Skill(id="web_research", description="Research skill")],
...         state_persistence=True
...     ),
...     endpoints=Endpoint(asap="https://api.example.com/asap")
... )</p>
<h4 id="asap.models.entities.Manifest--with-sla-optional">With SLA (optional):</h4>
<p>manifest_with_sla = Manifest(
...     id="urn:asap:agent:research-v1",
...     name="Research Agent",
...     version="1.0.0",
...     description="Performs web research",
...     capabilities=Capability(
...         asap_version="0.1",
...         skills=[Skill(id="web_research", description="Research skill")],
...         state_persistence=True,
...     ),
...     endpoints=Endpoint(asap="https://api.example.com/asap"),
...     sla=SLADefinition(
...         availability="99.5%",
...         max_latency_p95_ms=500,
...         max_error_rate="1%",
...         support_hours="24/7",
...     ),
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Manifest</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Self-describing metadata about an agent&#39;s capabilities.</span>

<span class="sd">    The manifest is analogous to A2A&#39;s Agent Card but extended with</span>
<span class="sd">    additional ASAP-specific features. It provides all information</span>
<span class="sd">    needed to interact with an agent.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique agent identifier (matches Agent.id)</span>
<span class="sd">        name: Human-readable agent name</span>
<span class="sd">        version: Semantic version of the agent</span>
<span class="sd">        description: Description of what the agent does</span>
<span class="sd">        capabilities: Detailed capability information</span>
<span class="sd">        endpoints: Network endpoints for communication</span>
<span class="sd">        auth: Optional authentication configuration</span>
<span class="sd">        signature: Optional cryptographic signature for manifest verification</span>
<span class="sd">        sla: Optional SLA guarantees (availability, latency, error rate)</span>
<span class="sd">        ttl_seconds: How long to consider agent alive without re-check (default 300)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; manifest = Manifest(</span>
<span class="sd">        ...     id=&quot;urn:asap:agent:research-v1&quot;,</span>
<span class="sd">        ...     name=&quot;Research Agent&quot;,</span>
<span class="sd">        ...     version=&quot;1.0.0&quot;,</span>
<span class="sd">        ...     description=&quot;Performs web research and summarization&quot;,</span>
<span class="sd">        ...     capabilities=Capability(</span>
<span class="sd">        ...         asap_version=&quot;0.1&quot;,</span>
<span class="sd">        ...         skills=[Skill(id=&quot;web_research&quot;, description=&quot;Research skill&quot;)],</span>
<span class="sd">        ...         state_persistence=True</span>
<span class="sd">        ...     ),</span>
<span class="sd">        ...     endpoints=Endpoint(asap=&quot;https://api.example.com/asap&quot;)</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; # With SLA (optional):</span>
<span class="sd">        &gt;&gt;&gt; manifest_with_sla = Manifest(</span>
<span class="sd">        ...     id=&quot;urn:asap:agent:research-v1&quot;,</span>
<span class="sd">        ...     name=&quot;Research Agent&quot;,</span>
<span class="sd">        ...     version=&quot;1.0.0&quot;,</span>
<span class="sd">        ...     description=&quot;Performs web research&quot;,</span>
<span class="sd">        ...     capabilities=Capability(</span>
<span class="sd">        ...         asap_version=&quot;0.1&quot;,</span>
<span class="sd">        ...         skills=[Skill(id=&quot;web_research&quot;, description=&quot;Research skill&quot;)],</span>
<span class="sd">        ...         state_persistence=True,</span>
<span class="sd">        ...     ),</span>
<span class="sd">        ...     endpoints=Endpoint(asap=&quot;https://api.example.com/asap&quot;),</span>
<span class="sd">        ...     sla=SLADefinition(</span>
<span class="sd">        ...         availability=&quot;99.5%&quot;,</span>
<span class="sd">        ...         max_latency_p95_ms=500,</span>
<span class="sd">        ...         max_error_rate=&quot;1%&quot;,</span>
<span class="sd">        ...         support_hours=&quot;24/7&quot;,</span>
<span class="sd">        ...     ),</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">AgentURN</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique agent identifier (URN format)&quot;</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Human-readable agent name&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">SemanticVersion</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Semantic version (e.g., &#39;1.0.0&#39;)&quot;</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;What the agent does&quot;</span><span class="p">)</span>
    <span class="n">capabilities</span><span class="p">:</span> <span class="n">Capability</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Agent capabilities&quot;</span><span class="p">)</span>
    <span class="n">endpoints</span><span class="p">:</span> <span class="n">Endpoint</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Communication endpoints&quot;</span><span class="p">)</span>
    <span class="n">auth</span><span class="p">:</span> <span class="n">AuthScheme</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Authentication configuration&quot;</span><span class="p">)</span>
    <span class="n">signature</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Cryptographic signature for verification&quot;</span>
    <span class="p">)</span>
    <span class="n">sla</span><span class="p">:</span> <span class="n">SLADefinition</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;SLA guarantees (availability, latency, error rate)&quot;</span>
    <span class="p">)</span>
    <span class="n">verification</span><span class="p">:</span> <span class="n">VerificationStatus</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Verification status for marketplace trust badge (Task 3.6)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ttl_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_MANIFEST_TTL_SECONDS</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;How long to consider agent alive without re-check (seconds)&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_urn_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">validate_agent_urn</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_semver</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Version</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InvalidVersion</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid semantic version &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_auth_schemes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Manifest&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_validate_auth_scheme</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.Message" class="doc doc-heading">
            <code>Message</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>A single communication turn containing one or more parts.</p>
<p>Messages are the atomic units of communication within tasks,
containing content parts and metadata about the sender and role.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Message.id">id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="MessageID = str

  
      module-attribute
   (asap.models.types.MessageID)" href="#asap.models.types.MessageID">MessageID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique message identifier (ULID format)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Message.task_id">task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the task this message belongs to</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Message.sender">sender</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AgentURN = str

  
      module-attribute
   (asap.models.types.AgentURN)" href="#asap.models.types.AgentURN">AgentURN</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Agent URN of the message sender</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Message.role">role</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="MessageRole (asap.models.enums.MessageRole)" href="#asap.models.enums.MessageRole">MessageRole</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message role (user, assistant, system)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Message.parts">parts</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="PartID = str

  
      module-attribute
   (asap.models.types.PartID)" href="#asap.models.types.PartID">PartID</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of part IDs or part references</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Message.timestamp">timestamp</span></code></td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When the message was sent (UTC)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from datetime import datetime, timezone
message = Message(
...     id="msg_01HX5K5P...",
...     task_id="task_01HX5K4N...",
...     sender="urn:asap:agent:coordinator",
...     role="user",
...     parts=["part_01HX5K...", "part_01HX5L..."],
...     timestamp=datetime.now(timezone.utc)
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Message</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single communication turn containing one or more parts.</span>

<span class="sd">    Messages are the atomic units of communication within tasks,</span>
<span class="sd">    containing content parts and metadata about the sender and role.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique message identifier (ULID format)</span>
<span class="sd">        task_id: ID of the task this message belongs to</span>
<span class="sd">        sender: Agent URN of the message sender</span>
<span class="sd">        role: Message role (user, assistant, system)</span>
<span class="sd">        parts: List of part IDs or part references</span>
<span class="sd">        timestamp: When the message was sent (UTC)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime, timezone</span>
<span class="sd">        &gt;&gt;&gt; message = Message(</span>
<span class="sd">        ...     id=&quot;msg_01HX5K5P...&quot;,</span>
<span class="sd">        ...     task_id=&quot;task_01HX5K4N...&quot;,</span>
<span class="sd">        ...     sender=&quot;urn:asap:agent:coordinator&quot;,</span>
<span class="sd">        ...     role=&quot;user&quot;,</span>
<span class="sd">        ...     parts=[&quot;part_01HX5K...&quot;, &quot;part_01HX5L...&quot;],</span>
<span class="sd">        ...     timestamp=datetime.now(timezone.utc)</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">MessageID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique message identifier (ULID)&quot;</span><span class="p">)</span>
    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parent task ID&quot;</span><span class="p">)</span>
    <span class="n">sender</span><span class="p">:</span> <span class="n">AgentURN</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sender agent URN&quot;</span><span class="p">)</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">MessageRole</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Message role (user, assistant, system)&quot;</span><span class="p">)</span>
    <span class="n">parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PartID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Part IDs or references&quot;</span><span class="p">)</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Message timestamp (UTC)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.SLADefinition" class="doc doc-heading">
            <code>SLADefinition</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Service level agreement guarantees published by an agent.</p>
<p>SLAs define availability, latency, error rate, and support hours.
Used as trust signals in the marketplace (v2.0) and for breach detection.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.SLADefinition.availability">availability</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target uptime as percentage string (e.g., "99.5%").</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.SLADefinition.max_latency_p95_ms">max_latency_p95_ms</span></code></td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum 95th percentile latency in milliseconds.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.SLADefinition.max_error_rate">max_error_rate</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum acceptable error rate as percentage string (e.g., "1%").</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.SLADefinition.support_hours">support_hours</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Support coverage (e.g., "24/7", "business").</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>sla = SLADefinition(
...     availability="99.5%",
...     max_latency_p95_ms=500,
...     max_error_rate="1%",
...     support_hours="24/7"
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SLADefinition</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Service level agreement guarantees published by an agent.</span>

<span class="sd">    SLAs define availability, latency, error rate, and support hours.</span>
<span class="sd">    Used as trust signals in the marketplace (v2.0) and for breach detection.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        availability: Target uptime as percentage string (e.g., &quot;99.5%&quot;).</span>
<span class="sd">        max_latency_p95_ms: Maximum 95th percentile latency in milliseconds.</span>
<span class="sd">        max_error_rate: Maximum acceptable error rate as percentage string (e.g., &quot;1%&quot;).</span>
<span class="sd">        support_hours: Support coverage (e.g., &quot;24/7&quot;, &quot;business&quot;).</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; sla = SLADefinition(</span>
<span class="sd">        ...     availability=&quot;99.5%&quot;,</span>
<span class="sd">        ...     max_latency_p95_ms=500,</span>
<span class="sd">        ...     max_error_rate=&quot;1%&quot;,</span>
<span class="sd">        ...     support_hours=&quot;24/7&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">availability</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Target uptime as percentage (e.g., &#39;99.5%&#39;)&quot;</span>
    <span class="p">)</span>
    <span class="n">max_latency_p95_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum p95 latency in milliseconds&quot;</span>
    <span class="p">)</span>
    <span class="n">max_error_rate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum error rate as percentage (e.g., &#39;1%&#39;)&quot;</span>
    <span class="p">)</span>
    <span class="n">support_hours</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Support coverage (e.g., &#39;24/7&#39;, &#39;business&#39;)&quot;</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;availability&quot;</span><span class="p">,</span> <span class="s2">&quot;max_error_rate&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_percentage_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">asap.models.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_percentage_format</span>

            <span class="n">validate_percentage_format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.Skill" class="doc doc-heading">
            <code>Skill</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>A specific capability that an agent can perform.</p>
<p>Skills define what an agent can do, along with the expected input
and output schemas for validation.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Skill.id">id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the skill (e.g., "web_research")</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Skill.description">description</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Human-readable description of what the skill does</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Skill.input_schema">input_schema</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional JSON Schema for validating skill inputs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Skill.output_schema">output_schema</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional JSON Schema for validating skill outputs</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>skill = Skill(
...     id="web_research",
...     description="Search and synthesize information from the web",
...     input_schema={"type": "object", "properties": {"query": {"type": "string"}}},
...     output_schema={"type": "object", "properties": {"summary": {"type": "string"}}}
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Skill</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A specific capability that an agent can perform.</span>

<span class="sd">    Skills define what an agent can do, along with the expected input</span>
<span class="sd">    and output schemas for validation.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique identifier for the skill (e.g., &quot;web_research&quot;)</span>
<span class="sd">        description: Human-readable description of what the skill does</span>
<span class="sd">        input_schema: Optional JSON Schema for validating skill inputs</span>
<span class="sd">        output_schema: Optional JSON Schema for validating skill outputs</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; skill = Skill(</span>
<span class="sd">        ...     id=&quot;web_research&quot;,</span>
<span class="sd">        ...     description=&quot;Search and synthesize information from the web&quot;,</span>
<span class="sd">        ...     input_schema={&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: {&quot;query&quot;: {&quot;type&quot;: &quot;string&quot;}}},</span>
<span class="sd">        ...     output_schema={&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: {&quot;summary&quot;: {&quot;type&quot;: &quot;string&quot;}}}</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique skill identifier&quot;</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Human-readable skill description&quot;</span><span class="p">)</span>
    <span class="n">input_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;JSON Schema for skill input validation&quot;</span>
    <span class="p">)</span>
    <span class="n">output_schema</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;JSON Schema for skill output validation&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.StateSnapshot" class="doc doc-heading">
            <code>StateSnapshot</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>First-class state persistence mechanism.</p>
<p>StateSnapshots enable task state to be saved and restored,
addressing a key limitation in other agent protocols. Supports
versioning and checkpoint flagging for important states.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.StateSnapshot.id">id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SnapshotID = str

  
      module-attribute
   (asap.models.types.SnapshotID)" href="#asap.models.types.SnapshotID">SnapshotID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique snapshot identifier (ULID format)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.StateSnapshot.task_id">task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the task this snapshot belongs to</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.StateSnapshot.version">version</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Snapshot version number (auto-incremented)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.StateSnapshot.data">data</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arbitrary state data (JSON-serializable dict)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.StateSnapshot.checkpoint">checkpoint</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether this is a significant checkpoint (default: False)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.StateSnapshot.created_at">created_at</span></code></td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When the snapshot was created (UTC)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from datetime import datetime, timezone
snapshot = StateSnapshot(
...     id="snap_01HX5K7R...",
...     task_id="task_01HX5K4N...",
...     version=3,
...     data={"search_completed": True, "sources_analyzed": 15},
...     checkpoint=True,
...     created_at=datetime.now(timezone.utc)
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StateSnapshot</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;First-class state persistence mechanism.</span>

<span class="sd">    StateSnapshots enable task state to be saved and restored,</span>
<span class="sd">    addressing a key limitation in other agent protocols. Supports</span>
<span class="sd">    versioning and checkpoint flagging for important states.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique snapshot identifier (ULID format)</span>
<span class="sd">        task_id: ID of the task this snapshot belongs to</span>
<span class="sd">        version: Snapshot version number (auto-incremented)</span>
<span class="sd">        data: Arbitrary state data (JSON-serializable dict)</span>
<span class="sd">        checkpoint: Whether this is a significant checkpoint (default: False)</span>
<span class="sd">        created_at: When the snapshot was created (UTC)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime, timezone</span>
<span class="sd">        &gt;&gt;&gt; snapshot = StateSnapshot(</span>
<span class="sd">        ...     id=&quot;snap_01HX5K7R...&quot;,</span>
<span class="sd">        ...     task_id=&quot;task_01HX5K4N...&quot;,</span>
<span class="sd">        ...     version=3,</span>
<span class="sd">        ...     data={&quot;search_completed&quot;: True, &quot;sources_analyzed&quot;: 15},</span>
<span class="sd">        ...     checkpoint=True,</span>
<span class="sd">        ...     created_at=datetime.now(timezone.utc)</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">SnapshotID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique snapshot identifier (ULID)&quot;</span><span class="p">)</span>
    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parent task ID&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Snapshot version number&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;State data (JSON-serializable)&quot;</span><span class="p">)</span>
    <span class="n">checkpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether this is a significant checkpoint&quot;</span><span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Creation timestamp (UTC)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.Task" class="doc doc-heading">
            <code>Task</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>The fundamental unit of work in ASAP.</p>
<p>Tasks are uniquely identified, stateful with a defined lifecycle,
cancellable, resumable, and capable of producing artifacts.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Task.id">id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique task identifier (ULID format)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Task.conversation_id">conversation_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ConversationID = str

  
      module-attribute
   (asap.models.types.ConversationID)" href="#asap.models.types.ConversationID">ConversationID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the conversation this task belongs to</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Task.parent_task_id">parent_task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional ID of parent task (for subtasks)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Task.status">status</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskStatus (asap.models.enums.TaskStatus)" href="#asap.models.enums.TaskStatus">TaskStatus</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current task status (submitted, working, completed, etc.)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Task.depth">depth</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nesting depth (0 = root); must be â‰¤ MAX_TASK_DEPTH to prevent infinite recursion</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Task.progress">progress</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional progress information (percent, message, ETA)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Task.created_at">created_at</span></code></td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timestamp when the task was created (UTC)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.entities.Task.updated_at">updated_at</span></code></td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timestamp of last status update (UTC)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from datetime import datetime, timezone
task = Task(
...     id="task_01HX5K4N...",
...     conversation_id="conv_01HX5K3MQVN8...",
...     status="working",
...     progress={"percent": 45, "message": "Analyzing search results..."},
...     created_at=datetime.now(timezone.utc),
...     updated_at=datetime.now(timezone.utc)
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The fundamental unit of work in ASAP.</span>

<span class="sd">    Tasks are uniquely identified, stateful with a defined lifecycle,</span>
<span class="sd">    cancellable, resumable, and capable of producing artifacts.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique task identifier (ULID format)</span>
<span class="sd">        conversation_id: ID of the conversation this task belongs to</span>
<span class="sd">        parent_task_id: Optional ID of parent task (for subtasks)</span>
<span class="sd">        status: Current task status (submitted, working, completed, etc.)</span>
<span class="sd">        depth: Nesting depth (0 = root); must be â‰¤ MAX_TASK_DEPTH to prevent infinite recursion</span>
<span class="sd">        progress: Optional progress information (percent, message, ETA)</span>
<span class="sd">        created_at: Timestamp when the task was created (UTC)</span>
<span class="sd">        updated_at: Timestamp of last status update (UTC)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime, timezone</span>
<span class="sd">        &gt;&gt;&gt; task = Task(</span>
<span class="sd">        ...     id=&quot;task_01HX5K4N...&quot;,</span>
<span class="sd">        ...     conversation_id=&quot;conv_01HX5K3MQVN8...&quot;,</span>
<span class="sd">        ...     status=&quot;working&quot;,</span>
<span class="sd">        ...     progress={&quot;percent&quot;: 45, &quot;message&quot;: &quot;Analyzing search results...&quot;},</span>
<span class="sd">        ...     created_at=datetime.now(timezone.utc),</span>
<span class="sd">        ...     updated_at=datetime.now(timezone.utc)</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique task identifier (ULID)&quot;</span><span class="p">)</span>
    <span class="n">conversation_id</span><span class="p">:</span> <span class="n">ConversationID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parent conversation ID&quot;</span><span class="p">)</span>
    <span class="n">parent_task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parent task ID for subtasks&quot;</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">TaskStatus</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Task status (submitted, working, etc.)&quot;</span><span class="p">)</span>
    <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">le</span><span class="o">=</span><span class="n">MAX_TASK_DEPTH</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Nesting depth for subtasks (0 = root); prevents infinite recursion&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Progress info (percent, message, ETA)&quot;</span>
    <span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Creation timestamp (UTC)&quot;</span><span class="p">)</span>
    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Last update timestamp (UTC)&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if task is in a terminal state (completed, failed, or cancelled).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">can_be_cancelled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if task can be cancelled (only submitted or working tasks).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">{</span><span class="n">TaskStatus</span><span class="o">.</span><span class="n">SUBMITTED</span><span class="p">,</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">WORKING</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.models.entities.Task.can_be_cancelled" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">can_be_cancelled</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Check if task can be cancelled (only submitted or working tasks).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/entities.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">can_be_cancelled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if task can be cancelled (only submitted or working tasks).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">{</span><span class="n">TaskStatus</span><span class="o">.</span><span class="n">SUBMITTED</span><span class="p">,</span> <span class="n">TaskStatus</span><span class="o">.</span><span class="n">WORKING</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.models.entities.Task.is_terminal" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_terminal</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Check if task is in a terminal state (completed, failed, or cancelled).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/entities.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if task is in a terminal state (completed, failed, or cancelled).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.entities.VerificationStatus" class="doc doc-heading">
            <code>VerificationStatus</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Verification status for marketplace trust badge (Task 3.6).</p>
<p>When status is 'verified', the agent displays a Verified badge in the
registry UI. Admins add this after manual review of verification requests.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/entities.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VerificationStatus</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verification status for marketplace trust badge (Task 3.6).</span>

<span class="sd">    When status is &#39;verified&#39;, the agent displays a Verified badge in the</span>
<span class="sd">    registry UI. Admins add this after manual review of verification requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">status</span><span class="p">:</span> <span class="n">VerificationState</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Verification state (verified, pending, rejected)&quot;</span>
    <span class="p">)</span>
    <span class="n">verified_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ISO timestamp when verification was granted (None when pending)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="parts">Parts</h3>


<div class="doc doc-object doc-module">



<h2 id="asap.models.parts" class="doc doc-heading">
            <code>asap.models.parts</code>


</h2>

    <div class="doc doc-contents first">

        <p>Part models for ASAP protocol content types.</p>
<p>Parts are atomic content units used within messages and artifacts.
They support different content types including text, structured data,
files, MCP resources, and parameterized templates.</p>










<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="asap.models.parts.Part" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">Part</span> <span class="o">=</span> <span class="n">TypeAdapter</span><span class="p">(</span><span class="n">PartType</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>TypeAdapter for Part discriminated union.</p>
<p>Part is a TypeAdapter that can validate and deserialize any of the five
part types: TextPart, DataPart, FilePart, ResourcePart, or TemplatePart.</p>
<p>The 'type' field is used as a discriminator to automatically deserialize
JSON data into the correct Part subtype.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from asap.models.parts import Part</p>
<h4 id="asap.models.parts.Part--deserializes-to-textpart">Deserializes to TextPart</h4>
<p>text_part = Part.validate_python({"type": "text", "content": "Hello"})</p>
<h4 id="asap.models.parts.Part--deserializes-to-datapart">Deserializes to DataPart</h4>
<p>data_part = Part.validate_python({"type": "data", "data": {"key": "value"}})</p>
<h4 id="asap.models.parts.Part--deserializes-to-filepart">Deserializes to FilePart</h4>
<p>file_part = Part.validate_python({
...     "type": "file",
...     "uri": "https://example.com/doc.pdf",
...     "mime_type": "application/pdf"
... })</p>
</blockquote>
</blockquote>
</blockquote>
</details>
    </div>

</div>



<div class="doc doc-object doc-class">



<h3 id="asap.models.parts.DataPart" class="doc doc-heading">
            <code>DataPart</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Structured JSON data part.</p>
<p>DataPart represents structured data in JSON format, optionally
with a schema URI for validation.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.DataPart.type">type</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;data&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discriminator field, always "data"</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.DataPart.data">data</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arbitrary JSON-serializable data</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.DataPart.schema_uri">schema_uri</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional URI to JSON Schema for validation</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>part = DataPart(
...     type="data",
...     data={"query": "AI trends", "max_results": 10},
...     schema_uri="https://example.com/schemas/search.json"
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/parts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataPart</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Structured JSON data part.</span>

<span class="sd">    DataPart represents structured data in JSON format, optionally</span>
<span class="sd">    with a schema URI for validation.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        type: Discriminator field, always &quot;data&quot;</span>
<span class="sd">        data: Arbitrary JSON-serializable data</span>
<span class="sd">        schema_uri: Optional URI to JSON Schema for validation</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; part = DataPart(</span>
<span class="sd">        ...     type=&quot;data&quot;,</span>
<span class="sd">        ...     data={&quot;query&quot;: &quot;AI trends&quot;, &quot;max_results&quot;: 10},</span>
<span class="sd">        ...     schema_uri=&quot;https://example.com/schemas/search.json&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Part type discriminator&quot;</span><span class="p">)</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Structured data (JSON-serializable)&quot;</span><span class="p">)</span>
    <span class="n">schema_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional JSON Schema URI for validation&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.parts.FilePart" class="doc doc-heading">
            <code>FilePart</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Binary or text file part.</p>
<p>FilePart represents file content, either by reference (URI) or
inline (base64-encoded data). Includes MIME type for proper handling.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.FilePart.type">type</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;file&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discriminator field, always "file"</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.FilePart.uri">uri</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>File URI (asap://, https://, or data:; file:// and path traversal rejected)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.FilePart.mime_type">mime_type</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="MIMEType = str

  
      module-attribute
   (asap.models.types.MIMEType)" href="#asap.models.types.MIMEType">MIMEType</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>MIME type of the file (e.g., "application/pdf")</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.FilePart.inline_data">inline_data</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional base64-encoded inline file data</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>part = FilePart(
...     type="file",
...     uri="asap://artifacts/task_123/report.pdf",
...     mime_type="application/pdf"
... )</p>
<h4 id="asap.models.parts.FilePart--with-inline-data">With inline data</h4>
<p>part_inline = FilePart(
...     type="file",
...     uri="data:text/plain;base64,SGVsbG8gV29ybGQ=",
...     mime_type="text/plain",
...     inline_data="SGVsbG8gV29ybGQ="
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/parts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FilePart</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Binary or text file part.</span>

<span class="sd">    FilePart represents file content, either by reference (URI) or</span>
<span class="sd">    inline (base64-encoded data). Includes MIME type for proper handling.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        type: Discriminator field, always &quot;file&quot;</span>
<span class="sd">        uri: File URI (asap://, https://, or data:; file:// and path traversal rejected)</span>
<span class="sd">        mime_type: MIME type of the file (e.g., &quot;application/pdf&quot;)</span>
<span class="sd">        inline_data: Optional base64-encoded inline file data</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; part = FilePart(</span>
<span class="sd">        ...     type=&quot;file&quot;,</span>
<span class="sd">        ...     uri=&quot;asap://artifacts/task_123/report.pdf&quot;,</span>
<span class="sd">        ...     mime_type=&quot;application/pdf&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # With inline data</span>
<span class="sd">        &gt;&gt;&gt; part_inline = FilePart(</span>
<span class="sd">        ...     type=&quot;file&quot;,</span>
<span class="sd">        ...     uri=&quot;data:text/plain;base64,SGVsbG8gV29ybGQ=&quot;,</span>
<span class="sd">        ...     mime_type=&quot;text/plain&quot;,</span>
<span class="sd">        ...     inline_data=&quot;SGVsbG8gV29ybGQ=&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Part type discriminator&quot;</span><span class="p">)</span>
    <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;File URI (asap://, https://, data:; file:// and .. rejected)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mime_type</span><span class="p">:</span> <span class="n">MIMEType</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;MIME type (e.g., application/pdf)&quot;</span><span class="p">)</span>
    <span class="n">inline_data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional base64-encoded inline file data&quot;</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;uri&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_uri</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate URI: reject path traversal and suspicious file:// URIs.</span>

<span class="sd">        Rejects URIs containing &#39;..&#39; (path traversal) and file:// URIs</span>
<span class="sd">        to prevent reading arbitrary server paths from user-supplied input.</span>

<span class="sd">        Args:</span>
<span class="sd">            v: URI string to validate</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same URI if valid</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If URI contains path traversal or is a file:// URI</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">PATH_TRAVERSAL_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URI must not contain path traversal (..): </span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">FILE_URI_PREFIX</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;file:// URIs are not allowed for security (path traversal risk)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;mime_type&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_mime_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate MIME type format (type/subtype).&quot;&quot;&quot;</span>
        <span class="c1"># Pattern: type/subtype where both parts can contain alphanumeric, dots, plus, and hyphens</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-z0-9-]+/[a-z0-9.+\-]+$&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid MIME type format: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;inline_data&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_base64</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that inline_data is valid base64 when provided.</span>

<span class="sd">        Args:</span>
<span class="sd">            v: Base64 string or None</span>

<span class="sd">        Returns:</span>
<span class="sd">            Base64 string after validation</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If inline_data is not valid base64</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inline_data must be valid base64: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">return</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.models.parts.FilePart.validate_base64" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_base64</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Validate that inline_data is valid base64 when provided.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>v</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base64 string or None</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base64 string after validation</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If inline_data is not valid base64</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/parts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;inline_data&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_base64</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate that inline_data is valid base64 when provided.</span>

<span class="sd">    Args:</span>
<span class="sd">        v: Base64 string or None</span>

<span class="sd">    Returns:</span>
<span class="sd">        Base64 string after validation</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If inline_data is not valid base64</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inline_data must be valid base64: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">return</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.models.parts.FilePart.validate_mime_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_mime_type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Validate MIME type format (type/subtype).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/parts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;mime_type&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_mime_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate MIME type format (type/subtype).&quot;&quot;&quot;</span>
    <span class="c1"># Pattern: type/subtype where both parts can contain alphanumeric, dots, plus, and hyphens</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-z0-9-]+/[a-z0-9.+\-]+$&quot;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid MIME type format: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.models.parts.FilePart.validate_uri" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_uri</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Validate URI: reject path traversal and suspicious file:// URIs.</p>
<p>Rejects URIs containing '..' (path traversal) and file:// URIs
to prevent reading arbitrary server paths from user-supplied input.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>v</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URI string to validate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The same URI if valid</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If URI contains path traversal or is a file:// URI</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/parts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;uri&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_uri</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate URI: reject path traversal and suspicious file:// URIs.</span>

<span class="sd">    Rejects URIs containing &#39;..&#39; (path traversal) and file:// URIs</span>
<span class="sd">    to prevent reading arbitrary server paths from user-supplied input.</span>

<span class="sd">    Args:</span>
<span class="sd">        v: URI string to validate</span>

<span class="sd">    Returns:</span>
<span class="sd">        The same URI if valid</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If URI contains path traversal or is a file:// URI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">PATH_TRAVERSAL_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URI must not contain path traversal (..): </span><span class="si">{</span><span class="n">v</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">FILE_URI_PREFIX</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;file:// URIs are not allowed for security (path traversal risk)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.parts.ResourcePart" class="doc doc-heading">
            <code>ResourcePart</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Reference to an MCP resource.</p>
<p>ResourcePart represents a reference to a resource provided by
an MCP (Model Context Protocol) server, enabling integration
with external tools and data sources.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.ResourcePart.type">type</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;resource&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discriminator field, always "resource"</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.ResourcePart.resource_uri">resource_uri</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URI of the MCP resource</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>part = ResourcePart(
...     type="resource",
...     resource_uri="mcp://tools.example.com/web/search_results"
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/parts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ResourcePart</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reference to an MCP resource.</span>

<span class="sd">    ResourcePart represents a reference to a resource provided by</span>
<span class="sd">    an MCP (Model Context Protocol) server, enabling integration</span>
<span class="sd">    with external tools and data sources.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        type: Discriminator field, always &quot;resource&quot;</span>
<span class="sd">        resource_uri: URI of the MCP resource</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; part = ResourcePart(</span>
<span class="sd">        ...     type=&quot;resource&quot;,</span>
<span class="sd">        ...     resource_uri=&quot;mcp://tools.example.com/web/search_results&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Part type discriminator&quot;</span><span class="p">)</span>
    <span class="n">resource_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;MCP resource URI&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.parts.TemplatePart" class="doc doc-heading">
            <code>TemplatePart</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Parameterized prompt template.</p>
<p>TemplatePart represents a template string with variable placeholders
(using {{variable}} syntax) and their corresponding values.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.TemplatePart.type">type</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;template&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discriminator field, always "template"</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.TemplatePart.template">template</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Template string with {{variable}} placeholders</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.TemplatePart.variables">variables</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping variable names to their values</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>part = TemplatePart(
...     type="template",
...     template="Research {{topic}} for {{timeframe}}",
...     variables={"topic": "AI trends", "timeframe": "Q3 2025"}
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/parts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TemplatePart</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameterized prompt template.</span>

<span class="sd">    TemplatePart represents a template string with variable placeholders</span>
<span class="sd">    (using {{variable}} syntax) and their corresponding values.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        type: Discriminator field, always &quot;template&quot;</span>
<span class="sd">        template: Template string with {{variable}} placeholders</span>
<span class="sd">        variables: Dictionary mapping variable names to their values</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; part = TemplatePart(</span>
<span class="sd">        ...     type=&quot;template&quot;,</span>
<span class="sd">        ...     template=&quot;Research {{topic}} for {{timeframe}}&quot;,</span>
<span class="sd">        ...     variables={&quot;topic&quot;: &quot;AI trends&quot;, &quot;timeframe&quot;: &quot;Q3 2025&quot;}</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Part type discriminator&quot;</span><span class="p">)</span>
    <span class="n">template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Template string with {{variable}} syntax&quot;</span><span class="p">)</span>
    <span class="n">variables</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Variable name to value mapping&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.parts.TextPart" class="doc doc-heading">
            <code>TextPart</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Plain text content part.</p>
<p>TextPart represents simple text content, such as user messages,
agent responses, or any textual information.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.TextPart.type">type</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;text&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Discriminator field, always "text"</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.parts.TextPart.content">content</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The text content</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>part = TextPart(
...     type="text",
...     content="Research Q3 market trends for AI infrastructure"
... )</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/parts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TextPart</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plain text content part.</span>

<span class="sd">    TextPart represents simple text content, such as user messages,</span>
<span class="sd">    agent responses, or any textual information.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        type: Discriminator field, always &quot;text&quot;</span>
<span class="sd">        content: The text content</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; part = TextPart(</span>
<span class="sd">        ...     type=&quot;text&quot;,</span>
<span class="sd">        ...     content=&quot;Research Q3 market trends for AI infrastructure&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Part type discriminator&quot;</span><span class="p">)</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Text content&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="payloads">Payloads</h3>


<div class="doc doc-object doc-module">



<h2 id="asap.models.payloads" class="doc doc-heading">
            <code>asap.models.payloads</code>


</h2>

    <div class="doc doc-contents first">

        <p>Payload models for ASAP protocol messages.</p>
<p>Payloads define the content of protocol messages for different operations
like task requests, responses, updates, state management, and MCP integration.</p>










<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="asap.models.payloads.PayloadType" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">PayloadType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">TaskRequest</span><span class="p">,</span> <span class="n">TaskResponse</span><span class="p">,</span> <span class="n">TaskUpdate</span><span class="p">,</span> <span class="n">TaskCancel</span><span class="p">,</span> <span class="n">MessageSend</span><span class="p">,</span> <span class="n">StateQuery</span><span class="p">,</span> <span class="n">StateRestore</span><span class="p">,</span> <span class="n">ArtifactNotify</span><span class="p">,</span> <span class="n">McpToolCall</span><span class="p">,</span> <span class="n">McpToolResult</span><span class="p">,</span> <span class="n">McpResourceFetch</span><span class="p">,</span> <span class="n">McpResourceData</span><span class="p">,</span> <span class="n">MessageAck</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Union type of all ASAP payload types.</p>
<p>PayloadType represents any of the 13 payload types used in ASAP protocol messages.
The actual payload type discrimination is done via the 'payload_type' field in the
Envelope that wraps these payloads.</p>
<p>Payload types:
- Task operations: TaskRequest, TaskResponse, TaskUpdate, TaskCancel
- Messaging: MessageSend
- State management: StateQuery, StateRestore, ArtifactNotify
- MCP integration: McpToolCall, McpToolResult, McpResourceFetch, McpResourceData
- WebSocket reliability: MessageAck (ADR-16)</p>

    </div>

</div>



<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.ArtifactNotify" class="doc doc-heading">
            <code>ArtifactNotify</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Notify about artifact creation or availability.</p>
<p>ArtifactNotify informs agents when a new artifact has been created
or is available for retrieval.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.ArtifactNotify.artifact_id">artifact_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ArtifactID = str

  
      module-attribute
   (asap.models.types.ArtifactID)" href="#asap.models.types.ArtifactID">ArtifactID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the artifact</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.ArtifactNotify.task_id">task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the task that produced the artifact</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.ArtifactNotify.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional human-readable artifact name</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ArtifactNotify</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Notify about artifact creation or availability.</span>

<span class="sd">    ArtifactNotify informs agents when a new artifact has been created</span>
<span class="sd">    or is available for retrieval.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        artifact_id: ID of the artifact</span>
<span class="sd">        task_id: ID of the task that produced the artifact</span>
<span class="sd">        name: Optional human-readable artifact name</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">artifact_id</span><span class="p">:</span> <span class="n">ArtifactID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Artifact identifier&quot;</span><span class="p">)</span>
    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parent task ID&quot;</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional human-readable artifact name&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.McpResourceData" class="doc doc-heading">
            <code>McpResourceData</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Data from an MCP resource.</p>
<p>McpResourceData provides the content of a fetched MCP resource.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpResourceData.resource_uri">resource_uri</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URI of the resource</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpResourceData.content">content</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Resource content (JSON-serializable)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">McpResourceData</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data from an MCP resource.</span>

<span class="sd">    McpResourceData provides the content of a fetched MCP resource.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        resource_uri: URI of the resource</span>
<span class="sd">        content: Resource content (JSON-serializable)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">resource_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;MCP resource URI&quot;</span><span class="p">)</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Resource content (JSON-serializable)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.McpResourceFetch" class="doc doc-heading">
            <code>McpResourceFetch</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Request to fetch an MCP resource.</p>
<p>McpResourceFetch requests retrieval of a resource from an MCP server,
such as documentation, data, or other content.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpResourceFetch.resource_uri">resource_uri</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URI of the MCP resource to fetch</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">McpResourceFetch</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request to fetch an MCP resource.</span>

<span class="sd">    McpResourceFetch requests retrieval of a resource from an MCP server,</span>
<span class="sd">    such as documentation, data, or other content.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        resource_uri: URI of the MCP resource to fetch</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">resource_uri</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;MCP resource URI to fetch&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.McpToolCall" class="doc doc-heading">
            <code>McpToolCall</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Call an MCP tool.</p>
<p>McpToolCall invokes a tool provided by an MCP server, enabling
agents to leverage external capabilities and integrations.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpToolCall.request_id">request_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for this tool call request</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpToolCall.tool_name">tool_name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the MCP tool to invoke</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpToolCall.arguments">arguments</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arguments to pass to the tool (JSON-serializable)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpToolCall.mcp_context">mcp_context</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional MCP-specific context (server, session, etc.)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">McpToolCall</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Call an MCP tool.</span>

<span class="sd">    McpToolCall invokes a tool provided by an MCP server, enabling</span>
<span class="sd">    agents to leverage external capabilities and integrations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        request_id: Unique identifier for this tool call request</span>
<span class="sd">        tool_name: Name of the MCP tool to invoke</span>
<span class="sd">        arguments: Arguments to pass to the tool (JSON-serializable)</span>
<span class="sd">        mcp_context: Optional MCP-specific context (server, session, etc.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique request identifier&quot;</span><span class="p">)</span>
    <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;MCP tool name to invoke&quot;</span><span class="p">)</span>
    <span class="n">arguments</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Tool arguments (JSON-serializable)&quot;</span><span class="p">)</span>
    <span class="n">mcp_context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional MCP context (server, session, etc.)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.McpToolResult" class="doc doc-heading">
            <code>McpToolResult</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Result of an MCP tool call.</p>
<p>McpToolResult provides the outcome of an MCP tool invocation,
including success status, result data, or error information.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpToolResult.request_id">request_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the original tool call request</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpToolResult.success">success</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the tool call succeeded</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpToolResult.result">result</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional result data (if successful)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.McpToolResult.error">error</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional error message (if failed)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">McpToolResult</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Result of an MCP tool call.</span>

<span class="sd">    McpToolResult provides the outcome of an MCP tool invocation,</span>
<span class="sd">    including success status, result data, or error information.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        request_id: ID of the original tool call request</span>
<span class="sd">        success: Whether the tool call succeeded</span>
<span class="sd">        result: Optional result data (if successful)</span>
<span class="sd">        error: Optional error message (if failed)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Original request identifier&quot;</span><span class="p">)</span>
    <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether tool call succeeded&quot;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Result data (if successful)&quot;</span><span class="p">)</span>
    <span class="n">error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Error message (if failed)&quot;</span><span class="p">)</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_result_error_exclusivity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;McpToolResult&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;result must be provided when success=True&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;error must be None when success=True&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;error must be provided when success=False&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;result must be None when success=False&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.MessageAck" class="doc doc-heading">
            <code>MessageAck</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Application-level ack for WebSocket state-changing messages (ADR-16).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MessageAck</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Application-level ack for WebSocket state-changing messages (ADR-16).&quot;&quot;&quot;</span>

    <span class="n">original_envelope_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Envelope ID being acknowledged&quot;</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;rejected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="n">error</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Reason when rejected&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.MessageSend" class="doc doc-heading">
            <code>MessageSend</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Send a message within a task conversation.</p>
<p>MessageSend exchanges conversation turns between agents during
task execution, containing message content as parts.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.MessageSend.task_id">task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the task this message belongs to</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.MessageSend.message_id">message_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="MessageID = str

  
      module-attribute
   (asap.models.types.MessageID)" href="#asap.models.types.MessageID">MessageID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for this message</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.MessageSend.sender">sender</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AgentURN = str

  
      module-attribute
   (asap.models.types.AgentURN)" href="#asap.models.types.AgentURN">AgentURN</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Agent URN of the message sender</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.MessageSend.role">role</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="MessageRole (asap.models.enums.MessageRole)" href="#asap.models.enums.MessageRole">MessageRole</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message role (user, assistant, system)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.MessageSend.parts">parts</span></code></td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="PartID = str

  
      module-attribute
   (asap.models.types.PartID)" href="#asap.models.types.PartID">PartID</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of part IDs that make up this message</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MessageSend</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Send a message within a task conversation.</span>

<span class="sd">    MessageSend exchanges conversation turns between agents during</span>
<span class="sd">    task execution, containing message content as parts.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        task_id: ID of the task this message belongs to</span>
<span class="sd">        message_id: Unique identifier for this message</span>
<span class="sd">        sender: Agent URN of the message sender</span>
<span class="sd">        role: Message role (user, assistant, system)</span>
<span class="sd">        parts: List of part IDs that make up this message</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parent task ID&quot;</span><span class="p">)</span>
    <span class="n">message_id</span><span class="p">:</span> <span class="n">MessageID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique message identifier&quot;</span><span class="p">)</span>
    <span class="n">sender</span><span class="p">:</span> <span class="n">AgentURN</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sender agent URN&quot;</span><span class="p">)</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">MessageRole</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Message role (user, assistant, system)&quot;</span><span class="p">)</span>
    <span class="n">parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">PartID</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Part IDs making up this message&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.StateQuery" class="doc doc-heading">
            <code>StateQuery</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Request a state snapshot for a task.</p>
<p>StateQuery requests the current or a specific version of a task's
state snapshot for inspection or restoration.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.StateQuery.task_id">task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the task to query state for</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.StateQuery.version">version</span></code></td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional specific version number to retrieve</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StateQuery</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request a state snapshot for a task.</span>

<span class="sd">    StateQuery requests the current or a specific version of a task&#39;s</span>
<span class="sd">    state snapshot for inspection or restoration.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        task_id: ID of the task to query state for</span>
<span class="sd">        version: Optional specific version number to retrieve</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Task identifier&quot;</span><span class="p">)</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional specific version to retrieve&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.StateRestore" class="doc doc-heading">
            <code>StateRestore</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Restore a task to a previous state snapshot.</p>
<p>StateRestore requests restoration of a task to a previously saved
state snapshot, enabling rollback and recovery scenarios.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.StateRestore.task_id">task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the task to restore</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.StateRestore.snapshot_id">snapshot_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SnapshotID = str

  
      module-attribute
   (asap.models.types.SnapshotID)" href="#asap.models.types.SnapshotID">SnapshotID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the snapshot to restore from</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StateRestore</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Restore a task to a previous state snapshot.</span>

<span class="sd">    StateRestore requests restoration of a task to a previously saved</span>
<span class="sd">    state snapshot, enabling rollback and recovery scenarios.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        task_id: ID of the task to restore</span>
<span class="sd">        snapshot_id: ID of the snapshot to restore from</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Task identifier&quot;</span><span class="p">)</span>
    <span class="n">snapshot_id</span><span class="p">:</span> <span class="n">SnapshotID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Snapshot ID to restore from&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.TaskCancel" class="doc doc-heading">
            <code>TaskCancel</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Request to cancel a running task.</p>
<p>TaskCancel requests cancellation of a task that is currently executing.
The agent should attempt graceful cancellation and cleanup.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskCancel.task_id">task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the task to cancel</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskCancel.reason">reason</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional reason for cancellation</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TaskCancel</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request to cancel a running task.</span>

<span class="sd">    TaskCancel requests cancellation of a task that is currently executing.</span>
<span class="sd">    The agent should attempt graceful cancellation and cleanup.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        task_id: ID of the task to cancel</span>
<span class="sd">        reason: Optional reason for cancellation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Task identifier to cancel&quot;</span><span class="p">)</span>
    <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional cancellation reason&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.TaskMetrics" class="doc doc-heading">
            <code>TaskMetrics</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>TaskResponse.metrics (extra allowed).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TaskMetrics</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TaskResponse.metrics (extra allowed).&quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;allow&quot;</span><span class="p">)</span>

    <span class="n">duration_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Execution duration in milliseconds&quot;</span>
    <span class="p">)</span>
    <span class="n">tokens_in</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Input token count&quot;</span><span class="p">)</span>
    <span class="n">tokens_out</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Output token count&quot;</span><span class="p">)</span>
    <span class="n">tokens_used</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Total tokens (fallback for tokens_out)&quot;</span>
    <span class="p">)</span>
    <span class="n">api_calls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of API calls&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.TaskRequest" class="doc doc-heading">
            <code>TaskRequest</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Request to execute a task on an agent.</p>
<p>TaskRequest initiates task execution, specifying the skill to invoke,
input data, and optional configuration parameters.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskRequest.conversation_id">conversation_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ConversationID = str

  
      module-attribute
   (asap.models.types.ConversationID)" href="#asap.models.types.ConversationID">ConversationID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the conversation this task belongs to</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskRequest.parent_task_id">parent_task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional ID of parent task (for subtasks)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskRequest.skill_id">skill_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Identifier of the skill to execute</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskRequest.input">input</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data for the skill (JSON-serializable)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskRequest.config">config</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskRequestConfig (asap.models.payloads.TaskRequestConfig)" href="#asap.models.payloads.TaskRequestConfig">TaskRequestConfig</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional configuration (timeout, priority, streaming, etc.)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TaskRequest</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request to execute a task on an agent.</span>

<span class="sd">    TaskRequest initiates task execution, specifying the skill to invoke,</span>
<span class="sd">    input data, and optional configuration parameters.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        conversation_id: ID of the conversation this task belongs to</span>
<span class="sd">        parent_task_id: Optional ID of parent task (for subtasks)</span>
<span class="sd">        skill_id: Identifier of the skill to execute</span>
<span class="sd">        input: Input data for the skill (JSON-serializable)</span>
<span class="sd">        config: Optional configuration (timeout, priority, streaming, etc.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">conversation_id</span><span class="p">:</span> <span class="n">ConversationID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parent conversation ID&quot;</span><span class="p">)</span>
    <span class="n">parent_task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Parent task ID for subtasks&quot;</span><span class="p">)</span>
    <span class="n">skill_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Skill identifier to execute&quot;</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Input data for the skill (skill-specific)&quot;</span><span class="p">)</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">TaskRequestConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional configuration (timeout, priority, streaming, etc.)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.TaskRequestConfig" class="doc doc-heading">
            <code>TaskRequestConfig</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>TaskRequest.config (extra allowed).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TaskRequestConfig</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;TaskRequest.config (extra allowed).&quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;allow&quot;</span><span class="p">)</span>

    <span class="n">timeout_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum execution time in seconds&quot;</span>
    <span class="p">)</span>
    <span class="n">priority</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Task priority (e.g., &#39;low&#39;, &#39;normal&#39;, &#39;high&#39;)&quot;</span>
    <span class="p">)</span>
    <span class="n">idempotency_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Key for idempotent execution&quot;</span><span class="p">)</span>
    <span class="n">streaming</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether to stream progress updates&quot;</span><span class="p">)</span>
    <span class="n">persist_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether to persist state snapshots&quot;</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;LLM model identifier&quot;</span><span class="p">)</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;LLM temperature (0-2)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.TaskResponse" class="doc doc-heading">
            <code>TaskResponse</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Response to a task execution request.</p>
<p>TaskResponse provides the final result of task execution, including
status, result data, final state snapshot, and execution metrics.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskResponse.task_id">task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the completed task</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskResponse.status">status</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskStatus (asap.models.enums.TaskStatus)" href="#asap.models.enums.TaskStatus">TaskStatus</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Final task status (completed, failed, cancelled, etc.)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskResponse.result">result</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional result data (summary, artifacts, etc.)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskResponse.final_state">final_state</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional final state snapshot</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskResponse.metrics">metrics</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskMetrics (asap.models.payloads.TaskMetrics)" href="#asap.models.payloads.TaskMetrics">TaskMetrics</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional execution metrics (duration, tokens used, etc.)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TaskResponse</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Response to a task execution request.</span>

<span class="sd">    TaskResponse provides the final result of task execution, including</span>
<span class="sd">    status, result data, final state snapshot, and execution metrics.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        task_id: ID of the completed task</span>
<span class="sd">        status: Final task status (completed, failed, cancelled, etc.)</span>
<span class="sd">        result: Optional result data (summary, artifacts, etc.)</span>
<span class="sd">        final_state: Optional final state snapshot</span>
<span class="sd">        metrics: Optional execution metrics (duration, tokens used, etc.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Task identifier&quot;</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">TaskStatus</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Final task status&quot;</span><span class="p">)</span>
    <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Result data (summary, artifacts, etc.)&quot;</span>
    <span class="p">)</span>
    <span class="n">final_state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Final state snapshot&quot;</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">TaskMetrics</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Execution metrics (duration, tokens, etc.)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.models.payloads.TaskUpdate" class="doc doc-heading">
            <code>TaskUpdate</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Update on task execution progress or status.</p>
<p>TaskUpdate provides real-time updates during task execution, including
progress information or requests for additional input.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskUpdate.task_id">task_id</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the task being updated</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskUpdate.update_type">update_type</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="UpdateType (asap.models.enums.UpdateType)" href="#asap.models.enums.UpdateType">UpdateType</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of update (progress, input_required, etc.)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskUpdate.status">status</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskStatus (asap.models.enums.TaskStatus)" href="#asap.models.enums.TaskStatus">TaskStatus</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current task status</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskUpdate.progress">progress</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional progress information (percent, message, ETA)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.payloads.TaskUpdate.input_request">input_request</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional request for additional input from user</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/payloads.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TaskUpdate</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update on task execution progress or status.</span>

<span class="sd">    TaskUpdate provides real-time updates during task execution, including</span>
<span class="sd">    progress information or requests for additional input.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        task_id: ID of the task being updated</span>
<span class="sd">        update_type: Type of update (progress, input_required, etc.)</span>
<span class="sd">        status: Current task status</span>
<span class="sd">        progress: Optional progress information (percent, message, ETA)</span>
<span class="sd">        input_request: Optional request for additional input from user</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Task identifier&quot;</span><span class="p">)</span>
    <span class="n">update_type</span><span class="p">:</span> <span class="n">UpdateType</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Update type (progress, input_required)&quot;</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">TaskStatus</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Current task status&quot;</span><span class="p">)</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Progress info (percent, message, ETA)&quot;</span>
    <span class="p">)</span>
    <span class="n">input_request</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Request for additional input&quot;</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;progress&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_progress_percent</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">and</span> <span class="s2">&quot;percent&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;progress.percent must be a number&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">percent</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;progress.percent must be between 0 and 100&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="envelope">Envelope</h3>


<div class="doc doc-object doc-module">



<h2 id="asap.models.envelope" class="doc doc-heading">
            <code>asap.models.envelope</code>


</h2>

    <div class="doc doc-contents first">

        <p>Envelope model for ASAP protocol messages.</p>
<p>The Envelope wraps all ASAP protocol messages, providing metadata for
routing, correlation, tracing, and versioning.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="asap.models.envelope.Envelope" class="doc doc-heading">
            <code>Envelope</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>ASAP protocol message envelope.</p>
<p>Envelope wraps all protocol messages with metadata for routing,
correlation, tracing, and versioning. Auto-generates id and timestamp
if not provided.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.envelope.Envelope.id">id</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique envelope identifier (auto-generated if not provided)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.envelope.Envelope.asap_version">asap_version</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ASAP protocol version (e.g., "0.1")</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.envelope.Envelope.timestamp">timestamp</span></code></td>
            <td>
                  <code><span title="datetime.datetime">datetime</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Message timestamp in UTC (auto-generated if not provided)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.envelope.Envelope.sender">sender</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AgentURN = str

  
      module-attribute
   (asap.models.types.AgentURN)" href="#asap.models.types.AgentURN">AgentURN</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sender agent URN</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.envelope.Envelope.recipient">recipient</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="AgentURN = str

  
      module-attribute
   (asap.models.types.AgentURN)" href="#asap.models.types.AgentURN">AgentURN</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Recipient agent URN</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.envelope.Envelope.payload_type">payload_type</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of payload (TaskRequest, TaskResponse, etc.)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.envelope.Envelope.payload">payload</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="PayloadType = Union[TaskRequest, TaskResponse, TaskUpdate, TaskCancel, MessageSend, StateQuery, StateRestore, ArtifactNotify, McpToolCall, McpToolResult, McpResourceFetch, McpResourceData, MessageAck]

  
      module-attribute
   (asap.models.payloads.PayloadType)" href="#asap.models.payloads.PayloadType">PayloadType</a> | <span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Actual message payload</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.envelope.Envelope.correlation_id">correlation_id</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional ID for correlating request/response pairs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.envelope.Envelope.trace_id">trace_id</span></code></td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional ID for distributed tracing</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.models.envelope.Envelope.extensions">extensions</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional custom extensions</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from datetime import datetime, timezone
envelope = Envelope(
...     asap_version="0.1",
...     sender="urn:asap:agent:coordinator",
...     recipient="urn:asap:agent:research-v1",
...     payload_type="TaskRequest",
...     payload={"conversation_id": "conv_123", "skill_id": "research", "input": {}}
... )</p>
<h4 id="asap.models.envelope.Envelope--id-and-timestamp-are-auto-generated">id and timestamp are auto-generated</h4>
<p>assert envelope.id is not None
assert envelope.timestamp is not None</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/envelope.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Envelope</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ASAP protocol message envelope.</span>

<span class="sd">    Envelope wraps all protocol messages with metadata for routing,</span>
<span class="sd">    correlation, tracing, and versioning. Auto-generates id and timestamp</span>
<span class="sd">    if not provided.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique envelope identifier (auto-generated if not provided)</span>
<span class="sd">        asap_version: ASAP protocol version (e.g., &quot;0.1&quot;)</span>
<span class="sd">        timestamp: Message timestamp in UTC (auto-generated if not provided)</span>
<span class="sd">        sender: Sender agent URN</span>
<span class="sd">        recipient: Recipient agent URN</span>
<span class="sd">        payload_type: Type of payload (TaskRequest, TaskResponse, etc.)</span>
<span class="sd">        payload: Actual message payload</span>
<span class="sd">        correlation_id: Optional ID for correlating request/response pairs</span>
<span class="sd">        trace_id: Optional ID for distributed tracing</span>
<span class="sd">        extensions: Optional custom extensions</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime, timezone</span>
<span class="sd">        &gt;&gt;&gt; envelope = Envelope(</span>
<span class="sd">        ...     asap_version=&quot;0.1&quot;,</span>
<span class="sd">        ...     sender=&quot;urn:asap:agent:coordinator&quot;,</span>
<span class="sd">        ...     recipient=&quot;urn:asap:agent:research-v1&quot;,</span>
<span class="sd">        ...     payload_type=&quot;TaskRequest&quot;,</span>
<span class="sd">        ...     payload={&quot;conversation_id&quot;: &quot;conv_123&quot;, &quot;skill_id&quot;: &quot;research&quot;, &quot;input&quot;: {}}</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; # id and timestamp are auto-generated</span>
<span class="sd">        &gt;&gt;&gt; assert envelope.id is not None</span>
<span class="sd">        &gt;&gt;&gt; assert envelope.timestamp is not None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Unique envelope identifier (ULID, auto-generated)&quot;</span>
    <span class="p">)</span>
    <span class="n">asap_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;ASAP protocol version&quot;</span><span class="p">)</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Message timestamp (UTC, auto-generated)&quot;</span>
    <span class="p">)</span>
    <span class="n">sender</span><span class="p">:</span> <span class="n">AgentURN</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sender agent URN&quot;</span><span class="p">)</span>
    <span class="n">recipient</span><span class="p">:</span> <span class="n">AgentURN</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Recipient agent URN&quot;</span><span class="p">)</span>
    <span class="n">payload_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Payload type discriminator&quot;</span><span class="p">)</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">PayloadType</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Message payload (typed when payload_type known, else dict)&quot;</span>
    <span class="p">)</span>
    <span class="n">correlation_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional correlation ID for request/response pairing&quot;</span>
    <span class="p">)</span>
    <span class="n">trace_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional trace ID for distributed tracing&quot;</span>
    <span class="p">)</span>
    <span class="n">requires_ack</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;When True, receiver must send a MessageAck for this envelope (WebSocket). &quot;</span>
            <span class="s2">&quot;Over WebSocket, auto-set for state-changing payloads: TaskRequest, &quot;</span>
            <span class="s2">&quot;TaskCancel, StateRestore, MessageSend. HTTP transport uses response as implicit ack.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">extensions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Optional custom extensions. &quot;</span>
            <span class="s2">&quot;Can include a &#39;nonce&#39; field (string) for replay attack prevention. &quot;</span>
            <span class="s2">&quot;If provided, the nonce must be unique within the TTL window (typically 10 minutes). &quot;</span>
            <span class="s2">&quot;Duplicate nonces will be rejected by the validation layer.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_id_if_missing</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-generate ID if not provided.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">generate_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_timestamp_if_missing</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-generate timestamp if not provided.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;sender&quot;</span><span class="p">,</span> <span class="s2">&quot;recipient&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_sender_recipient_urn</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate sender/recipient URN format and length.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">validate_agent_urn</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_payload_from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload&quot;</span><span class="p">)</span>
        <span class="n">payload_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;payload_type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">payload_type</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;payload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_parse_payload</span><span class="p">(</span><span class="n">payload_type</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_response_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Envelope&quot;</span><span class="p">:</span>
        <span class="n">response_type_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;taskresponse&quot;</span><span class="p">,</span> <span class="s2">&quot;mcptoolresult&quot;</span><span class="p">,</span> <span class="s2">&quot;mcpresourcedata&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">_normalize_payload_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">payload_type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">response_type_keys</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_id</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">payload_type</span><span class="si">}</span><span class="s2"> must have correlation_id for request tracking&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">payload_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">ASAPBaseModel</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.models.envelope.Envelope.generate_id_if_missing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_id_if_missing</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Auto-generate ID if not provided.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/envelope.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_id_if_missing</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Auto-generate ID if not provided.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generate_id</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.models.envelope.Envelope.generate_timestamp_if_missing" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_timestamp_if_missing</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Auto-generate timestamp if not provided.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/envelope.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_timestamp_if_missing</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Auto-generate timestamp if not provided.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.models.envelope.Envelope.validate_sender_recipient_urn" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_sender_recipient_urn</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Validate sender/recipient URN format and length.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/envelope.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;sender&quot;</span><span class="p">,</span> <span class="s2">&quot;recipient&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_sender_recipient_urn</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate sender/recipient URN format and length.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">validate_agent_urn</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="state">State</h2>


<div class="doc doc-object doc-module">



<h2 id="asap.state" class="doc doc-heading">
            <code>asap.state</code>


</h2>

    <div class="doc doc-contents first">

        <p>ASAP State Management Module.</p>
<p>This module provides state machine functionality for managing
task lifecycles and state transitions in the ASAP protocol.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from asap.models.enums import TaskStatus
can_transition(TaskStatus.SUBMITTED, TaskStatus.WORKING)
True</p>
</blockquote>
</blockquote>
</blockquote>
</details>









<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="asap.state.InMemoryMeteringStore" class="doc doc-heading">
            <code>InMemoryMeteringStore</code>


</h3>


    <div class="doc doc-contents ">



        <p>In-memory implementation of MeteringStore.</p>
<p>Stores usage events in a list with asyncio.Lock for async-safe concurrent access.
Used for testing and development; not persistent across restarts.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/state/metering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InMemoryMeteringStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;In-memory implementation of MeteringStore.</span>

<span class="sd">    Stores usage events in a list with asyncio.Lock for async-safe concurrent access.</span>
<span class="sd">    Used for testing and development; not persistent across restarts.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the in-memory metering store.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UsageEvent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">UsageEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append a usage event to the store (async-safe).&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">UsageEvent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return events for the agent in [start, end], sorted by timestamp.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;offset must be non-negative&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">agent_id</span> <span class="o">==</span> <span class="n">agent_id</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&lt;=</span> <span class="n">end</span>
            <span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UsageAggregate</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate all stored events for the agent into one UsageAggregate.&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">agent_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">agent_id</span> <span class="o">==</span> <span class="n">agent_id</span><span class="p">]</span>
        <span class="n">total_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">tokens_in</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">tokens_out</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">agent_events</span><span class="p">)</span>
        <span class="n">total_duration</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">duration_ms</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">agent_events</span><span class="p">)</span>
        <span class="n">total_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent_events</span><span class="p">)</span>
        <span class="n">total_api_calls</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">api_calls</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">agent_events</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">UsageAggregate</span><span class="p">(</span>
            <span class="n">agent_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
            <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
            <span class="n">total_tokens</span><span class="o">=</span><span class="n">total_tokens</span><span class="p">,</span>
            <span class="n">total_duration</span><span class="o">=</span><span class="n">total_duration</span><span class="p">,</span>
            <span class="n">total_tasks</span><span class="o">=</span><span class="n">total_tasks</span><span class="p">,</span>
            <span class="n">total_api_calls</span><span class="o">=</span><span class="n">total_api_calls</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.state.InMemoryMeteringStore.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the in-memory metering store.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/metering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the in-memory metering store.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">UsageEvent</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.InMemoryMeteringStore.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate all stored events for the agent into one UsageAggregate.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/metering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UsageAggregate</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate all stored events for the agent into one UsageAggregate.&quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="n">agent_events</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">agent_id</span> <span class="o">==</span> <span class="n">agent_id</span><span class="p">]</span>
    <span class="n">total_tokens</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">tokens_in</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">tokens_out</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">agent_events</span><span class="p">)</span>
    <span class="n">total_duration</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">duration_ms</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">agent_events</span><span class="p">)</span>
    <span class="n">total_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent_events</span><span class="p">)</span>
    <span class="n">total_api_calls</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">api_calls</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">agent_events</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">UsageAggregate</span><span class="p">(</span>
        <span class="n">agent_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
        <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
        <span class="n">total_tokens</span><span class="o">=</span><span class="n">total_tokens</span><span class="p">,</span>
        <span class="n">total_duration</span><span class="o">=</span><span class="n">total_duration</span><span class="p">,</span>
        <span class="n">total_tasks</span><span class="o">=</span><span class="n">total_tasks</span><span class="p">,</span>
        <span class="n">total_api_calls</span><span class="o">=</span><span class="n">total_api_calls</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.InMemoryMeteringStore.query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">query</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Return events for the agent in [start, end], sorted by timestamp.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/metering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">UsageEvent</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return events for the agent in [start, end], sorted by timestamp.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;offset must be non-negative&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">agent_id</span> <span class="o">==</span> <span class="n">agent_id</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&lt;=</span> <span class="n">end</span>
        <span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">out</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.InMemoryMeteringStore.record" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">record</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Append a usage event to the store (async-safe).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/metering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">UsageEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Append a usage event to the store (async-safe).&quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.state.InMemorySnapshotStore" class="doc doc-heading">
            <code>InMemorySnapshotStore</code>


</h3>


    <div class="doc doc-contents ">



        <p>In-memory implementation of SnapshotStore.</p>
<p>Stores snapshots in memory using dictionaries. Useful for testing
and simple applications that don't require persistence across restarts.</p>
<p>This implementation is thread-safe using RLock for concurrent access.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/state/stores/memory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">InMemorySnapshotStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;In-memory implementation of SnapshotStore.</span>

<span class="sd">    Stores snapshots in memory using dictionaries. Useful for testing</span>
<span class="sd">    and simple applications that don&#39;t require persistence across restarts.</span>

<span class="sd">    This implementation is thread-safe using RLock for concurrent access.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the in-memory snapshot store.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">TaskID</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">StateSnapshot</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">TaskID</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">:</span> <span class="n">StateSnapshot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a snapshot to the in-memory store.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">task_id</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">task_id</span>
            <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">][</span><span class="n">snapshot</span><span class="o">.</span><span class="n">version</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">version</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateSnapshot</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a snapshot from the in-memory store.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">latest_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">latest_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">latest_version</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all available versions for a task.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete snapshot(s) for a task.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">version</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">][</span><span class="n">version</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">version</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.state.InMemorySnapshotStore.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the in-memory snapshot store.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the in-memory snapshot store.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">TaskID</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">StateSnapshot</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">TaskID</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.InMemorySnapshotStore.delete" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Delete snapshot(s) for a task.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete snapshot(s) for a task.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">version</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">][</span><span class="n">version</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">version</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.InMemorySnapshotStore.get" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Retrieve a snapshot from the in-memory store.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateSnapshot</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve a snapshot from the in-memory store.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">latest_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">latest_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">latest_version</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.InMemorySnapshotStore.list_versions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_versions</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>List all available versions for a task.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all available versions for a task.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.InMemorySnapshotStore.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save a snapshot to the in-memory store.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/memory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">:</span> <span class="n">StateSnapshot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a snapshot to the in-memory store.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">task_id</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_snapshots</span><span class="p">[</span><span class="n">task_id</span><span class="p">][</span><span class="n">snapshot</span><span class="o">.</span><span class="n">version</span><span class="p">]</span> <span class="o">=</span> <span class="n">snapshot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_latest_versions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">version</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.state.MeteringStore" class="doc doc-heading">
            <code>MeteringStore</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>



        <p>Protocol for usage metering storage implementations.</p>
<p>Provides the interface for recording and querying usage events and
aggregates. Implementations can use various backends (memory, SQLite, etc.).
Foundation for v1.3 Usage Metering.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>class CustomMeteringStore:
...     async def record(self, event: UsageEvent) -&gt; None: ...
...     async def query(self, agent_id: str, start: datetime, end: datetime) -&gt; list[UsageEvent]: ...
...     async def aggregate(self, agent_id: str, period: str) -&gt; UsageAggregate: ...
isinstance(CustomMeteringStore(), MeteringStore)
True</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/state/metering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@runtime_checkable</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MeteringStore</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol for usage metering storage implementations.</span>

<span class="sd">    Provides the interface for recording and querying usage events and</span>
<span class="sd">    aggregates. Implementations can use various backends (memory, SQLite, etc.).</span>
<span class="sd">    Foundation for v1.3 Usage Metering.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; class CustomMeteringStore:</span>
<span class="sd">        ...     async def record(self, event: UsageEvent) -&gt; None: ...</span>
<span class="sd">        ...     async def query(self, agent_id: str, start: datetime, end: datetime) -&gt; list[UsageEvent]: ...</span>
<span class="sd">        ...     async def aggregate(self, agent_id: str, period: str) -&gt; UsageAggregate: ...</span>
<span class="sd">        &gt;&gt;&gt; isinstance(CustomMeteringStore(), MeteringStore)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s2">&quot;UsageEvent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Awaitable[None]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record a usage event.</span>

<span class="sd">        Args:</span>
<span class="sd">            event: The usage event to store.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; store = InMemoryMeteringStore()</span>
<span class="sd">            &gt;&gt;&gt; event = UsageEvent(task_id=&quot;task_01&quot;, agent_id=&quot;agent_01&quot;, ...)</span>
<span class="sd">            &gt;&gt;&gt; store.record(event)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;UsageEvent&quot;</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query usage events for an agent in a time range.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent_id: Agent identifier.</span>
<span class="sd">            start: Start of the time range (inclusive).</span>
<span class="sd">            end: End of the time range (inclusive).</span>
<span class="sd">            limit: Maximum number of events to return (None = no limit).</span>
<span class="sd">            offset: Number of events to skip (default 0).</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of usage events in the range, ordered by timestamp.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; store = InMemoryMeteringStore()</span>
<span class="sd">            &gt;&gt;&gt; events = store.query(&quot;agent_01&quot;, start, end)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">[</span><span class="s2">&quot;UsageAggregate&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate usage for an agent over a period.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent_id: Agent identifier.</span>
<span class="sd">            period: Aggregation period (e.g. &quot;hour&quot;, &quot;day&quot;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Usage aggregate for the period.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; store = InMemoryMeteringStore()</span>
<span class="sd">            &gt;&gt;&gt; agg = store.aggregate(&quot;agent_01&quot;, &quot;day&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.state.MeteringStore.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate usage for an agent over a period.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>agent_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Agent identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>period</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Aggregation period (e.g. "hour", "day").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.Awaitable">Awaitable</span>[&#39;UsageAggregate&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Usage aggregate for the period.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>store = InMemoryMeteringStore()
agg = store.aggregate("agent_01", "day")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/metering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">[</span><span class="s2">&quot;UsageAggregate&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate usage for an agent over a period.</span>

<span class="sd">    Args:</span>
<span class="sd">        agent_id: Agent identifier.</span>
<span class="sd">        period: Aggregation period (e.g. &quot;hour&quot;, &quot;day&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Usage aggregate for the period.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; store = InMemoryMeteringStore()</span>
<span class="sd">        &gt;&gt;&gt; agg = store.aggregate(&quot;agent_01&quot;, &quot;day&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.MeteringStore.query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">query</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Query usage events for an agent in a time range.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>agent_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Agent identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start</code>
            </td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start of the time range (inclusive).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end</code>
            </td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>End of the time range (inclusive).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of events to return (None = no limit).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>offset</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of events to skip (default 0).</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="collections.abc.Awaitable">Awaitable</span>[<span title="list">list</span>[&#39;UsageEvent&#39;]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of usage events in the range, ordered by timestamp.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>store = InMemoryMeteringStore()
events = store.query("agent_01", start, end)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/metering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Awaitable</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="s2">&quot;UsageEvent&quot;</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query usage events for an agent in a time range.</span>

<span class="sd">    Args:</span>
<span class="sd">        agent_id: Agent identifier.</span>
<span class="sd">        start: Start of the time range (inclusive).</span>
<span class="sd">        end: End of the time range (inclusive).</span>
<span class="sd">        limit: Maximum number of events to return (None = no limit).</span>
<span class="sd">        offset: Number of events to skip (default 0).</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of usage events in the range, ordered by timestamp.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; store = InMemoryMeteringStore()</span>
<span class="sd">        &gt;&gt;&gt; events = store.query(&quot;agent_01&quot;, start, end)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.MeteringStore.record" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">record</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Record a usage event.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>event</code>
            </td>
            <td>
                  <code>&#39;UsageEvent&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The usage event to store.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>store = InMemoryMeteringStore()
event = UsageEvent(task_id="task_01", agent_id="agent_01", ...)
store.record(event)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/metering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s2">&quot;UsageEvent&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Awaitable[None]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Record a usage event.</span>

<span class="sd">    Args:</span>
<span class="sd">        event: The usage event to store.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; store = InMemoryMeteringStore()</span>
<span class="sd">        &gt;&gt;&gt; event = UsageEvent(task_id=&quot;task_01&quot;, agent_id=&quot;agent_01&quot;, ...)</span>
<span class="sd">        &gt;&gt;&gt; store.record(event)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.state.SQLiteMeteringStore" class="doc doc-heading">
            <code>SQLiteMeteringStore</code>


</h3>


    <div class="doc doc-contents ">



        <p>SQLite-backed MeteringStore; usage events persist across restarts.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SQLiteMeteringStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SQLite-backed MeteringStore; usage events persist across restarts.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">DEFAULT_DB_PATH</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Share db_path with SQLiteSnapshotStore for a single DB file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_usage_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">Connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create usage_events table and index if not exists.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE TABLE IF NOT EXISTS </span><span class="si">{</span><span class="n">USAGE_EVENTS_TABLE</span><span class="si">}</span><span class="s2"> (</span>
<span class="s2">                id TEXT PRIMARY KEY,</span>
<span class="s2">                task_id TEXT NOT NULL,</span>
<span class="s2">                agent_id TEXT NOT NULL,</span>
<span class="s2">                consumer_id TEXT NOT NULL,</span>
<span class="s2">                metrics TEXT NOT NULL,</span>
<span class="s2">                timestamp TEXT NOT NULL</span>
<span class="s2">            )</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE INDEX IF NOT EXISTS idx_usage_agent_timestamp</span>
<span class="s2">            ON </span><span class="si">{</span><span class="n">USAGE_EVENTS_TABLE</span><span class="si">}</span><span class="s2"> (agent_id, timestamp)</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_record_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">UsageEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_usage_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="n">event_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;evt_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">_event_to_row</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">event_id</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT INTO </span><span class="si">{</span><span class="n">USAGE_EVENTS_TABLE</span><span class="si">}</span>
<span class="s2">                (id, task_id, agent_id, consumer_id, metrics, timestamp)</span>
<span class="s2">                VALUES (?, ?, ?, ?, ?, ?)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>  <span class="c1"># nosec B608 - table name is module constant, values parameterized</span>
                <span class="n">row</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_query_impl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">UsageEvent</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_usage_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="n">start_s</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">end_s</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT id, task_id, agent_id, consumer_id, metrics, timestamp</span>
<span class="s2">                FROM </span><span class="si">{</span><span class="n">USAGE_EVENTS_TABLE</span><span class="si">}</span>
<span class="s2">                WHERE agent_id = ? AND timestamp &gt;= ? AND timestamp &lt;= ?</span>
<span class="s2">                ORDER BY timestamp</span>
<span class="s2">            &quot;&quot;&quot;</span>  <span class="c1"># nosec B608 - table name is module constant, values parameterized</span>
            <span class="n">params</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">start_s</span><span class="p">,</span> <span class="n">end_s</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; LIMIT ? OFFSET ?&quot;</span>
                <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; LIMIT -1 OFFSET ?&quot;</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">_row_to_event</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UsageAggregate</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_usage_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT</span>
<span class="s2">                    SUM(CAST(json_extract(metrics, &#39;$.tokens_in&#39;) AS INTEGER) + CAST(json_extract(metrics, &#39;$.tokens_out&#39;) AS INTEGER)),</span>
<span class="s2">                    SUM(CAST(json_extract(metrics, &#39;$.duration_ms&#39;) AS INTEGER)),</span>
<span class="s2">                    COUNT(*),</span>
<span class="s2">                    SUM(CAST(json_extract(metrics, &#39;$.api_calls&#39;) AS INTEGER))</span>
<span class="s2">                FROM </span><span class="si">{</span><span class="n">USAGE_EVENTS_TABLE</span><span class="si">}</span>
<span class="s2">                WHERE agent_id = ?</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>  <span class="c1"># nosec B608 - table name is module constant, values parameterized</span>
                <span class="p">(</span><span class="n">agent_id</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">UsageAggregate</span><span class="p">(</span><span class="n">agent_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span>
            <span class="n">total_tokens</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">total_duration</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">total_tasks</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">total_api_calls</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">UsageAggregate</span><span class="p">(</span>
                <span class="n">agent_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
                <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
                <span class="n">total_tokens</span><span class="o">=</span><span class="n">total_tokens</span><span class="p">,</span>
                <span class="n">total_duration</span><span class="o">=</span><span class="n">total_duration</span><span class="p">,</span>
                <span class="n">total_tasks</span><span class="o">=</span><span class="n">total_tasks</span><span class="p">,</span>
                <span class="n">total_api_calls</span><span class="o">=</span><span class="n">total_api_calls</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">UsageEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record a usage event.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_impl</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">UsageEvent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query events in range.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;offset must be non-negative&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_impl</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UsageAggregate</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate usage for agent.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_impl</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create usage_events table if not exists.&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_usage_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteMeteringStore.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db_path</span><span class="o">=</span><span class="n">DEFAULT_DB_PATH</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Share db_path with SQLiteSnapshotStore for a single DB file.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">DEFAULT_DB_PATH</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Share db_path with SQLiteSnapshotStore for a single DB file.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteMeteringStore.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Aggregate usage for agent.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">period</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UsageAggregate</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate usage for agent.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_impl</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">period</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteMeteringStore.initialize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialize</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Create usage_events table if not exists.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create usage_events table if not exists.&quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_usage_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteMeteringStore.query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">query</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Query events in range.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">end</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">UsageEvent</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query events in range.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;offset must be non-negative&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_impl</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteMeteringStore.record" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">record</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Record a usage event.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">UsageEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Record a usage event.&quot;&quot;&quot;</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record_impl</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.state.SQLiteSnapshotStore" class="doc doc-heading">
            <code>SQLiteSnapshotStore</code>


</h3>


    <div class="doc doc-contents ">



        <p>SQLite-backed SnapshotStore; state persists across process restarts.</p>
<p>Uses aiosqlite; sync methods wrap async calls so the store conforms to
the sync SnapshotStore protocol. Call from sync code only (or use
a dedicated thread if you must use from async context).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SQLiteSnapshotStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SQLite-backed SnapshotStore; state persists across process restarts.</span>

<span class="sd">    Uses aiosqlite; sync methods wrap async calls so the store conforms to</span>
<span class="sd">    the sync SnapshotStore protocol. Call from sync code only (or use</span>
<span class="sd">    a dedicated thread if you must use from async context).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">DEFAULT_DB_PATH</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize with database file path.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_snapshots_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">Connection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create snapshots table if not exists.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE TABLE IF NOT EXISTS </span><span class="si">{</span><span class="n">SNAPSHOTS_TABLE</span><span class="si">}</span><span class="s2"> (</span>
<span class="s2">                task_id TEXT NOT NULL,</span>
<span class="s2">                id TEXT NOT NULL,</span>
<span class="s2">                version INTEGER NOT NULL,</span>
<span class="s2">                data TEXT NOT NULL,</span>
<span class="s2">                checkpoint INTEGER NOT NULL,</span>
<span class="s2">                created_at TEXT NOT NULL,</span>
<span class="s2">                PRIMARY KEY (task_id, version)</span>
<span class="s2">            )</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_save_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">:</span> <span class="n">StateSnapshot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_snapshots_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">_snapshot_to_row</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT OR REPLACE INTO </span><span class="si">{</span><span class="n">SNAPSHOTS_TABLE</span><span class="si">}</span>
<span class="s2">                (task_id, id, version, data, checkpoint, created_at)</span>
<span class="s2">                VALUES (?, ?, ?, ?, ?, ?)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">row</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_impl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateSnapshot</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_snapshots_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT task_id, id, version, data, checkpoint, created_at</span>
<span class="s2">                    FROM </span><span class="si">{</span><span class="n">SNAPSHOTS_TABLE</span><span class="si">}</span>
<span class="s2">                    WHERE task_id = ? AND version = ?</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>  <span class="c1"># nosec B608 - table name is module constant, values parameterized</span>
                    <span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT task_id, id, version, data, checkpoint, created_at</span>
<span class="s2">                    FROM </span><span class="si">{</span><span class="n">SNAPSHOTS_TABLE</span><span class="si">}</span>
<span class="s2">                    WHERE task_id = ?</span>
<span class="s2">                    ORDER BY version DESC LIMIT 1</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span>  <span class="c1"># nosec B608 - table name is module constant, values parameterized</span>
                    <span class="p">(</span><span class="n">task_id</span><span class="p">,),</span>
                <span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">_row_to_snapshot</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_list_versions_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_snapshots_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT version FROM </span><span class="si">{</span><span class="n">SNAPSHOTS_TABLE</span><span class="si">}</span>
<span class="s2">                WHERE task_id = ?</span>
<span class="s2">                ORDER BY version</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>  <span class="c1"># nosec B608 - table name is module constant, values parameterized</span>
                <span class="p">(</span><span class="n">task_id</span><span class="p">,),</span>
            <span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_delete_impl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_snapshots_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;DELETE FROM </span><span class="si">{</span><span class="n">SNAPSHOTS_TABLE</span><span class="si">}</span><span class="s2"> WHERE task_id = ? AND version = ?&quot;</span><span class="p">,</span>  <span class="c1"># nosec B608</span>
                    <span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;DELETE FROM </span><span class="si">{</span><span class="n">SNAPSHOTS_TABLE</span><span class="si">}</span><span class="s2"> WHERE task_id = ?&quot;</span><span class="p">,</span>  <span class="c1"># nosec B608</span>
                    <span class="p">(</span><span class="n">task_id</span><span class="p">,),</span>
                <span class="p">)</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span><span class="p">)</span> <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">:</span> <span class="n">StateSnapshot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a snapshot (sync wrapper).&quot;&quot;&quot;</span>
        <span class="n">_run_sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_impl</span><span class="p">(</span><span class="n">snapshot</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateSnapshot</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get snapshot by task_id and optional version (sync wrapper).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">StateSnapshot</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_run_sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_impl</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List versions for task (sync wrapper).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">_run_sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_versions_impl</span><span class="p">(</span><span class="n">task_id</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete snapshot(s) (sync wrapper).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">_run_sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delete_impl</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="p">)))</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create tables if not exists (call from async context if needed).&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_snapshots_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteSnapshotStore.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db_path</span><span class="o">=</span><span class="n">DEFAULT_DB_PATH</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize with database file path.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">DEFAULT_DB_PATH</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize with database file path.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteSnapshotStore.delete" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Delete snapshot(s) (sync wrapper).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete snapshot(s) (sync wrapper).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">_run_sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delete_impl</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteSnapshotStore.get" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get snapshot by task_id and optional version (sync wrapper).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateSnapshot</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get snapshot by task_id and optional version (sync wrapper).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">StateSnapshot</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_run_sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_impl</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteSnapshotStore.initialize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">initialize</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Create tables if not exists (call from async context if needed).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create tables if not exists (call from async context if needed).&quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiosqlite</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_snapshots_table</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteSnapshotStore.list_versions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_versions</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>List versions for task (sync wrapper).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List versions for task (sync wrapper).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">_run_sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_list_versions_impl</span><span class="p">(</span><span class="n">task_id</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SQLiteSnapshotStore.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save a snapshot (sync wrapper).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/sqlite.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">:</span> <span class="n">StateSnapshot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a snapshot (sync wrapper).&quot;&quot;&quot;</span>
    <span class="n">_run_sync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_save_impl</span><span class="p">(</span><span class="n">snapshot</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.state.SnapshotStore" class="doc doc-heading">
            <code>SnapshotStore</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>



        <p>Protocol for snapshot storage implementations.</p>
<p>Provides the interface for storing and retrieving task state snapshots.
Implementations can use various backends (memory, database, file system, etc.).
This uses Protocol for duck typing, allowing any class that implements
these methods to be used as a SnapshotStore.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>class CustomStore:
...     def save(self, snapshot: StateSnapshot) -&gt; None:
...         pass
...     def get(self, task_id: TaskID, version: int | None = None) -&gt; StateSnapshot | None:
...         return None
...     def list_versions(self, task_id: TaskID) -&gt; list[int]:
...         return []
...     def delete(self, task_id: TaskID, version: int | None = None) -&gt; bool:
...         return False
isinstance(CustomStore(), SnapshotStore)
True</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/state/snapshot.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@runtime_checkable</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SnapshotStore</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol for snapshot storage implementations.</span>

<span class="sd">    Provides the interface for storing and retrieving task state snapshots.</span>
<span class="sd">    Implementations can use various backends (memory, database, file system, etc.).</span>
<span class="sd">    This uses Protocol for duck typing, allowing any class that implements</span>
<span class="sd">    these methods to be used as a SnapshotStore.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; class CustomStore:</span>
<span class="sd">        ...     def save(self, snapshot: StateSnapshot) -&gt; None:</span>
<span class="sd">        ...         pass</span>
<span class="sd">        ...     def get(self, task_id: TaskID, version: int | None = None) -&gt; StateSnapshot | None:</span>
<span class="sd">        ...         return None</span>
<span class="sd">        ...     def list_versions(self, task_id: TaskID) -&gt; list[int]:</span>
<span class="sd">        ...         return []</span>
<span class="sd">        ...     def delete(self, task_id: TaskID, version: int | None = None) -&gt; bool:</span>
<span class="sd">        ...         return False</span>
<span class="sd">        &gt;&gt;&gt; isinstance(CustomStore(), SnapshotStore)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">:</span> <span class="n">StateSnapshot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a snapshot to the store.</span>

<span class="sd">        Args:</span>
<span class="sd">            snapshot: The snapshot to save</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; from datetime import datetime, timezone</span>
<span class="sd">            &gt;&gt;&gt; store = InMemorySnapshotStore()</span>
<span class="sd">            &gt;&gt;&gt; snapshot = StateSnapshot(</span>
<span class="sd">            ...     id=&quot;snap_01HX5K7R...&quot;,</span>
<span class="sd">            ...     task_id=&quot;task_01HX5K4N...&quot;,</span>
<span class="sd">            ...     version=1,</span>
<span class="sd">            ...     data={&quot;status&quot;: &quot;submitted&quot;},</span>
<span class="sd">            ...     created_at=datetime.now(timezone.utc),</span>
<span class="sd">            ... )</span>
<span class="sd">            &gt;&gt;&gt; store.save(snapshot)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateSnapshot</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve a snapshot for the given task.</span>

<span class="sd">        Args:</span>
<span class="sd">            task_id: The task ID to retrieve snapshots for</span>
<span class="sd">            version: Optional specific version to retrieve. If None, returns latest.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The snapshot if found, None otherwise</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; store = InMemorySnapshotStore()</span>
<span class="sd">            &gt;&gt;&gt; store.get(&quot;task_01HX5K4N...&quot;)</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all available versions for a task.</span>

<span class="sd">        Args:</span>
<span class="sd">            task_id: The task ID to list versions for</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of version numbers in ascending order</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; store = InMemorySnapshotStore()</span>
<span class="sd">            &gt;&gt;&gt; store.list_versions(&quot;task_01HX5K4N...&quot;)</span>
<span class="sd">            []</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete snapshot(s) for a task.</span>

<span class="sd">        Args:</span>
<span class="sd">            task_id: The task ID</span>
<span class="sd">            version: If provided, delete only this version. Otherwise delete all.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if any snapshots were deleted, False otherwise</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; store = InMemorySnapshotStore()</span>
<span class="sd">            &gt;&gt;&gt; store.delete(&quot;task_01HX5K4N...&quot;)</span>
<span class="sd">            False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.state.SnapshotStore.delete" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Delete snapshot(s) for a task.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>task_id</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The task ID</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If provided, delete only this version. Otherwise delete all.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if any snapshots were deleted, False otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>store = InMemorySnapshotStore()
store.delete("task_01HX5K4N...")
False</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/snapshot.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete snapshot(s) for a task.</span>

<span class="sd">    Args:</span>
<span class="sd">        task_id: The task ID</span>
<span class="sd">        version: If provided, delete only this version. Otherwise delete all.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if any snapshots were deleted, False otherwise</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; store = InMemorySnapshotStore()</span>
<span class="sd">        &gt;&gt;&gt; store.delete(&quot;task_01HX5K4N...&quot;)</span>
<span class="sd">        False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SnapshotStore.get" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Retrieve a snapshot for the given task.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>task_id</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The task ID to retrieve snapshots for</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional specific version to retrieve. If None, returns latest.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="StateSnapshot (asap.models.entities.StateSnapshot)" href="#asap.models.entities.StateSnapshot">StateSnapshot</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The snapshot if found, None otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>store = InMemorySnapshotStore()
store.get("task_01HX5K4N...")
None</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/snapshot.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StateSnapshot</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve a snapshot for the given task.</span>

<span class="sd">    Args:</span>
<span class="sd">        task_id: The task ID to retrieve snapshots for</span>
<span class="sd">        version: Optional specific version to retrieve. If None, returns latest.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The snapshot if found, None otherwise</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; store = InMemorySnapshotStore()</span>
<span class="sd">        &gt;&gt;&gt; store.get(&quot;task_01HX5K4N...&quot;)</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SnapshotStore.list_versions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_versions</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>List all available versions for a task.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>task_id</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskID = str

  
      module-attribute
   (asap.models.types.TaskID)" href="#asap.models.types.TaskID">TaskID</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The task ID to list versions for</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of version numbers in ascending order</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>store = InMemorySnapshotStore()
store.list_versions("task_01HX5K4N...")
[]</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/snapshot.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="n">TaskID</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all available versions for a task.</span>

<span class="sd">    Args:</span>
<span class="sd">        task_id: The task ID to list versions for</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of version numbers in ascending order</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; store = InMemorySnapshotStore()</span>
<span class="sd">        &gt;&gt;&gt; store.list_versions(&quot;task_01HX5K4N...&quot;)</span>
<span class="sd">        []</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.SnapshotStore.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save a snapshot to the store.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>snapshot</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="StateSnapshot (asap.models.entities.StateSnapshot)" href="#asap.models.entities.StateSnapshot">StateSnapshot</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The snapshot to save</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from datetime import datetime, timezone
store = InMemorySnapshotStore()
snapshot = StateSnapshot(
...     id="snap_01HX5K7R...",
...     task_id="task_01HX5K4N...",
...     version=1,
...     data={"status": "submitted"},
...     created_at=datetime.now(timezone.utc),
... )
store.save(snapshot)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/snapshot.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">:</span> <span class="n">StateSnapshot</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a snapshot to the store.</span>

<span class="sd">    Args:</span>
<span class="sd">        snapshot: The snapshot to save</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from datetime import datetime, timezone</span>
<span class="sd">        &gt;&gt;&gt; store = InMemorySnapshotStore()</span>
<span class="sd">        &gt;&gt;&gt; snapshot = StateSnapshot(</span>
<span class="sd">        ...     id=&quot;snap_01HX5K7R...&quot;,</span>
<span class="sd">        ...     task_id=&quot;task_01HX5K4N...&quot;,</span>
<span class="sd">        ...     version=1,</span>
<span class="sd">        ...     data={&quot;status&quot;: &quot;submitted&quot;},</span>
<span class="sd">        ...     created_at=datetime.now(timezone.utc),</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; store.save(snapshot)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.state.TaskStatus" class="doc doc-heading">
            <code>TaskStatus</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Task lifecycle states.</p>
<p>Tasks progress through these states during their lifecycle.
Terminal states are: COMPLETED, FAILED, CANCELLED.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>TaskStatus.COMPLETED.is_terminal()
True
TaskStatus.WORKING.is_terminal()
False</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/models/enums.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TaskStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Task lifecycle states.</span>

<span class="sd">    Tasks progress through these states during their lifecycle.</span>
<span class="sd">    Terminal states are: COMPLETED, FAILED, CANCELLED.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; TaskStatus.COMPLETED.is_terminal()</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; TaskStatus.WORKING.is_terminal()</span>
<span class="sd">        False</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">SUBMITTED</span> <span class="o">=</span> <span class="s2">&quot;submitted&quot;</span>
    <span class="n">WORKING</span> <span class="o">=</span> <span class="s2">&quot;working&quot;</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>
    <span class="n">INPUT_REQUIRED</span> <span class="o">=</span> <span class="s2">&quot;input_required&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">terminal_states</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="s2">&quot;TaskStatus&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all terminal states.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Frozen set containing all terminal task states</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">({</span><span class="bp">cls</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this status represents a terminal state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_states</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.state.TaskStatus.is_terminal" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_terminal</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Check if this status represents a terminal state.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/enums.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if this status represents a terminal state.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_states</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.state.TaskStatus.terminal_states" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">terminal_states</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Return all terminal states.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="frozenset">frozenset</span>[<a class="autorefs autorefs-internal" title="TaskStatus (asap.models.enums.TaskStatus)" href="#asap.models.enums.TaskStatus">TaskStatus</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Frozen set containing all terminal task states</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/models/enums.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">terminal_states</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="s2">&quot;TaskStatus&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return all terminal states.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Frozen set containing all terminal task states</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">frozenset</span><span class="p">({</span><span class="bp">cls</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.state.UsageAggregate" class="doc doc-heading">
            <code>UsageAggregate</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Aggregated usage for an agent over a period.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageAggregate.agent_id">agent_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Agent identifier.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageAggregate.period">period</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Aggregation period (e.g. 'hour', 'day').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageAggregate.total_tokens">total_tokens</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sum of input + output tokens.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageAggregate.total_duration">total_duration</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total duration in milliseconds.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageAggregate.total_tasks">total_tasks</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of tasks.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageAggregate.total_api_calls">total_api_calls</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total API calls.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/state/metering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UsageAggregate</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregated usage for an agent over a period.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        agent_id: Agent identifier.</span>
<span class="sd">        period: Aggregation period (e.g. &#39;hour&#39;, &#39;day&#39;).</span>
<span class="sd">        total_tokens: Sum of input + output tokens.</span>
<span class="sd">        total_duration: Total duration in milliseconds.</span>
<span class="sd">        total_tasks: Number of tasks.</span>
<span class="sd">        total_api_calls: Total API calls.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Agent identifier&quot;</span><span class="p">)</span>
    <span class="n">period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Aggregation period (e.g. hour, day)&quot;</span><span class="p">)</span>
    <span class="n">total_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sum of tokens (in + out)&quot;</span><span class="p">)</span>
    <span class="n">total_duration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Total duration in ms&quot;</span><span class="p">)</span>
    <span class="n">total_tasks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of tasks&quot;</span><span class="p">)</span>
    <span class="n">total_api_calls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Total API calls&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.state.UsageEvent" class="doc doc-heading">
            <code>UsageEvent</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>A single usage event for metering (v1.3 foundation).</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageEvent.task_id">task_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Task identifier.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageEvent.agent_id">agent_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Agent that produced the usage.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageEvent.consumer_id">consumer_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Consumer (caller) identifier.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageEvent.metrics">metrics</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="UsageMetrics (asap.state.metering.UsageMetrics)" href="#asap.state.UsageMetrics">UsageMetrics</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token, duration and API call metrics.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageEvent.timestamp">timestamp</span></code></td>
            <td>
                  <code><span title="datetime.datetime">datetime</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>When the event occurred (UTC).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/state/metering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UsageEvent</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single usage event for metering (v1.3 foundation).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        task_id: Task identifier.</span>
<span class="sd">        agent_id: Agent that produced the usage.</span>
<span class="sd">        consumer_id: Consumer (caller) identifier.</span>
<span class="sd">        metrics: Token, duration and API call metrics.</span>
<span class="sd">        timestamp: When the event occurred (UTC).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Task identifier&quot;</span><span class="p">)</span>
    <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Agent that produced the usage&quot;</span><span class="p">)</span>
    <span class="n">consumer_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Consumer (caller) identifier&quot;</span><span class="p">)</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="n">UsageMetrics</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">UsageMetrics</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Token, duration and API call metrics&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Event timestamp (UTC)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.state.UsageMetrics" class="doc doc-heading">
            <code>UsageMetrics</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>Metrics for a single usage event (tokens, duration, API calls).</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageMetrics.tokens_in">tokens_in</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input token count.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageMetrics.tokens_out">tokens_out</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Output token count.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageMetrics.duration_ms">duration_ms</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Duration in milliseconds.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.state.UsageMetrics.api_calls">api_calls</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of API calls.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/state/metering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UsageMetrics</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Metrics for a single usage event (tokens, duration, API calls).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        tokens_in: Input token count.</span>
<span class="sd">        tokens_out: Output token count.</span>
<span class="sd">        duration_ms: Duration in milliseconds.</span>
<span class="sd">        api_calls: Number of API calls.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tokens_in</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Input token count&quot;</span><span class="p">)</span>
    <span class="n">tokens_out</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Output token count&quot;</span><span class="p">)</span>
    <span class="n">duration_ms</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Duration in milliseconds&quot;</span><span class="p">)</span>
    <span class="n">api_calls</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of API calls&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="asap.state.can_transition" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">can_transition</span><span class="p">(</span><span class="n">from_status</span><span class="p">,</span> <span class="n">to_status</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Check if a transition from one status to another is valid.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>from_status</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskStatus (asap.models.enums.TaskStatus)" href="#asap.models.enums.TaskStatus">TaskStatus</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Current task status</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>to_status</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskStatus (asap.models.enums.TaskStatus)" href="#asap.models.enums.TaskStatus">TaskStatus</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target task status</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if the transition is valid, False otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>can_transition(TaskStatus.SUBMITTED, TaskStatus.WORKING)
True
can_transition(TaskStatus.COMPLETED, TaskStatus.WORKING)
False</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/machine.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">can_transition</span><span class="p">(</span><span class="n">from_status</span><span class="p">:</span> <span class="n">TaskStatus</span><span class="p">,</span> <span class="n">to_status</span><span class="p">:</span> <span class="n">TaskStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a transition from one status to another is valid.</span>

<span class="sd">    Args:</span>
<span class="sd">        from_status: Current task status</span>
<span class="sd">        to_status: Target task status</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the transition is valid, False otherwise</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; can_transition(TaskStatus.SUBMITTED, TaskStatus.WORKING)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; can_transition(TaskStatus.COMPLETED, TaskStatus.WORKING)</span>
<span class="sd">        False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_targets</span> <span class="o">=</span> <span class="n">VALID_TRANSITIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">from_status</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">to_status</span> <span class="ow">in</span> <span class="n">valid_targets</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.state.create_snapshot_store" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_snapshot_store</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a SnapshotStore from environment.</p>
<p>Reads ASAP_STORAGE_BACKEND (default "memory") and ASAP_STORAGE_PATH
(default "asap_state.db" for sqlite). Use "memory" for tests and
"sqlite" for persistent state.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="SnapshotStore (asap.state.snapshot.SnapshotStore)" href="#asap.state.SnapshotStore">SnapshotStore</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configured SnapshotStore instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If ASAP_STORAGE_BACKEND is not "memory" or "sqlite".</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/stores/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_snapshot_store</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SnapshotStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a SnapshotStore from environment.</span>

<span class="sd">    Reads ASAP_STORAGE_BACKEND (default &quot;memory&quot;) and ASAP_STORAGE_PATH</span>
<span class="sd">    (default &quot;asap_state.db&quot; for sqlite). Use &quot;memory&quot; for tests and</span>
<span class="sd">    &quot;sqlite&quot; for persistent state.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Configured SnapshotStore instance.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If ASAP_STORAGE_BACKEND is not &quot;memory&quot; or &quot;sqlite&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ASAP_STORAGE_BACKEND_ENV</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ASAP_STORAGE_PATH_ENV</span><span class="p">,</span> <span class="n">DEFAULT_DB_PATH</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;memory&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">InMemorySnapshotStore</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SQLiteSnapshotStore</span><span class="p">(</span><span class="n">db_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown </span><span class="si">{</span><span class="n">ASAP_STORAGE_BACKEND_ENV</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">backend</span><span class="si">!r}</span><span class="s2">. Use &#39;memory&#39; or &#39;sqlite&#39;.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.state.transition" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">transition</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">new_status</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Transition a task to a new status with validation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>task</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Task (asap.models.entities.Task)" href="#asap.models.entities.Task">Task</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The task to transition</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>new_status</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="TaskStatus (asap.models.enums.TaskStatus)" href="#asap.models.enums.TaskStatus">TaskStatus</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The target status</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Task (asap.models.entities.Task)" href="#asap.models.entities.Task">Task</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New task instance with updated status and updated_at timestamp</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="asap.errors.InvalidTransitionError">InvalidTransitionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the transition is not valid</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>task = Task(
...     id="task_01HX5K4N...",
...     conversation_id="conv_01HX5K3M...",
...     status=TaskStatus.SUBMITTED,
...     created_at=datetime.now(timezone.utc),
...     updated_at=datetime.now(timezone.utc),
... )
updated = transition(task, TaskStatus.WORKING)
updated.status
<TaskStatus.WORKING: 'working'></p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/state/machine.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">transition</span><span class="p">(</span><span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">,</span> <span class="n">new_status</span><span class="p">:</span> <span class="n">TaskStatus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Task</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transition a task to a new status with validation.</span>

<span class="sd">    Args:</span>
<span class="sd">        task: The task to transition</span>
<span class="sd">        new_status: The target status</span>

<span class="sd">    Returns:</span>
<span class="sd">        New task instance with updated status and updated_at timestamp</span>

<span class="sd">    Raises:</span>
<span class="sd">        InvalidTransitionError: If the transition is not valid</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; task = Task(</span>
<span class="sd">        ...     id=&quot;task_01HX5K4N...&quot;,</span>
<span class="sd">        ...     conversation_id=&quot;conv_01HX5K3M...&quot;,</span>
<span class="sd">        ...     status=TaskStatus.SUBMITTED,</span>
<span class="sd">        ...     created_at=datetime.now(timezone.utc),</span>
<span class="sd">        ...     updated_at=datetime.now(timezone.utc),</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; updated = transition(task, TaskStatus.WORKING)</span>
<span class="sd">        &gt;&gt;&gt; updated.status</span>
<span class="sd">        &lt;TaskStatus.WORKING: &#39;working&#39;&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_transition</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">new_status</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">InvalidTransitionError</span><span class="p">(</span>
            <span class="n">from_state</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">to_state</span><span class="o">=</span><span class="n">new_status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="n">state_transition_span_context</span><span class="p">(</span>
        <span class="n">from_status</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">to_status</span><span class="o">=</span><span class="n">new_status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">task_id</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">get_metrics</span><span class="p">()</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span>
            <span class="s2">&quot;asap_state_transitions_total&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;from_status&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;to_status&quot;</span><span class="p">:</span> <span class="n">new_status</span><span class="o">.</span><span class="n">value</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">task</span><span class="o">.</span><span class="n">model_copy</span><span class="p">(</span>
            <span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">new_status</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)}</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="transport">Transport</h2>


<div class="doc doc-object doc-module">



<h2 id="asap.transport" class="doc doc-heading">
            <code>asap.transport</code>


</h2>

    <div class="doc doc-contents first">

        <p>ASAP Protocol HTTP Transport Layer.</p>
<p>This module provides HTTP-based transport for ASAP messages using:
- JSON-RPC 2.0 for request/response wrapping
- FastAPI for server implementation
- httpx for async client implementation
- Handler registry for payload dispatch</p>


<details class="public-exports" open>
  <summary>Public exports</summary>
  <p>JsonRpcRequest: JSON-RPC 2.0 request wrapper
JsonRpcResponse: JSON-RPC 2.0 response wrapper
JsonRpcError: JSON-RPC 2.0 error object
JsonRpcErrorResponse: JSON-RPC 2.0 error response wrapper
create_app: FastAPI application factory
HandlerRegistry: Registry for payload handlers
HandlerNotFoundError: Error for missing handlers
Handler: Type alias for handler functions
create_echo_handler: Factory for echo handler
create_default_registry: Factory for default registry
ASAPClient: Async HTTP client for agent communication
RetryConfig: Configuration dataclass for retry logic and circuit breaker
ASAPConnectionError: Connection error exception
ASAPTimeoutError: Timeout error exception
ASAPRemoteError: Remote error exception</p>
</details>

<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from asap.transport import ASAPClient, create_app
from asap.models.entities import Manifest, Capability, Endpoint, Skill
manifest = Manifest(
...     id="urn:asap:agent:demo",
...     name="Demo Agent",
...     version="1.0.0",
...     description="Demo manifest",
...     capabilities=Capability(
...         asap_version="0.1",
...         skills=[Skill(id="echo", description="Echo")],
...         state_persistence=False,
...     ),
...     endpoints=Endpoint(asap="http://localhost:8000/asap"),
... )
app = create_app(manifest)</p>
</blockquote>
</blockquote>
</blockquote>
</details>









<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="asap.transport.DEFAULT_MAX_RETRIES" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">DEFAULT_MAX_RETRIES</span> <span class="o">=</span> <span class="mi">5</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Maximum number of retry attempts before sending to the DLQ.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.transport.DEFAULT_RETRY_BASE_DELAY" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">DEFAULT_RETRY_BASE_DELAY</span> <span class="o">=</span> <span class="mf">1.0</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Base delay in seconds for exponential backoff (1s â†’ 2s â†’ 4s â†’ 8s â†’ 16s).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.transport.DEFAULT_RETRY_MAX_DELAY" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">DEFAULT_RETRY_MAX_DELAY</span> <span class="o">=</span> <span class="mf">16.0</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Maximum delay cap in seconds for exponential backoff.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="asap.transport.DEFAULT_WEBHOOK_RATE_PER_SECOND" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">DEFAULT_WEBHOOK_RATE_PER_SECOND</span> <span class="o">=</span> <span class="mf">10.0</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Default per-URL webhook delivery rate (token bucket).</p>

    </div>

</div>



<div class="doc doc-object doc-class">



<h3 id="asap.transport.ASAPClient" class="doc doc-heading">
            <code>ASAPClient</code>


</h3>


    <div class="doc doc-contents ">



        <p>Async HTTP client for ASAP protocol communication.</p>
<p>ASAPClient manages HTTP connections to remote ASAP agents and provides
methods for sending envelopes and receiving responses.</p>
<p><strong>Use as async context manager:</strong> Always use <code>async with ASAPClient(...) as client</code>
to ensure the underlying HTTP client is started and closed properly. Using the
client without the context manager may leave connections open.</p>


<details class="features" open>
  <summary>Features</summary>
  <ul>
<li>HTTP/2 multiplexing (enabled by default) for improved batch performance</li>
<li>Connection pooling supporting 1000+ concurrent requests</li>
<li>Automatic retry with exponential backoff</li>
<li>Circuit breaker pattern for fault tolerance</li>
<li>Batch operations via send_batch() method (HTTP only; WebSocket transport
  raises NotImplementedError)</li>
<li>Compression support (gzip/brotli) for bandwidth reduction</li>
</ul>
</details>

<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPClient.base_url">base_url</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base URL of the remote agent</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPClient.timeout">timeout</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request timeout in seconds</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPClient.max_retries">max_retries</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum retry attempts for transient failures</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPClient.require_https">require_https</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether HTTPS is required for non-localhost connections</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="is_connected

  
      property
   (asap.transport.ASAPClient.is_connected)" href="#asap.transport.ASAPClient.is_connected">is_connected</a></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the client has an active connection</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPClient.compression">compression</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether compression is enabled for requests</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPClient.compression_threshold">compression_threshold</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum payload size to trigger compression</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPClient._circuit_breaker">_circuit_breaker</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="asap.transport.circuit_breaker.CircuitBreaker">CircuitBreaker</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional circuit breaker instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Pool sizing (pool_connections / pool_maxsize):
    Single-agent: 100 (default). Small cluster: 200â€“500. Large cluster: 500â€“1000.
    Supports 1000+ concurrent requests via connection reuse when pool_maxsize &lt; concurrency.</p>
<p>HTTP/2 Multiplexing:
    HTTP/2 is enabled by default (http2=True) and provides request multiplexing over
    a single TCP connection, reducing latency for batch operations. If the server
    doesn't support HTTP/2, the client automatically falls back to HTTP/1.1.</p>


<details class="compression" open>
  <summary>Compression</summary>
  <p>Compression is enabled by default (compression=True) for payloads exceeding
1KB. Supports gzip (standard) and brotli (optional, requires brotli package).
Brotli provides ~20% better compression than gzip for JSON payloads.</p>
</details>

<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>async with ASAPClient("http://localhost:8000") as client:
...     response = await client.send(envelope)</p>
<h4 id="asap.transport.ASAPClient--batch-operations-with-http2-multiplexing">Batch operations with HTTP/2 multiplexing</h4>
<p>async with ASAPClient("https://agent.example.com") as client:
...     responses = await client.send_batch([env1, env2, env3])</p>
<h4 id="asap.transport.ASAPClient--disable-compression-for-specific-client">Disable compression for specific client</h4>
<p>async with ASAPClient("http://localhost:8000", compression=False) as client:
...     response = await client.send(envelope)  # No compression</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/client.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ASAPClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Async HTTP client for ASAP protocol communication.</span>

<span class="sd">    ASAPClient manages HTTP connections to remote ASAP agents and provides</span>
<span class="sd">    methods for sending envelopes and receiving responses.</span>

<span class="sd">    **Use as async context manager:** Always use ``async with ASAPClient(...) as client``</span>
<span class="sd">    to ensure the underlying HTTP client is started and closed properly. Using the</span>
<span class="sd">    client without the context manager may leave connections open.</span>

<span class="sd">    Features:</span>
<span class="sd">        - HTTP/2 multiplexing (enabled by default) for improved batch performance</span>
<span class="sd">        - Connection pooling supporting 1000+ concurrent requests</span>
<span class="sd">        - Automatic retry with exponential backoff</span>
<span class="sd">        - Circuit breaker pattern for fault tolerance</span>
<span class="sd">        - Batch operations via send_batch() method (HTTP only; WebSocket transport</span>
<span class="sd">          raises NotImplementedError)</span>
<span class="sd">        - Compression support (gzip/brotli) for bandwidth reduction</span>

<span class="sd">    Attributes:</span>
<span class="sd">        base_url: Base URL of the remote agent</span>
<span class="sd">        timeout: Request timeout in seconds</span>
<span class="sd">        max_retries: Maximum retry attempts for transient failures</span>
<span class="sd">        require_https: Whether HTTPS is required for non-localhost connections</span>
<span class="sd">        is_connected: Whether the client has an active connection</span>
<span class="sd">        compression: Whether compression is enabled for requests</span>
<span class="sd">        compression_threshold: Minimum payload size to trigger compression</span>
<span class="sd">        _circuit_breaker: Optional circuit breaker instance</span>

<span class="sd">    Pool sizing (pool_connections / pool_maxsize):</span>
<span class="sd">        Single-agent: 100 (default). Small cluster: 200â€“500. Large cluster: 500â€“1000.</span>
<span class="sd">        Supports 1000+ concurrent requests via connection reuse when pool_maxsize &lt; concurrency.</span>

<span class="sd">    HTTP/2 Multiplexing:</span>
<span class="sd">        HTTP/2 is enabled by default (http2=True) and provides request multiplexing over</span>
<span class="sd">        a single TCP connection, reducing latency for batch operations. If the server</span>
<span class="sd">        doesn&#39;t support HTTP/2, the client automatically falls back to HTTP/1.1.</span>

<span class="sd">    Compression:</span>
<span class="sd">        Compression is enabled by default (compression=True) for payloads exceeding</span>
<span class="sd">        1KB. Supports gzip (standard) and brotli (optional, requires brotli package).</span>
<span class="sd">        Brotli provides ~20% better compression than gzip for JSON payloads.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">        ...     response = await client.send(envelope)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Batch operations with HTTP/2 multiplexing</span>
<span class="sd">        &gt;&gt;&gt; async with ASAPClient(&quot;https://agent.example.com&quot;) as client:</span>
<span class="sd">        ...     responses = await client.send_batch([env1, env2, env3])</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Disable compression for specific client</span>
<span class="sd">        &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;, compression=False) as client:</span>
<span class="sd">        ...     response = await client.send(envelope)  # No compression</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_circuit_breaker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CircuitBreaker</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
        <span class="n">transport_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;websocket&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
        <span class="n">transport</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncBaseTransport</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">require_https</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">retry_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RetryConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># Connection pool (httpx.Limits); enables 1000+ concurrent via reuse</span>
        <span class="n">pool_connections</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pool_maxsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pool_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># HTTP/2 multiplexing for improved batch performance</span>
        <span class="n">http2</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="c1"># Compression settings for bandwidth reduction</span>
        <span class="n">compression</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">compression_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">COMPRESSION_THRESHOLD</span><span class="p">,</span>
        <span class="c1"># Individual retry parameters (for backward compatibility)</span>
        <span class="c1"># If retry_config is provided, these are ignored</span>
        <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">jitter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">circuit_breaker_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">circuit_breaker_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">circuit_breaker_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">manifest_cache_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify_signatures</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">trusted_manifest_keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OnMessageCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mtls_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MTLSConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Extract retry config values</span>
        <span class="k">if</span> <span class="n">retry_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use retry_config values</span>
            <span class="n">max_retries_val</span> <span class="o">=</span> <span class="n">retry_config</span><span class="o">.</span><span class="n">max_retries</span>
            <span class="n">base_delay_val</span> <span class="o">=</span> <span class="n">retry_config</span><span class="o">.</span><span class="n">base_delay</span>
            <span class="n">max_delay_val</span> <span class="o">=</span> <span class="n">retry_config</span><span class="o">.</span><span class="n">max_delay</span>
            <span class="n">jitter_val</span> <span class="o">=</span> <span class="n">retry_config</span><span class="o">.</span><span class="n">jitter</span>
            <span class="n">circuit_breaker_enabled_val</span> <span class="o">=</span> <span class="n">retry_config</span><span class="o">.</span><span class="n">circuit_breaker_enabled</span>
            <span class="n">circuit_breaker_threshold_val</span> <span class="o">=</span> <span class="n">retry_config</span><span class="o">.</span><span class="n">circuit_breaker_threshold</span>
            <span class="n">circuit_breaker_timeout_val</span> <span class="o">=</span> <span class="n">retry_config</span><span class="o">.</span><span class="n">circuit_breaker_timeout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use individual parameters with defaults</span>
            <span class="n">max_retries_val</span> <span class="o">=</span> <span class="n">max_retries</span> <span class="k">if</span> <span class="n">max_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DEFAULT_MAX_RETRIES</span>
            <span class="n">base_delay_val</span> <span class="o">=</span> <span class="n">base_delay</span> <span class="k">if</span> <span class="n">base_delay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DEFAULT_BASE_DELAY</span>
            <span class="n">max_delay_val</span> <span class="o">=</span> <span class="n">max_delay</span> <span class="k">if</span> <span class="n">max_delay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DEFAULT_MAX_DELAY</span>
            <span class="n">jitter_val</span> <span class="o">=</span> <span class="n">jitter</span> <span class="k">if</span> <span class="n">jitter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span>
            <span class="n">circuit_breaker_enabled_val</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">circuit_breaker_enabled</span> <span class="k">if</span> <span class="n">circuit_breaker_enabled</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">circuit_breaker_threshold_val</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">circuit_breaker_threshold</span>
                <span class="k">if</span> <span class="n">circuit_breaker_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">DEFAULT_CIRCUIT_BREAKER_THRESHOLD</span>
            <span class="p">)</span>
            <span class="n">circuit_breaker_timeout_val</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">circuit_breaker_timeout</span>
                <span class="k">if</span> <span class="n">circuit_breaker_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="n">DEFAULT_CIRCUIT_BREAKER_TIMEOUT</span>
            <span class="p">)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid base_url format: </span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. Must be a valid URL (e.g., http://localhost:8000)&quot;</span>
            <span class="p">)</span>

        <span class="n">scheme_lower</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">allowed_schemes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="s2">&quot;ws&quot;</span><span class="p">,</span> <span class="s2">&quot;wss&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">transport_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;websocket&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">scheme_lower</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_schemes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid URL scheme: </span><span class="si">{</span><span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">. Allowed: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_schemes</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Received: </span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">use_websocket</span> <span class="o">=</span> <span class="n">transport_mode</span> <span class="o">==</span> <span class="s2">&quot;websocket&quot;</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">transport_mode</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span> <span class="ow">and</span> <span class="n">scheme_lower</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ws&quot;</span><span class="p">,</span> <span class="s2">&quot;wss&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">use_websocket</span><span class="p">:</span>
            <span class="n">ws_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scheme_lower</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">):</span>
                <span class="n">ws_scheme</span> <span class="o">=</span> <span class="s2">&quot;wss&quot;</span> <span class="k">if</span> <span class="n">scheme_lower</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span> <span class="k">else</span> <span class="s2">&quot;ws&quot;</span>
                <span class="n">ws_netloc</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span>
                <span class="n">ws_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/asap/ws&quot;</span>
                <span class="n">ws_url</span> <span class="o">=</span> <span class="n">urlunparse</span><span class="p">((</span><span class="n">ws_scheme</span><span class="p">,</span> <span class="n">ws_netloc</span><span class="p">,</span> <span class="n">ws_path</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">ws_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/asap/ws&quot;</span><span class="p">):</span>
                <span class="n">ws_url</span> <span class="o">=</span> <span class="n">ws_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/asap/ws&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ws_url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">is_https</span> <span class="o">=</span> <span class="n">scheme_lower</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="s2">&quot;wss&quot;</span><span class="p">)</span>
        <span class="n">is_local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_localhost</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">require_https</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_https</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_local</span><span class="p">:</span>
                <span class="c1"># Allow unencrypted transport for localhost with warning</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.http_localhost&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                        <span class="s2">&quot;Using unencrypted transport for localhost connection. &quot;</span>
                        <span class="s2">&quot;For production, use HTTPS. &quot;</span>
                        <span class="s2">&quot;To disable this warning, set require_https=False.&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Reject unencrypted transport for non-localhost</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Encrypted transport (https/wss) is required for non-localhost connections. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Received: </span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Please use HTTPS/WSS or set require_https=False to override &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(not recommended for production).&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_websocket</span> <span class="o">=</span> <span class="n">use_websocket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ws_url</span> <span class="o">=</span> <span class="n">ws_url</span>
        <span class="k">if</span> <span class="n">use_websocket</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scheme_lower</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ws&quot;</span><span class="p">,</span> <span class="s2">&quot;wss&quot;</span><span class="p">):</span>
                <span class="n">http_scheme</span> <span class="o">=</span> <span class="s2">&quot;https&quot;</span> <span class="k">if</span> <span class="n">scheme_lower</span> <span class="o">==</span> <span class="s2">&quot;wss&quot;</span> <span class="k">else</span> <span class="s2">&quot;http&quot;</span>
                <span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/asap/ws&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;/&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_http_base_url</span> <span class="o">=</span> <span class="n">urlunparse</span><span class="p">((</span><span class="n">http_scheme</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_http_base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_http_base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_connections</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pool_connections</span> <span class="k">if</span> <span class="n">pool_connections</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DEFAULT_POOL_CONNECTIONS</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_maxsize</span> <span class="o">=</span> <span class="n">pool_maxsize</span> <span class="k">if</span> <span class="n">pool_maxsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DEFAULT_POOL_MAXSIZE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pool_timeout</span> <span class="o">=</span> <span class="n">pool_timeout</span> <span class="k">if</span> <span class="n">pool_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DEFAULT_POOL_TIMEOUT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="n">max_retries_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_https</span> <span class="o">=</span> <span class="n">require_https</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_delay</span> <span class="o">=</span> <span class="n">base_delay_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span> <span class="o">=</span> <span class="n">max_delay_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jitter</span> <span class="o">=</span> <span class="n">jitter_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit_breaker_enabled</span> <span class="o">=</span> <span class="n">circuit_breaker_enabled_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="n">transport</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_http2</span> <span class="o">=</span> <span class="n">http2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compression</span> <span class="o">=</span> <span class="n">compression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compression_threshold</span> <span class="o">=</span> <span class="n">compression_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_message</span> <span class="o">=</span> <span class="n">on_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="p">:</span> <span class="n">WebSocketTransport</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Thread-safe counter using itertools.count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Initialize circuit breaker if enabled</span>
        <span class="c1"># Use registry to ensure state is shared across multiple client instances</span>
        <span class="c1"># for the same base_url</span>
        <span class="k">if</span> <span class="n">circuit_breaker_enabled_val</span><span class="p">:</span>
            <span class="n">registry</span> <span class="o">=</span> <span class="n">get_registry</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="n">threshold</span><span class="o">=</span><span class="n">circuit_breaker_threshold_val</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">circuit_breaker_timeout_val</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Per-client manifest cache (not shared like circuit breaker).</span>
        <span class="n">cache_max</span> <span class="o">=</span> <span class="n">manifest_cache_size</span> <span class="k">if</span> <span class="n">manifest_cache_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DEFAULT_MAX_SIZE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span> <span class="o">=</span> <span class="n">ManifestCache</span><span class="p">(</span><span class="n">max_size</span><span class="o">=</span><span class="n">cache_max</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks_guard</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_signatures</span> <span class="o">=</span> <span class="n">verify_signatures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trusted_manifest_keys</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">trusted_manifest_keys</span><span class="p">)</span> <span class="k">if</span> <span class="n">trusted_manifest_keys</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mtls_config</span> <span class="o">=</span> <span class="n">mtls_config</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_localhost</span><span class="p">(</span><span class="n">parsed_url</span><span class="p">:</span> <span class="n">ParseResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">hostname</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hostname</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">hostname_lower</span> <span class="o">=</span> <span class="n">hostname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># Handle both ::1 and [::1] (bracket notation from URL parsing)</span>
        <span class="k">return</span> <span class="n">hostname_lower</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;::1&quot;</span><span class="p">,</span> <span class="s2">&quot;[::1]&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_backoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="c1"># Calculate exponential delay: base_delay * (2 ** attempt)</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">attempt</span><span class="p">)</span>

        <span class="c1"># Cap at max_delay</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jitter</span><span class="p">:</span>
            <span class="n">jitter_amount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">delay</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># nosec B311</span>
            <span class="n">delay</span> <span class="o">+=</span> <span class="n">jitter_amount</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_validate_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that the agent endpoint is accessible.</span>

<span class="sd">        Performs a pre-flight check by attempting to access the agent&#39;s</span>
<span class="sd">        manifest endpoint. This can be used to detect connection issues</span>
<span class="sd">        before sending actual requests.</span>

<span class="sd">        Note: This is an optional validation step that can be disabled</span>
<span class="sd">        for performance reasons in production environments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if connection is valid, False otherwise</span>

<span class="sd">        Raises:</span>
<span class="sd">            ASAPConnectionError: If connection validation fails</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to access a lightweight endpoint (manifest or health check)</span>
            <span class="c1"># Using HEAD request to minimize bandwidth</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">head</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_http_base_url</span><span class="si">}</span><span class="s2">/.well-known/asap/manifest.json&quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>  <span class="c1"># Shorter timeout for validation</span>
            <span class="p">)</span>
            <span class="c1"># Any 2xx or 3xx response indicates the server is reachable</span>
            <span class="n">is_valid</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">400</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.connection_validation_failed&quot;</span><span class="p">,</span>
                    <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Connection validation failed for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Server returned status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and the URL is correct.&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">is_valid</span>
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ConnectError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.connection_validation_failed&quot;</span><span class="p">,</span>
                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connection validation failed for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot reach the agent. Verify the agent is running and accessible. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.connection_validation_timeout&quot;</span><span class="p">,</span>
                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connection validation timed out for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Check network connectivity and firewall settings.&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.connection_validation_error&quot;</span><span class="p">,</span>
                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connection validation encountered an error for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if client has an active connection.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_httpx_mtls_kwargs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtls_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtls_config</span>
        <span class="n">cert</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">cert_file</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">key_file</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">key_password</span><span class="p">:</span>
            <span class="n">cert</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">cert_file</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">key_file</span><span class="p">),</span> <span class="n">cfg</span><span class="o">.</span><span class="n">key_password</span><span class="p">)</span>
        <span class="n">verify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">)</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">ca_certs</span> <span class="k">else</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">verify</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ASAPClient&quot;</span><span class="p">:</span>
        <span class="n">cert</span><span class="p">,</span> <span class="n">verify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_httpx_mtls_kwargs</span><span class="p">()</span>
        <span class="n">ws_ssl_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mtls_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ws_ssl_context</span> <span class="o">=</span> <span class="n">create_ssl_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mtls_config</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;client&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_websocket</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span> <span class="o">=</span> <span class="n">WebSocketTransport</span><span class="p">(</span>
                <span class="n">receive_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                <span class="n">on_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_message</span><span class="p">,</span>
                <span class="n">ack_timeout_seconds</span><span class="o">=</span><span class="n">DEFAULT_ACK_TIMEOUT</span><span class="p">,</span>
                <span class="n">max_ack_retries</span><span class="o">=</span><span class="n">DEFAULT_MAX_ACK_RETRIES</span><span class="p">,</span>
                <span class="n">circuit_breaker</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="p">,</span>
                <span class="n">ssl_context</span><span class="o">=</span><span class="n">ws_ssl_context</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ws_url</span><span class="p">)</span>
            <span class="c1"># WebSocket mode still uses HTTP client for manifest fetches; small pool is enough.</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Limits</span><span class="p">(</span><span class="n">max_connections</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_keepalive_connections</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">timeout_config</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool_timeout</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_config</span><span class="p">,</span>
                <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span>
                <span class="n">cert</span><span class="o">=</span><span class="n">cert</span><span class="p">,</span>
                <span class="n">verify</span><span class="o">=</span><span class="n">verify</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Limits</span><span class="p">(</span>
                <span class="n">max_keepalive_connections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool_connections</span><span class="p">,</span>
                <span class="n">max_connections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool_maxsize</span><span class="p">,</span>
                <span class="n">keepalive_expiry</span><span class="o">=</span><span class="n">DEFAULT_POOL_TIMEOUT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">timeout_config</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pool_timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span>
                    <span class="n">transport</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_config</span><span class="p">,</span>
                    <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span>
                    <span class="n">cert</span><span class="o">=</span><span class="n">cert</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="n">verify</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_config</span><span class="p">,</span>
                    <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span>
                    <span class="n">http2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_http2</span><span class="p">,</span>
                    <span class="n">cert</span><span class="o">=</span><span class="n">cert</span><span class="p">,</span>
                    <span class="n">verify</span><span class="o">=</span><span class="n">verify</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exc_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exc_val</span><span class="p">:</span> <span class="ne">BaseException</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exc_tb</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envelope</span><span class="p">:</span> <span class="n">Envelope</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Envelope</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send an envelope to the remote agent and receive response.</span>

<span class="sd">        Wraps the envelope in a JSON-RPC 2.0 request, sends it to the</span>
<span class="sd">        remote agent&#39;s /asap endpoint, and unwraps the response.</span>

<span class="sd">        Args:</span>
<span class="sd">            envelope: ASAP envelope to send</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response envelope from the remote agent</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If envelope is None</span>
<span class="sd">            ASAPConnectionError: If connection fails or HTTP error occurs</span>
<span class="sd">            ASAPTimeoutError: If request times out</span>
<span class="sd">            ASAPRemoteError: If remote agent returns JSON-RPC error</span>
<span class="sd">            CircuitOpenError: If circuit breaker is open and request is rejected</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">            ...     response = await client.send(envelope)</span>
<span class="sd">            ...     response.payload_type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">envelope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;envelope cannot be None&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">can_attempt</span><span class="p">():</span>
                <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">CircuitOpenError</span><span class="p">(</span>
                    <span class="n">base_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                    <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="o">.</span><span class="n">send_and_receive</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">WebSocketRemoteError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ASAPRemoteError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ASAPTimeoutError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;WebSocket receive timed out after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">can_attempt</span><span class="p">():</span>
            <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">CircuitOpenError</span><span class="p">(</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="c1"># Generate idempotency key for retries</span>
        <span class="n">idempotency_key</span> <span class="o">=</span> <span class="n">generate_id</span><span class="p">()</span>

        <span class="c1"># Get next request counter value (thread-safe)</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;req-</span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request_counter</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Log send attempt with context (sanitize URL to hide credentials)</span>
        <span class="n">sanitized_url</span> <span class="o">=</span> <span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.client.send&quot;</span><span class="p">,</span>
            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitized_url</span><span class="p">,</span>
            <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">trace_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
            <span class="n">payload_type</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span><span class="p">,</span>
            <span class="n">idempotency_key</span><span class="o">=</span><span class="n">idempotency_key</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Sending envelope </span><span class="si">{</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">sanitized_url</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(payload: </span><span class="si">{</span><span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span><span class="si">}</span><span class="s2">, max_retries: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Build JSON-RPC request</span>
        <span class="n">json_rpc_request</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">ASAP_METHOD</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;envelope&quot;</span><span class="p">:</span> <span class="n">envelope</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">),</span>
                <span class="s2">&quot;idempotency_key&quot;</span><span class="p">:</span> <span class="n">idempotency_key</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Serialize to bytes for compression</span>
        <span class="n">request_body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_rpc_request</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="c1"># Apply compression if enabled and payload exceeds threshold</span>
        <span class="n">content_encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compression</span><span class="p">:</span>
            <span class="n">compressed_body</span><span class="p">,</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="n">compress_payload</span><span class="p">(</span>
                <span class="n">request_body</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compression_threshold</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">algorithm</span> <span class="o">!=</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">:</span>
                <span class="n">request_body</span> <span class="o">=</span> <span class="n">compressed_body</span>
                <span class="n">content_encoding</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">value</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.compression_applied&quot;</span><span class="p">,</span>
                    <span class="n">target_url</span><span class="o">=</span><span class="n">sanitized_url</span><span class="p">,</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">algorithm</span><span class="o">=</span><span class="n">content_encoding</span><span class="p">,</span>
                    <span class="n">original_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_rpc_request</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)),</span>
                    <span class="n">compressed_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">request_body</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="c1"># Attempt with retries</span>
        <span class="n">last_exception</span><span class="p">:</span> <span class="ne">Exception</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">get_metrics</span><span class="p">()</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="s2">&quot;asap_transport_retries_total&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Build headers</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;X-Idempotency-Key&quot;</span><span class="p">:</span> <span class="n">idempotency_key</span><span class="p">,</span>
                    <span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="n">get_accept_encoding_header</span><span class="p">(),</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">content_encoding</span><span class="p">:</span>
                    <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Encoding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_encoding</span>

                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># HTTP path: __aenter__ set it</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/asap&quot;</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                    <span class="n">content</span><span class="o">=</span><span class="n">request_body</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Log HTTP protocol version for debugging fallback behavior</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http2</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">http_version</span> <span class="o">!=</span> <span class="s2">&quot;HTTP/2&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;asap.client.http_fallback&quot;</span><span class="p">,</span>
                        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                        <span class="n">requested</span><span class="o">=</span><span class="s2">&quot;HTTP/2&quot;</span><span class="p">,</span>
                        <span class="n">actual</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">http_version</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HTTP/2 requested but used </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">http_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
                    <span class="c1"># Server errors (5xx) are retriable</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;HTTP server error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Server returned: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_backoff</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;asap.client.retry_server_error&quot;</span><span class="p">,</span>
                            <span class="n">status_code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                            <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                            <span class="n">delay_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                            <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Server error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;(attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                        <span class="n">last_exception</span> <span class="o">=</span> <span class="n">ASAPConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># All retries exhausted, record failure in circuit breaker</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
                        <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                        <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
                        <span class="c1"># Log state change if circuit opened</span>
                        <span class="k">if</span> <span class="n">previous_state</span> <span class="o">!=</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;asap.client.circuit_opened&quot;</span><span class="p">,</span>
                                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                                <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
                                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker opened after </span><span class="si">{</span><span class="n">consecutive_failures</span><span class="si">}</span><span class="s2"> consecutive failures&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">retry_after</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">retry_after</span><span class="p">:</span>
                            <span class="n">retry_delay</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="c1"># Retry-After can be seconds (int/float) or HTTP date</span>
                            <span class="c1"># First, try to parse as seconds (numeric)</span>
                            <span class="k">if</span> <span class="n">retry_after</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">retry_delay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">retry_after</span><span class="p">)</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="s2">&quot;asap.client.retry_after&quot;</span><span class="p">,</span>
                                        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                                        <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                        <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="n">retry_after_seconds</span><span class="o">=</span><span class="n">retry_delay</span><span class="p">,</span>
                                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Respecting server Retry-After: </span><span class="si">{</span><span class="n">retry_delay</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="k">pass</span>  <span class="c1"># Fall through to date parsing</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Try to parse as HTTP date</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">retry_date</span> <span class="o">=</span> <span class="n">parsedate_to_datetime</span><span class="p">(</span><span class="n">retry_after</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">retry_date</span><span class="p">:</span>
                                        <span class="c1"># Calculate delay in seconds from now until retry_date</span>
                                        <span class="n">now_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                                        <span class="n">retry_timestamp</span> <span class="o">=</span> <span class="n">retry_date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                                        <span class="n">calculated_delay</span> <span class="o">=</span> <span class="n">retry_timestamp</span> <span class="o">-</span> <span class="n">now_timestamp</span>
                                        <span class="c1"># If date is in the past or delay is invalid, fall back to calculated backoff</span>
                                        <span class="k">if</span> <span class="n">calculated_delay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">retry_delay</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will trigger fallback</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">retry_delay</span> <span class="o">=</span> <span class="n">calculated_delay</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                                <span class="s2">&quot;asap.client.retry_after&quot;</span><span class="p">,</span>
                                                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                                                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                <span class="n">retry_after_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                                <span class="n">retry_after_date</span><span class="o">=</span><span class="n">retry_after</span><span class="p">,</span>
                                                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Respecting server Retry-After date: </span><span class="si">{</span><span class="n">retry_after</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">retry_delay</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">,</span>
                                            <span class="p">)</span>
                                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                                    <span class="c1"># Invalid date format or timestamp conversion error, fall back to calculated backoff</span>
                                    <span class="k">pass</span>

                            <span class="c1"># If parsing failed or delay is invalid (None or &lt;= 0), use calculated backoff</span>
                            <span class="k">if</span> <span class="n">retry_delay</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">retry_delay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">retry_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_backoff</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;asap.client.retry_after_invalid&quot;</span><span class="p">,</span>
                                    <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="n">retry_after_header</span><span class="o">=</span><span class="n">retry_after</span><span class="p">,</span>
                                    <span class="n">fallback_delay</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid Retry-After format, using calculated backoff&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="n">delay</span> <span class="o">=</span> <span class="n">retry_delay</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># No Retry-After header, use calculated backoff</span>
                            <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_backoff</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;asap.client.rate_limited&quot;</span><span class="p">,</span>
                            <span class="n">status_code</span><span class="o">=</span><span class="mi">429</span><span class="p">,</span>
                            <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                            <span class="n">delay_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;asap.client.retry&quot;</span><span class="p">,</span>
                            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                            <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                            <span class="n">delay_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                        <span class="n">last_exception</span> <span class="o">=</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;HTTP rate limit error 429 from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># All retries exhausted, record failure in circuit breaker</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
                        <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                        <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
                        <span class="c1"># Log state change if circuit opened</span>
                        <span class="k">if</span> <span class="n">previous_state</span> <span class="o">!=</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;asap.client.circuit_opened&quot;</span><span class="p">,</span>
                                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                                <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
                                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker opened after </span><span class="si">{</span><span class="n">consecutive_failures</span><span class="si">}</span><span class="s2"> consecutive failures (rate limited)&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;HTTP rate limit error 429 from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                    <span class="c1"># Client errors (4xx) are not retriable (except 429 handled above)</span>
                    <span class="c1"># We record a failure in the circuit breaker here because persistent 4xx</span>
                    <span class="c1"># (like 401/403) can indicate an unhealthy configuration or system state.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>

                    <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;HTTP client error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;This indicates a problem with the request. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                    <span class="p">)</span>

                <span class="c1"># Parse JSON response</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">json_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ASAPRemoteError</span><span class="p">(</span><span class="o">-</span><span class="mi">32700</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid JSON response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

                <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">json_response</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_success</span><span class="p">()</span>

                    <span class="n">error</span> <span class="o">=</span> <span class="n">json_response</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>
                    <span class="k">raise</span> <span class="n">ASAPRemoteError</span><span class="p">(</span>
                        <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">32603</span><span class="p">),</span>
                        <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">),</span>
                        <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
                    <span class="p">)</span>

                <span class="c1"># Extract envelope from result</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">json_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">envelope_data</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;envelope&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">envelope_data</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ASAPRemoteError</span><span class="p">(</span><span class="o">-</span><span class="mi">32603</span><span class="p">,</span> <span class="s2">&quot;Missing envelope in response&quot;</span><span class="p">)</span>

                <span class="n">response_envelope</span> <span class="o">=</span> <span class="n">Envelope</span><span class="p">(</span><span class="o">**</span><span class="n">envelope_data</span><span class="p">)</span>

                <span class="c1"># Record success in circuit breaker</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_success</span><span class="p">()</span>
                    <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                    <span class="c1"># Log state change if circuit was closed</span>
                    <span class="k">if</span> <span class="n">previous_state</span> <span class="o">!=</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s2">&quot;asap.client.circuit_closed&quot;</span><span class="p">,</span>
                            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Circuit breaker closed after successful request&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

                <span class="c1"># Calculate duration and log success</span>
                <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="n">duration_ms</span> <span class="o">=</span> <span class="n">duration_seconds</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.response&quot;</span><span class="p">,</span>
                    <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">response_id</span><span class="o">=</span><span class="n">response_envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">trace_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
                    <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">attempts</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
                <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="s2">&quot;asap_transport_send_total&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">})</span>
                <span class="n">metrics</span><span class="o">.</span><span class="n">observe_histogram</span><span class="p">(</span>
                    <span class="s2">&quot;asap_transport_send_duration_seconds&quot;</span><span class="p">,</span>
                    <span class="n">duration_seconds</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">response_envelope</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">httpx</span><span class="o">.</span><span class="n">ConnectError</span><span class="p">,</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">is_timeout</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span><span class="p">)</span>
                <span class="n">error_type</span> <span class="o">=</span> <span class="s2">&quot;Timeout&quot;</span> <span class="k">if</span> <span class="n">is_timeout</span> <span class="k">else</span> <span class="s2">&quot;Connection error&quot;</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">is_timeout</span><span class="p">:</span>
                    <span class="n">last_exception</span> <span class="o">=</span> <span class="n">ASAPTimeoutError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Request timeout after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_exception</span> <span class="o">=</span> <span class="n">ASAPConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>

                <span class="c1"># Log retry attempt</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_backoff</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.client.retry&quot;</span><span class="p">,</span>
                        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                        <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="n">delay_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2"> (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">). &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># All retries exhausted, record failure in circuit breaker</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
                    <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                    <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
                    <span class="c1"># Log state change if circuit opened</span>
                    <span class="k">if</span> <span class="n">previous_state</span> <span class="o">!=</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;asap.client.circuit_opened&quot;</span><span class="p">,</span>
                            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                            <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
                            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker opened after </span><span class="si">{</span><span class="n">consecutive_failures</span><span class="si">}</span><span class="s2"> consecutive failures&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

                <span class="c1"># Log final failure with detailed context</span>
                <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="n">error_type_name</span> <span class="o">=</span> <span class="s2">&quot;ASAPTimeoutError&quot;</span> <span class="k">if</span> <span class="n">is_timeout</span> <span class="k">else</span> <span class="s2">&quot;ASAPConnectionError&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.error&quot;</span><span class="p">,</span>
                    <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2"> after retries&quot;</span><span class="p">,</span>
                    <span class="n">error_type</span><span class="o">=</span><span class="n">error_type_name</span><span class="p">,</span>
                    <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">attempts</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="k">if</span> <span class="n">is_timeout</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2"> failed after </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> attempts. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Total duration: </span><span class="si">{</span><span class="n">duration_ms</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Troubleshooting: Verify the agent is running, check network connectivity, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;and ensure the URL is correct. Original error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">last_exception</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">ASAPConnectionError</span><span class="p">,</span> <span class="n">ASAPRemoteError</span><span class="p">,</span> <span class="n">ASAPTimeoutError</span><span class="p">):</span>
                <span class="c1"># Re-raise our custom errors without recording failure again</span>
                <span class="c1"># (failures are already recorded before these exceptions are raised)</span>
                <span class="k">raise</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Record failure in circuit breaker</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
                    <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                    <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
                    <span class="c1"># Log state change if circuit opened</span>
                    <span class="k">if</span> <span class="n">previous_state</span> <span class="o">!=</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;asap.client.circuit_opened&quot;</span><span class="p">,</span>
                            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                            <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
                            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker opened after </span><span class="si">{</span><span class="n">consecutive_failures</span><span class="si">}</span><span class="s2"> consecutive failures&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="c1"># Log unexpected error</span>
                <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.error&quot;</span><span class="p">,</span>
                    <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">_record_send_error_metrics</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="c1"># Wrap unexpected errors</span>
                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected error connecting to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                    <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">if</span> <span class="n">last_exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">_record_send_error_metrics</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">last_exception</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">last_exception</span>
        <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Max retries (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">) exceeded for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
        <span class="p">)</span>  <span class="c1"># pragma: no cover</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Manifest</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get agent manifest from cache or HTTP endpoint.</span>

<span class="sd">        Checks cache first, then fetches from HTTP if not cached or expired.</span>
<span class="sd">        Caches successful responses with TTL (default: 5 minutes).</span>
<span class="sd">        Invalidates cache entry on error.</span>

<span class="sd">        Args:</span>
<span class="sd">            url: Manifest URL (defaults to {base_url}/.well-known/asap/manifest.json)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Manifest object</span>

<span class="sd">        Raises:</span>
<span class="sd">            ASAPConnectionError: If HTTP request fails</span>
<span class="sd">            ASAPTimeoutError: If request times out</span>
<span class="sd">            ValueError: If manifest JSON is invalid</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; async with ASAPClient(&quot;http://agent.example.com&quot;) as client:</span>
<span class="sd">            ...     manifest = await client.get_manifest()</span>
<span class="sd">            ...     print(manifest.id, manifest.name)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_http_base_url</span><span class="si">}</span><span class="s2">/.well-known/asap/manifest.json&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks_guard</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
            <span class="n">url_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">[</span><span class="n">url</span><span class="p">]</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">url_lock</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.manifest_cache_hit&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                    <span class="n">manifest_id</span><span class="o">=</span><span class="n">cached</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Manifest cache hit for </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">cached</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.manifest_cache_miss&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Manifest cache miss for </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2">, fetching from HTTP&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MANIFEST_REQUEST_TIMEOUT</span><span class="p">),</span>  <span class="c1"># Cap timeout for manifest</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;HTTP error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> fetching manifest from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                    <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON in manifest response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;manifest&quot;</span> <span class="ow">in</span> <span class="n">manifest_data</span> <span class="ow">and</span> <span class="s2">&quot;signature&quot;</span> <span class="ow">in</span> <span class="n">manifest_data</span><span class="p">:</span>
                        <span class="n">signed</span> <span class="o">=</span> <span class="n">SignedManifest</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">manifest_data</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_signatures</span><span class="p">:</span>
                            <span class="n">trusted_b64</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trusted_manifest_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">trusted_b64</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">SignatureVerificationError</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Cannot verify signed manifest from </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
                                    <span class="s2">&quot;no trusted public key provided. Pass trusted_manifest_keys &quot;</span>
                                    <span class="s2">&quot;to ASAPClient (or disable verify_signatures).&quot;</span><span class="p">,</span>
                                    <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)},</span>
                                <span class="p">)</span>
                            <span class="n">trusted_key</span> <span class="o">=</span> <span class="n">load_public_key_from_base64</span><span class="p">(</span><span class="n">trusted_b64</span><span class="p">)</span>
                            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">verify_manifest</span><span class="p">,</span> <span class="n">signed</span><span class="p">,</span> <span class="n">trusted_key</span><span class="p">)</span>
                        <span class="n">manifest</span> <span class="o">=</span> <span class="n">signed</span><span class="o">.</span><span class="n">manifest</span>
                        <span class="n">trust_level</span> <span class="o">=</span> <span class="n">signed</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">trust_level</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">manifest</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">manifest_data</span><span class="p">)</span>
                        <span class="n">trust_level</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="n">SignatureVerificationError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid manifest format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.manifest_fetched&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                    <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">trust_level</span><span class="o">=</span><span class="n">trust_level</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Manifest fetched and cached for </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; (trust: </span><span class="si">{</span><span class="n">trust_level</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">trust_level</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">manifest</span>

            <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ASAPTimeoutError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Manifest request timeout after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ConnectError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connection error fetching manifest from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                    <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">ASAPConnectionError</span><span class="p">,</span> <span class="n">ASAPTimeoutError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">SignatureVerificationError</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.manifest_error&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unexpected error fetching manifest from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected error fetching manifest from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                    <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">discover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Manifest</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover agent manifest from its base URL (well-known URI).</span>

<span class="sd">        Fetches GET {base_url}/.well-known/asap/manifest.json, parses the</span>
<span class="sd">        response into a Manifest, and caches it by manifest URL. When the</span>
<span class="sd">        manifest is already in cache and not expired, returns it without</span>
<span class="sd">        making a new request. Respects Cache-Control max-age when provided</span>
<span class="sd">        for cache TTL.</span>

<span class="sd">        Args:</span>
<span class="sd">            base_url: Agent base URL (e.g. &quot;https://agent.example.com&quot;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Manifest for the agent at base_url.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ASAPConnectionError: If client not connected or HTTP request fails.</span>
<span class="sd">            ASAPTimeoutError: If request times out.</span>
<span class="sd">            ValueError: If manifest response is not valid JSON.</span>
<span class="sd">            ManifestValidationError: If manifest schema or required fields are invalid.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">            ...     manifest = await client.discover(&quot;https://other-agent.example.com&quot;)</span>
<span class="sd">            ...     print(manifest.id, manifest.capabilities.asap_version)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">manifest_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">WELLKNOWN_MANIFEST_PATH</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks_guard</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">manifest_url</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">[</span><span class="n">manifest_url</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
            <span class="n">url_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">[</span><span class="n">manifest_url</span><span class="p">]</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">url_lock</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.discover_cache_hit&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
                    <span class="n">manifest_id</span><span class="o">=</span><span class="n">cached</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Discovery cache hit for </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">cached</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">manifest_url</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MANIFEST_REQUEST_TIMEOUT</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;HTTP error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> fetching manifest from </span><span class="si">{</span><span class="n">manifest_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
                    <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON in manifest response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">manifest</span> <span class="o">=</span> <span class="n">validate_manifest_schema</span><span class="p">(</span><span class="n">manifest_data</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ManifestValidationError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
                    <span class="k">raise</span>

                <span class="n">ttl</span> <span class="o">=</span> <span class="n">_parse_max_age_from_cache_control</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cache-Control&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="n">ttl</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.discover&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
                    <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Discovered and cached manifest for </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">manifest</span>

            <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ASAPTimeoutError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Manifest request timeout after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ConnectError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connection error fetching manifest from </span><span class="si">{</span><span class="n">manifest_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                    <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">ASAPConnectionError</span><span class="p">,</span> <span class="n">ASAPTimeoutError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">ManifestValidationError</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.discover_error&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected error discovering manifest from </span><span class="si">{</span><span class="n">manifest_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                    <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HealthStatus</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check agent health/liveness at the given base URL.</span>

<span class="sd">        Fetches GET {base_url}/.well-known/asap/health and parses the</span>
<span class="sd">        response into a HealthStatus model.</span>

<span class="sd">        Args:</span>
<span class="sd">            base_url: Agent base URL (e.g. &quot;https://agent.example.com&quot;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            HealthStatus with status, agent_id, version, uptime_seconds, etc.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ASAPConnectionError: If client not connected or HTTP request fails.</span>
<span class="sd">            ASAPTimeoutError: If request times out.</span>
<span class="sd">            ValueError: If health response is not valid JSON or schema invalid.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">            ...     health = await client.health_check(&quot;https://other-agent.example.com&quot;)</span>
<span class="sd">            ...     print(health.status, health.uptime_seconds)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">health_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">WELLKNOWN_HEALTH_PATH</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">health_url</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">health_url</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MANIFEST_REQUEST_TIMEOUT</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;HTTP error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> fetching health from </span><span class="si">{</span><span class="n">health_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">health_url</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON in health response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid health response schema: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPTimeoutError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Health request timeout after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ConnectError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Connection error fetching health from </span><span class="si">{</span><span class="n">health_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">health_url</span><span class="p">),</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ASAPConnectionError</span><span class="p">,</span> <span class="n">ASAPTimeoutError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.health_check_error&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">health_url</span><span class="p">),</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error checking health at </span><span class="si">{</span><span class="n">health_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">health_url</span><span class="p">),</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">envelopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Envelope</span><span class="p">],</span>
        <span class="n">return_exceptions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Envelope</span> <span class="o">|</span> <span class="ne">BaseException</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send multiple envelopes in parallel using asyncio.gather.</span>

<span class="sd">        Uses asyncio.gather to send all envelopes concurrently, leveraging</span>
<span class="sd">        connection pooling and HTTP/2 multiplexing for optimal throughput.</span>

<span class="sd">        Args:</span>
<span class="sd">            envelopes: List of ASAP envelopes to send</span>
<span class="sd">            return_exceptions: If True, exceptions are returned in the result list</span>
<span class="sd">                instead of being raised. If False (default), the first exception</span>
<span class="sd">                encountered will be raised.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of response envelopes in the same order as input envelopes.</span>
<span class="sd">            If return_exceptions=True, failed sends will have the exception</span>
<span class="sd">            in their position instead of an Envelope.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If envelopes list is empty</span>
<span class="sd">            ASAPConnectionError: If any send fails (when return_exceptions=False)</span>
<span class="sd">            ASAPTimeoutError: If any send times out (when return_exceptions=False)</span>
<span class="sd">            ASAPRemoteError: If any remote agent returns error (when return_exceptions=False)</span>
<span class="sd">            CircuitOpenError: If circuit breaker is open (when return_exceptions=False)</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">            ...     responses = await client.send_batch([env1, env2, env3])</span>
<span class="sd">            ...     for response in responses:</span>
<span class="sd">            ...         print(response.payload_type)</span>
<span class="sd">            &gt;&gt;&gt;</span>
<span class="sd">            &gt;&gt;&gt; # With error handling</span>
<span class="sd">            &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">            ...     results = await client.send_batch(envelopes, return_exceptions=True)</span>
<span class="sd">            ...     for i, result in enumerate(results):</span>
<span class="sd">            ...         if isinstance(result, BaseException):</span>
<span class="sd">            ...             print(f&quot;Envelope {i} failed: {result}&quot;)</span>
<span class="sd">            ...         else:</span>
<span class="sd">            ...             print(f&quot;Envelope {i} succeeded: {result.id}&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">envelopes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;envelopes list cannot be empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;send_batch is not supported with WebSocket transport; use send() in a loop.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">envelopes</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.client.send_batch&quot;</span><span class="p">,</span>
            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Sending batch of </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> envelopes to </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="c1"># Create send tasks for all envelopes</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span> <span class="k">for</span> <span class="n">envelope</span> <span class="ow">in</span> <span class="n">envelopes</span><span class="p">]</span>

        <span class="c1"># Execute all tasks concurrently</span>
        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="n">return_exceptions</span><span class="p">)</span>

        <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="c1"># Count successes and failures</span>
        <span class="k">if</span> <span class="n">return_exceptions</span><span class="p">:</span>
            <span class="n">success_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Envelope</span><span class="p">))</span>
            <span class="n">failure_count</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">success_count</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">success_count</span> <span class="o">=</span> <span class="n">batch_size</span>
            <span class="n">failure_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.client.send_batch_complete&quot;</span><span class="p">,</span>
            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">success_count</span><span class="o">=</span><span class="n">success_count</span><span class="p">,</span>
            <span class="n">failure_count</span><span class="o">=</span><span class="n">failure_count</span><span class="p">,</span>
            <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">throughput_per_second</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">/</span> <span class="p">(</span><span class="n">duration_ms</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">duration_ms</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Batch of </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> envelopes completed in </span><span class="si">{</span><span class="n">duration_ms</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">success_count</span><span class="si">}</span><span class="s2"> succeeded, </span><span class="si">{</span><span class="n">failure_count</span><span class="si">}</span><span class="s2"> failed)&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h4 id="asap.transport.ASAPClient.is_connected" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_connected</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Check if client has an active connection.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h4 id="asap.transport.ASAPClient.discover" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">discover</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Discover agent manifest from its base URL (well-known URI).</p>
<p>Fetches GET {base_url}/.well-known/asap/manifest.json, parses the
response into a Manifest, and caches it by manifest URL. When the
manifest is already in cache and not expired, returns it without
making a new request. Respects Cache-Control max-age when provided
for cache TTL.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>base_url</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Agent base URL (e.g. "https://agent.example.com").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Manifest (asap.models.entities.Manifest)" href="#asap.models.entities.Manifest">Manifest</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manifest for the agent at base_url.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPConnectionError (asap.transport.client.ASAPConnectionError)" href="#asap.transport.ASAPConnectionError">ASAPConnectionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If client not connected or HTTP request fails.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPTimeoutError (asap.transport.client.ASAPTimeoutError)" href="#asap.transport.ASAPTimeoutError">ASAPTimeoutError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If request times out.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If manifest response is not valid JSON.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="asap.discovery.validation.ManifestValidationError">ManifestValidationError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If manifest schema or required fields are invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>async with ASAPClient("http://localhost:8000") as client:
...     manifest = await client.discover("https://other-agent.example.com")
...     print(manifest.id, manifest.capabilities.asap_version)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/client.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">discover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Manifest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discover agent manifest from its base URL (well-known URI).</span>

<span class="sd">    Fetches GET {base_url}/.well-known/asap/manifest.json, parses the</span>
<span class="sd">    response into a Manifest, and caches it by manifest URL. When the</span>
<span class="sd">    manifest is already in cache and not expired, returns it without</span>
<span class="sd">    making a new request. Respects Cache-Control max-age when provided</span>
<span class="sd">    for cache TTL.</span>

<span class="sd">    Args:</span>
<span class="sd">        base_url: Agent base URL (e.g. &quot;https://agent.example.com&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Manifest for the agent at base_url.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ASAPConnectionError: If client not connected or HTTP request fails.</span>
<span class="sd">        ASAPTimeoutError: If request times out.</span>
<span class="sd">        ValueError: If manifest response is not valid JSON.</span>
<span class="sd">        ManifestValidationError: If manifest schema or required fields are invalid.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">        ...     manifest = await client.discover(&quot;https://other-agent.example.com&quot;)</span>
<span class="sd">        ...     print(manifest.id, manifest.capabilities.asap_version)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">manifest_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">WELLKNOWN_MANIFEST_PATH</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
            <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks_guard</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">manifest_url</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">[</span><span class="n">manifest_url</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="n">url_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">[</span><span class="n">manifest_url</span><span class="p">]</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">url_lock</span><span class="p">:</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.discover_cache_hit&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
                <span class="n">manifest_id</span><span class="o">=</span><span class="n">cached</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Discovery cache hit for </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">cached</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">manifest_url</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MANIFEST_REQUEST_TIMEOUT</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;HTTP error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> fetching manifest from </span><span class="si">{</span><span class="n">manifest_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON in manifest response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">manifest</span> <span class="o">=</span> <span class="n">validate_manifest_schema</span><span class="p">(</span><span class="n">manifest_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ManifestValidationError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
                <span class="k">raise</span>

            <span class="n">ttl</span> <span class="o">=</span> <span class="n">_parse_max_age_from_cache_control</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cache-Control&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="n">ttl</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.discover&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
                <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Discovered and cached manifest for </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">manifest</span>

        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ASAPTimeoutError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Manifest request timeout after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ConnectError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Connection error fetching manifest from </span><span class="si">{</span><span class="n">manifest_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ASAPConnectionError</span><span class="p">,</span> <span class="n">ASAPTimeoutError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">ManifestValidationError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.discover_error&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error discovering manifest from </span><span class="si">{</span><span class="n">manifest_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">manifest_url</span><span class="p">),</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.transport.ASAPClient.get_manifest" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_manifest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Get agent manifest from cache or HTTP endpoint.</p>
<p>Checks cache first, then fetches from HTTP if not cached or expired.
Caches successful responses with TTL (default: 5 minutes).
Invalidates cache entry on error.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>url</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manifest URL (defaults to {base_url}/.well-known/asap/manifest.json)</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Manifest (asap.models.entities.Manifest)" href="#asap.models.entities.Manifest">Manifest</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Manifest object</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPConnectionError (asap.transport.client.ASAPConnectionError)" href="#asap.transport.ASAPConnectionError">ASAPConnectionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If HTTP request fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPTimeoutError (asap.transport.client.ASAPTimeoutError)" href="#asap.transport.ASAPTimeoutError">ASAPTimeoutError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If request times out</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If manifest JSON is invalid</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>async with ASAPClient("http://agent.example.com") as client:
...     manifest = await client.get_manifest()
...     print(manifest.id, manifest.name)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/client.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Manifest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get agent manifest from cache or HTTP endpoint.</span>

<span class="sd">    Checks cache first, then fetches from HTTP if not cached or expired.</span>
<span class="sd">    Caches successful responses with TTL (default: 5 minutes).</span>
<span class="sd">    Invalidates cache entry on error.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: Manifest URL (defaults to {base_url}/.well-known/asap/manifest.json)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Manifest object</span>

<span class="sd">    Raises:</span>
<span class="sd">        ASAPConnectionError: If HTTP request fails</span>
<span class="sd">        ASAPTimeoutError: If request times out</span>
<span class="sd">        ValueError: If manifest JSON is invalid</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; async with ASAPClient(&quot;http://agent.example.com&quot;) as client:</span>
<span class="sd">        ...     manifest = await client.get_manifest()</span>
<span class="sd">        ...     print(manifest.id, manifest.name)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_http_base_url</span><span class="si">}</span><span class="s2">/.well-known/asap/manifest.json&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
            <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks_guard</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="n">url_lock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_fetch_locks</span><span class="p">[</span><span class="n">url</span><span class="p">]</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">url_lock</span><span class="p">:</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.manifest_cache_hit&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                <span class="n">manifest_id</span><span class="o">=</span><span class="n">cached</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Manifest cache hit for </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">cached</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;asap.client.manifest_cache_miss&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Manifest cache miss for </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2">, fetching from HTTP&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MANIFEST_REQUEST_TIMEOUT</span><span class="p">),</span>  <span class="c1"># Cap timeout for manifest</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;HTTP error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> fetching manifest from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">manifest_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON in manifest response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;manifest&quot;</span> <span class="ow">in</span> <span class="n">manifest_data</span> <span class="ow">and</span> <span class="s2">&quot;signature&quot;</span> <span class="ow">in</span> <span class="n">manifest_data</span><span class="p">:</span>
                    <span class="n">signed</span> <span class="o">=</span> <span class="n">SignedManifest</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">manifest_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_signatures</span><span class="p">:</span>
                        <span class="n">trusted_b64</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trusted_manifest_keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">trusted_b64</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">SignatureVerificationError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Cannot verify signed manifest from </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
                                <span class="s2">&quot;no trusted public key provided. Pass trusted_manifest_keys &quot;</span>
                                <span class="s2">&quot;to ASAPClient (or disable verify_signatures).&quot;</span><span class="p">,</span>
                                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)},</span>
                            <span class="p">)</span>
                        <span class="n">trusted_key</span> <span class="o">=</span> <span class="n">load_public_key_from_base64</span><span class="p">(</span><span class="n">trusted_b64</span><span class="p">)</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">verify_manifest</span><span class="p">,</span> <span class="n">signed</span><span class="p">,</span> <span class="n">trusted_key</span><span class="p">)</span>
                    <span class="n">manifest</span> <span class="o">=</span> <span class="n">signed</span><span class="o">.</span><span class="n">manifest</span>
                    <span class="n">trust_level</span> <span class="o">=</span> <span class="n">signed</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">trust_level</span><span class="o">.</span><span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">manifest</span> <span class="o">=</span> <span class="n">Manifest</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">manifest_data</span><span class="p">)</span>
                    <span class="n">trust_level</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="n">SignatureVerificationError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid manifest format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.manifest_fetched&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">trust_level</span><span class="o">=</span><span class="n">trust_level</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Manifest fetched and cached for </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; (trust: </span><span class="si">{</span><span class="n">trust_level</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">trust_level</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">manifest</span>

        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ASAPTimeoutError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Manifest request timeout after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ConnectError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Connection error fetching manifest from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ASAPConnectionError</span><span class="p">,</span> <span class="n">ASAPTimeoutError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">SignatureVerificationError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_manifest_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.manifest_error&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unexpected error fetching manifest from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error fetching manifest from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.transport.ASAPClient.health_check" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">health_check</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Check agent health/liveness at the given base URL.</p>
<p>Fetches GET {base_url}/.well-known/asap/health and parses the
response into a HealthStatus model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>base_url</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Agent base URL (e.g. "https://agent.example.com").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="asap.discovery.health.HealthStatus">HealthStatus</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HealthStatus with status, agent_id, version, uptime_seconds, etc.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPConnectionError (asap.transport.client.ASAPConnectionError)" href="#asap.transport.ASAPConnectionError">ASAPConnectionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If client not connected or HTTP request fails.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPTimeoutError (asap.transport.client.ASAPTimeoutError)" href="#asap.transport.ASAPTimeoutError">ASAPTimeoutError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If request times out.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If health response is not valid JSON or schema invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>async with ASAPClient("http://localhost:8000") as client:
...     health = await client.health_check("https://other-agent.example.com")
...     print(health.status, health.uptime_seconds)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/client.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HealthStatus</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check agent health/liveness at the given base URL.</span>

<span class="sd">    Fetches GET {base_url}/.well-known/asap/health and parses the</span>
<span class="sd">    response into a HealthStatus model.</span>

<span class="sd">    Args:</span>
<span class="sd">        base_url: Agent base URL (e.g. &quot;https://agent.example.com&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        HealthStatus with status, agent_id, version, uptime_seconds, etc.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ASAPConnectionError: If client not connected or HTTP request fails.</span>
<span class="sd">        ASAPTimeoutError: If request times out.</span>
<span class="sd">        ValueError: If health response is not valid JSON or schema invalid.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">        ...     health = await client.health_check(&quot;https://other-agent.example.com&quot;)</span>
<span class="sd">        ...     print(health.status, health.uptime_seconds)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">health_url</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">WELLKNOWN_HEALTH_PATH</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
            <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">health_url</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">health_url</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">MANIFEST_REQUEST_TIMEOUT</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;HTTP error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> fetching health from </span><span class="si">{</span><span class="n">health_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">health_url</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON in health response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HealthStatus</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid health response schema: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ASAPTimeoutError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Health request timeout after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ConnectError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Connection error fetching health from </span><span class="si">{</span><span class="n">health_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
            <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">health_url</span><span class="p">),</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">ASAPConnectionError</span><span class="p">,</span> <span class="n">ASAPTimeoutError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s2">&quot;asap.client.health_check_error&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">health_url</span><span class="p">),</span>
            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unexpected error checking health at </span><span class="si">{</span><span class="n">health_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
            <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="n">health_url</span><span class="p">),</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.transport.ASAPClient.send" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">send</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Send an envelope to the remote agent and receive response.</p>
<p>Wraps the envelope in a JSON-RPC 2.0 request, sends it to the
remote agent's /asap endpoint, and unwraps the response.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>envelope</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Envelope (asap.models.envelope.Envelope)" href="#asap.models.envelope.Envelope">Envelope</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ASAP envelope to send</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Envelope (asap.models.envelope.Envelope)" href="#asap.models.envelope.Envelope">Envelope</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response envelope from the remote agent</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If envelope is None</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPConnectionError (asap.transport.client.ASAPConnectionError)" href="#asap.transport.ASAPConnectionError">ASAPConnectionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If connection fails or HTTP error occurs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPTimeoutError (asap.transport.client.ASAPTimeoutError)" href="#asap.transport.ASAPTimeoutError">ASAPTimeoutError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If request times out</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPRemoteError (asap.transport.client.ASAPRemoteError)" href="#asap.transport.ASAPRemoteError">ASAPRemoteError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If remote agent returns JSON-RPC error</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="asap.errors.CircuitOpenError">CircuitOpenError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If circuit breaker is open and request is rejected</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>async with ASAPClient("http://localhost:8000") as client:
...     response = await client.send(envelope)
...     response.payload_type</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/client.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envelope</span><span class="p">:</span> <span class="n">Envelope</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Envelope</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Send an envelope to the remote agent and receive response.</span>

<span class="sd">    Wraps the envelope in a JSON-RPC 2.0 request, sends it to the</span>
<span class="sd">    remote agent&#39;s /asap endpoint, and unwraps the response.</span>

<span class="sd">    Args:</span>
<span class="sd">        envelope: ASAP envelope to send</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response envelope from the remote agent</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If envelope is None</span>
<span class="sd">        ASAPConnectionError: If connection fails or HTTP error occurs</span>
<span class="sd">        ASAPTimeoutError: If request times out</span>
<span class="sd">        ASAPRemoteError: If remote agent returns JSON-RPC error</span>
<span class="sd">        CircuitOpenError: If circuit breaker is open and request is rejected</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">        ...     response = await client.send(envelope)</span>
<span class="sd">        ...     response.payload_type</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">envelope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;envelope cannot be None&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
            <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">can_attempt</span><span class="p">():</span>
            <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">CircuitOpenError</span><span class="p">(</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="o">.</span><span class="n">send_and_receive</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">WebSocketRemoteError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPRemoteError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ASAPTimeoutError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;WebSocket receive timed out after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">can_attempt</span><span class="p">():</span>
        <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">CircuitOpenError</span><span class="p">(</span>
            <span class="n">base_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
            <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="c1"># Generate idempotency key for retries</span>
    <span class="n">idempotency_key</span> <span class="o">=</span> <span class="n">generate_id</span><span class="p">()</span>

    <span class="c1"># Get next request counter value (thread-safe)</span>
    <span class="n">request_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;req-</span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request_counter</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Log send attempt with context (sanitize URL to hide credentials)</span>
    <span class="n">sanitized_url</span> <span class="o">=</span> <span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;asap.client.send&quot;</span><span class="p">,</span>
        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitized_url</span><span class="p">,</span>
        <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">trace_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
        <span class="n">payload_type</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span><span class="p">,</span>
        <span class="n">idempotency_key</span><span class="o">=</span><span class="n">idempotency_key</span><span class="p">,</span>
        <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Sending envelope </span><span class="si">{</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">sanitized_url</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(payload: </span><span class="si">{</span><span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span><span class="si">}</span><span class="s2">, max_retries: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Build JSON-RPC request</span>
    <span class="n">json_rpc_request</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">ASAP_METHOD</span><span class="p">,</span>
        <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;envelope&quot;</span><span class="p">:</span> <span class="n">envelope</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">),</span>
            <span class="s2">&quot;idempotency_key&quot;</span><span class="p">:</span> <span class="n">idempotency_key</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Serialize to bytes for compression</span>
    <span class="n">request_body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_rpc_request</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="c1"># Apply compression if enabled and payload exceeds threshold</span>
    <span class="n">content_encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compression</span><span class="p">:</span>
        <span class="n">compressed_body</span><span class="p">,</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="n">compress_payload</span><span class="p">(</span>
            <span class="n">request_body</span><span class="p">,</span>
            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compression_threshold</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">algorithm</span> <span class="o">!=</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">:</span>
            <span class="n">request_body</span> <span class="o">=</span> <span class="n">compressed_body</span>
            <span class="n">content_encoding</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">value</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.compression_applied&quot;</span><span class="p">,</span>
                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitized_url</span><span class="p">,</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">algorithm</span><span class="o">=</span><span class="n">content_encoding</span><span class="p">,</span>
                <span class="n">original_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_rpc_request</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)),</span>
                <span class="n">compressed_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">request_body</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="c1"># Attempt with retries</span>
    <span class="n">last_exception</span><span class="p">:</span> <span class="ne">Exception</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attempt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">get_metrics</span><span class="p">()</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="s2">&quot;asap_transport_retries_total&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Build headers</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
                <span class="s2">&quot;X-Idempotency-Key&quot;</span><span class="p">:</span> <span class="n">idempotency_key</span><span class="p">,</span>
                <span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="n">get_accept_encoding_header</span><span class="p">(),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">content_encoding</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Encoding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_encoding</span>

            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># HTTP path: __aenter__ set it</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/asap&quot;</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="n">request_body</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Log HTTP protocol version for debugging fallback behavior</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http2</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">http_version</span> <span class="o">!=</span> <span class="s2">&quot;HTTP/2&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.http_fallback&quot;</span><span class="p">,</span>
                    <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                    <span class="n">requested</span><span class="o">=</span><span class="s2">&quot;HTTP/2&quot;</span><span class="p">,</span>
                    <span class="n">actual</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">http_version</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;HTTP/2 requested but used </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">http_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">:</span>
                <span class="c1"># Server errors (5xx) are retriable</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;HTTP server error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Server returned: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_backoff</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.client.retry_server_error&quot;</span><span class="p">,</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                        <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                        <span class="n">delay_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                        <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Server error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="n">last_exception</span> <span class="o">=</span> <span class="n">ASAPConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># All retries exhausted, record failure in circuit breaker</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
                    <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                    <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
                    <span class="c1"># Log state change if circuit opened</span>
                    <span class="k">if</span> <span class="n">previous_state</span> <span class="o">!=</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;asap.client.circuit_opened&quot;</span><span class="p">,</span>
                            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                            <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
                            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker opened after </span><span class="si">{</span><span class="n">consecutive_failures</span><span class="si">}</span><span class="s2"> consecutive failures&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">retry_after</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Retry-After&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">retry_after</span><span class="p">:</span>
                        <span class="n">retry_delay</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="c1"># Retry-After can be seconds (int/float) or HTTP date</span>
                        <span class="c1"># First, try to parse as seconds (numeric)</span>
                        <span class="k">if</span> <span class="n">retry_after</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">retry_delay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">retry_after</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s2">&quot;asap.client.retry_after&quot;</span><span class="p">,</span>
                                    <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">retry_after_seconds</span><span class="o">=</span><span class="n">retry_delay</span><span class="p">,</span>
                                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Respecting server Retry-After: </span><span class="si">{</span><span class="n">retry_delay</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="k">pass</span>  <span class="c1"># Fall through to date parsing</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Try to parse as HTTP date</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">retry_date</span> <span class="o">=</span> <span class="n">parsedate_to_datetime</span><span class="p">(</span><span class="n">retry_after</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">retry_date</span><span class="p">:</span>
                                    <span class="c1"># Calculate delay in seconds from now until retry_date</span>
                                    <span class="n">now_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                                    <span class="n">retry_timestamp</span> <span class="o">=</span> <span class="n">retry_date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                                    <span class="n">calculated_delay</span> <span class="o">=</span> <span class="n">retry_timestamp</span> <span class="o">-</span> <span class="n">now_timestamp</span>
                                    <span class="c1"># If date is in the past or delay is invalid, fall back to calculated backoff</span>
                                    <span class="k">if</span> <span class="n">calculated_delay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">retry_delay</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Will trigger fallback</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">retry_delay</span> <span class="o">=</span> <span class="n">calculated_delay</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                            <span class="s2">&quot;asap.client.retry_after&quot;</span><span class="p">,</span>
                                            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                                            <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                            <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                            <span class="n">retry_after_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                            <span class="n">retry_after_date</span><span class="o">=</span><span class="n">retry_after</span><span class="p">,</span>
                                            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Respecting server Retry-After date: </span><span class="si">{</span><span class="n">retry_after</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">retry_delay</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">,</span>
                                        <span class="p">)</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
                                <span class="c1"># Invalid date format or timestamp conversion error, fall back to calculated backoff</span>
                                <span class="k">pass</span>

                        <span class="c1"># If parsing failed or delay is invalid (None or &lt;= 0), use calculated backoff</span>
                        <span class="k">if</span> <span class="n">retry_delay</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">retry_delay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">retry_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_backoff</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;asap.client.retry_after_invalid&quot;</span><span class="p">,</span>
                                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                <span class="n">retry_after_header</span><span class="o">=</span><span class="n">retry_after</span><span class="p">,</span>
                                <span class="n">fallback_delay</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid Retry-After format, using calculated backoff&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="n">delay</span> <span class="o">=</span> <span class="n">retry_delay</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># No Retry-After header, use calculated backoff</span>
                        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_backoff</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.client.rate_limited&quot;</span><span class="p">,</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="mi">429</span><span class="p">,</span>
                        <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                        <span class="n">delay_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;asap.client.retry&quot;</span><span class="p">,</span>
                        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                        <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                        <span class="n">delay_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="n">last_exception</span> <span class="o">=</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;HTTP rate limit error 429 from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># All retries exhausted, record failure in circuit breaker</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
                    <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                    <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
                    <span class="c1"># Log state change if circuit opened</span>
                    <span class="k">if</span> <span class="n">previous_state</span> <span class="o">!=</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;asap.client.circuit_opened&quot;</span><span class="p">,</span>
                            <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                            <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
                            <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker opened after </span><span class="si">{</span><span class="n">consecutive_failures</span><span class="si">}</span><span class="s2"> consecutive failures (rate limited)&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;HTTP rate limit error 429 from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">:</span>
                <span class="c1"># Client errors (4xx) are not retriable (except 429 handled above)</span>
                <span class="c1"># We record a failure in the circuit breaker here because persistent 4xx</span>
                <span class="c1"># (like 401/403) can indicate an unhealthy configuration or system state.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>

                <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;HTTP client error </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;This indicates a problem with the request. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Server response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="c1"># Parse JSON response</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ASAPRemoteError</span><span class="p">(</span><span class="o">-</span><span class="mi">32700</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Invalid JSON response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">json_response</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_success</span><span class="p">()</span>

                <span class="n">error</span> <span class="o">=</span> <span class="n">json_response</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">ASAPRemoteError</span><span class="p">(</span>
                    <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">32603</span><span class="p">),</span>
                    <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">),</span>
                    <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
                <span class="p">)</span>

            <span class="c1"># Extract envelope from result</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">json_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">envelope_data</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;envelope&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">envelope_data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ASAPRemoteError</span><span class="p">(</span><span class="o">-</span><span class="mi">32603</span><span class="p">,</span> <span class="s2">&quot;Missing envelope in response&quot;</span><span class="p">)</span>

            <span class="n">response_envelope</span> <span class="o">=</span> <span class="n">Envelope</span><span class="p">(</span><span class="o">**</span><span class="n">envelope_data</span><span class="p">)</span>

            <span class="c1"># Record success in circuit breaker</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_success</span><span class="p">()</span>
                <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="c1"># Log state change if circuit was closed</span>
                <span class="k">if</span> <span class="n">previous_state</span> <span class="o">!=</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;asap.client.circuit_closed&quot;</span><span class="p">,</span>
                        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Circuit breaker closed after successful request&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># Calculate duration and log success</span>
            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">duration_ms</span> <span class="o">=</span> <span class="n">duration_seconds</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.response&quot;</span><span class="p">,</span>
                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">response_id</span><span class="o">=</span><span class="n">response_envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">trace_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
                <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">attempts</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="s2">&quot;asap_transport_send_total&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">})</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">observe_histogram</span><span class="p">(</span>
                <span class="s2">&quot;asap_transport_send_duration_seconds&quot;</span><span class="p">,</span>
                <span class="n">duration_seconds</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">response_envelope</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">httpx</span><span class="o">.</span><span class="n">ConnectError</span><span class="p">,</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">is_timeout</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span><span class="p">)</span>
            <span class="n">error_type</span> <span class="o">=</span> <span class="s2">&quot;Timeout&quot;</span> <span class="k">if</span> <span class="n">is_timeout</span> <span class="k">else</span> <span class="s2">&quot;Connection error&quot;</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_timeout</span><span class="p">:</span>
                <span class="n">last_exception</span> <span class="o">=</span> <span class="n">ASAPTimeoutError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Request timeout after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last_exception</span> <span class="o">=</span> <span class="n">ASAPConnectionError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span>

            <span class="c1"># Log retry attempt</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_backoff</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;asap.client.retry&quot;</span><span class="p">,</span>
                    <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="n">delay_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2"> (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">). &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Retrying in </span><span class="si">{</span><span class="n">delay</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># All retries exhausted, record failure in circuit breaker</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
                <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
                <span class="c1"># Log state change if circuit opened</span>
                <span class="k">if</span> <span class="n">previous_state</span> <span class="o">!=</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.client.circuit_opened&quot;</span><span class="p">,</span>
                        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                        <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
                        <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker opened after </span><span class="si">{</span><span class="n">consecutive_failures</span><span class="si">}</span><span class="s2"> consecutive failures&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># Log final failure with detailed context</span>
            <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">error_type_name</span> <span class="o">=</span> <span class="s2">&quot;ASAPTimeoutError&quot;</span> <span class="k">if</span> <span class="n">is_timeout</span> <span class="k">else</span> <span class="s2">&quot;ASAPConnectionError&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.error&quot;</span><span class="p">,</span>
                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2"> after retries&quot;</span><span class="p">,</span>
                <span class="n">error_type</span><span class="o">=</span><span class="n">error_type_name</span><span class="p">,</span>
                <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">attempts</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="k">if</span> <span class="n">is_timeout</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_type</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2"> failed after </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> attempts. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Total duration: </span><span class="si">{</span><span class="n">duration_ms</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Troubleshooting: Verify the agent is running, check network connectivity, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;and ensure the URL is correct. Original error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">last_exception</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">ASAPConnectionError</span><span class="p">,</span> <span class="n">ASAPRemoteError</span><span class="p">,</span> <span class="n">ASAPTimeoutError</span><span class="p">):</span>
            <span class="c1"># Re-raise our custom errors without recording failure again</span>
            <span class="c1"># (failures are already recorded before these exceptions are raised)</span>
            <span class="k">raise</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Record failure in circuit breaker</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">previous_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">record_failure</span><span class="p">()</span>
                <span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
                <span class="n">consecutive_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">get_consecutive_failures</span><span class="p">()</span>
                <span class="c1"># Log state change if circuit opened</span>
                <span class="k">if</span> <span class="n">previous_state</span> <span class="o">!=</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">CircuitState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.client.circuit_opened&quot;</span><span class="p">,</span>
                        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                        <span class="n">consecutive_failures</span><span class="o">=</span><span class="n">consecutive_failures</span><span class="p">,</span>
                        <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_circuit_breaker</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Circuit breaker opened after </span><span class="si">{</span><span class="n">consecutive_failures</span><span class="si">}</span><span class="s2"> consecutive failures&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="c1"># Log unexpected error</span>
            <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;asap.client.error&quot;</span><span class="p">,</span>
                <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">_record_send_error_metrics</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="c1"># Wrap unexpected errors</span>
            <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error connecting to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">if</span> <span class="n">last_exception</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">_record_send_error_metrics</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">last_exception</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">last_exception</span>
    <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Max retries (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">) exceeded for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">. &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Verify the agent is running and accessible.&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
    <span class="p">)</span>  <span class="c1"># pragma: no cover</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.transport.ASAPClient.send_batch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">send_batch</span><span class="p">(</span><span class="n">envelopes</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Send multiple envelopes in parallel using asyncio.gather.</p>
<p>Uses asyncio.gather to send all envelopes concurrently, leveraging
connection pooling and HTTP/2 multiplexing for optimal throughput.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>envelopes</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Envelope (asap.models.envelope.Envelope)" href="#asap.models.envelope.Envelope">Envelope</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of ASAP envelopes to send</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_exceptions</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, exceptions are returned in the result list
instead of being raised. If False (default), the first exception
encountered will be raised.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Envelope (asap.models.envelope.Envelope)" href="#asap.models.envelope.Envelope">Envelope</a> | <span title="BaseException">BaseException</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of response envelopes in the same order as input envelopes.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Envelope (asap.models.envelope.Envelope)" href="#asap.models.envelope.Envelope">Envelope</a> | <span title="BaseException">BaseException</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If return_exceptions=True, failed sends will have the exception</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="Envelope (asap.models.envelope.Envelope)" href="#asap.models.envelope.Envelope">Envelope</a> | <span title="BaseException">BaseException</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>in their position instead of an Envelope.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If envelopes list is empty</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPConnectionError (asap.transport.client.ASAPConnectionError)" href="#asap.transport.ASAPConnectionError">ASAPConnectionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any send fails (when return_exceptions=False)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPTimeoutError (asap.transport.client.ASAPTimeoutError)" href="#asap.transport.ASAPTimeoutError">ASAPTimeoutError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any send times out (when return_exceptions=False)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ASAPRemoteError (asap.transport.client.ASAPRemoteError)" href="#asap.transport.ASAPRemoteError">ASAPRemoteError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any remote agent returns error (when return_exceptions=False)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="asap.errors.CircuitOpenError">CircuitOpenError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If circuit breaker is open (when return_exceptions=False)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>async with ASAPClient("http://localhost:8000") as client:
...     responses = await client.send_batch([env1, env2, env3])
...     for response in responses:
...         print(response.payload_type)</p>
<h5 id="asap.transport.ASAPClient.send_batch--with-error-handling">With error handling</h5>
<p>async with ASAPClient("http://localhost:8000") as client:
...     results = await client.send_batch(envelopes, return_exceptions=True)
...     for i, result in enumerate(results):
...         if isinstance(result, BaseException):
...             print(f"Envelope {i} failed: {result}")
...         else:
...             print(f"Envelope {i} succeeded: {result.id}")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/client.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_batch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">envelopes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Envelope</span><span class="p">],</span>
    <span class="n">return_exceptions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Envelope</span> <span class="o">|</span> <span class="ne">BaseException</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Send multiple envelopes in parallel using asyncio.gather.</span>

<span class="sd">    Uses asyncio.gather to send all envelopes concurrently, leveraging</span>
<span class="sd">    connection pooling and HTTP/2 multiplexing for optimal throughput.</span>

<span class="sd">    Args:</span>
<span class="sd">        envelopes: List of ASAP envelopes to send</span>
<span class="sd">        return_exceptions: If True, exceptions are returned in the result list</span>
<span class="sd">            instead of being raised. If False (default), the first exception</span>
<span class="sd">            encountered will be raised.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of response envelopes in the same order as input envelopes.</span>
<span class="sd">        If return_exceptions=True, failed sends will have the exception</span>
<span class="sd">        in their position instead of an Envelope.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If envelopes list is empty</span>
<span class="sd">        ASAPConnectionError: If any send fails (when return_exceptions=False)</span>
<span class="sd">        ASAPTimeoutError: If any send times out (when return_exceptions=False)</span>
<span class="sd">        ASAPRemoteError: If any remote agent returns error (when return_exceptions=False)</span>
<span class="sd">        CircuitOpenError: If circuit breaker is open (when return_exceptions=False)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">        ...     responses = await client.send_batch([env1, env2, env3])</span>
<span class="sd">        ...     for response in responses:</span>
<span class="sd">        ...         print(response.payload_type)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # With error handling</span>
<span class="sd">        &gt;&gt;&gt; async with ASAPClient(&quot;http://localhost:8000&quot;) as client:</span>
<span class="sd">        ...     results = await client.send_batch(envelopes, return_exceptions=True)</span>
<span class="sd">        ...     for i, result in enumerate(results):</span>
<span class="sd">        ...         if isinstance(result, BaseException):</span>
<span class="sd">        ...             print(f&quot;Envelope {i} failed: {result}&quot;)</span>
<span class="sd">        ...         else:</span>
<span class="sd">        ...             print(f&quot;Envelope {i} succeeded: {result.id}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">envelopes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;envelopes list cannot be empty&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_transport</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;send_batch is not supported with WebSocket transport; use send() in a loop.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ASAPConnectionError</span><span class="p">(</span>
            <span class="s2">&quot;Client not connected. Use &#39;async with&#39; context.&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">envelopes</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;asap.client.send_batch&quot;</span><span class="p">,</span>
        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Sending batch of </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> envelopes to </span><span class="si">{</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="c1"># Create send tasks for all envelopes</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span> <span class="k">for</span> <span class="n">envelope</span> <span class="ow">in</span> <span class="n">envelopes</span><span class="p">]</span>

    <span class="c1"># Execute all tasks concurrently</span>
    <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="n">return_exceptions</span><span class="p">)</span>

    <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>

    <span class="c1"># Count successes and failures</span>
    <span class="k">if</span> <span class="n">return_exceptions</span><span class="p">:</span>
        <span class="n">success_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">Envelope</span><span class="p">))</span>
        <span class="n">failure_count</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">success_count</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">success_count</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="n">failure_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;asap.client.send_batch_complete&quot;</span><span class="p">,</span>
        <span class="n">target_url</span><span class="o">=</span><span class="n">sanitize_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">success_count</span><span class="o">=</span><span class="n">success_count</span><span class="p">,</span>
        <span class="n">failure_count</span><span class="o">=</span><span class="n">failure_count</span><span class="p">,</span>
        <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">throughput_per_second</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">/</span> <span class="p">(</span><span class="n">duration_ms</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">duration_ms</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Batch of </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2"> envelopes completed in </span><span class="si">{</span><span class="n">duration_ms</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">success_count</span><span class="si">}</span><span class="s2"> succeeded, </span><span class="si">{</span><span class="n">failure_count</span><span class="si">}</span><span class="s2"> failed)&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.ASAPConnectionError" class="doc doc-heading">
            <code>ASAPConnectionError</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="Exception">Exception</span></code></p>



        <p>Raised when connection to remote agent fails.</p>
<p>This error occurs when the HTTP connection cannot be established
or when the remote server returns an HTTP error status.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPConnectionError.message">message</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error description with troubleshooting suggestions</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPConnectionError.cause">cause</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original exception that caused this error</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPConnectionError.url">url</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>URL that failed to connect (if available)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/client.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ASAPConnectionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when connection to remote agent fails.</span>

<span class="sd">    This error occurs when the HTTP connection cannot be established</span>
<span class="sd">    or when the remote server returns an HTTP error status.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        message: Error description with troubleshooting suggestions</span>
<span class="sd">        cause: Original exception that caused this error</span>
<span class="sd">        url: URL that failed to connect (if available)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cause</span><span class="p">:</span> <span class="ne">Exception</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Enhance message with troubleshooting suggestions if URL is provided</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">and</span> <span class="s2">&quot;Verify&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">message</span> <span class="ow">and</span> <span class="s2">&quot;troubleshooting&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">enhanced_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Troubleshooting: Connection failed to </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Verify the agent is running and accessible. &quot;</span>
                <span class="s2">&quot;Check the URL format, network connectivity, and firewall settings.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">enhanced_message</span> <span class="o">=</span> <span class="n">message</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">enhanced_message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">enhanced_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cause</span> <span class="o">=</span> <span class="n">cause</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.ASAPRemoteError" class="doc doc-heading">
            <code>ASAPRemoteError</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="Exception">Exception</span></code></p>



        <p>Raised when remote agent returns an error response.</p>
<p>This error occurs when the JSON-RPC response contains an error
object, indicating the remote agent could not process the request.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPRemoteError.code">code</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON-RPC error code</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPRemoteError.message">message</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error message from remote</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPRemoteError.data">data</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional additional error data</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/client.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ASAPRemoteError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when remote agent returns an error response.</span>

<span class="sd">    This error occurs when the JSON-RPC response contains an error</span>
<span class="sd">    object, indicating the remote agent could not process the request.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        code: JSON-RPC error code</span>
<span class="sd">        message: Error message from remote</span>
<span class="sd">        data: Optional additional error data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remote error </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.ASAPRequestHandler" class="doc doc-heading">
            <code>ASAPRequestHandler</code>


</h3>


    <div class="doc doc-contents ">



        <p>Handler for processing ASAP protocol requests.</p>
<p>Encapsulates the logic for:
- Parsing and validating JSON-RPC requests
- Authenticating requests based on manifest configuration
- Validating sender identity
- Dispatching to registered handlers
- Building error responses
- Recording metrics</p>
<p>This class is instantiated by create_app() and used to handle
incoming requests on the /asap endpoint.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPRequestHandler.registry">registry</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Handler registry for payload dispatch</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPRequestHandler.manifest">manifest</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Agent manifest for context</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPRequestHandler.auth_middleware">auth_middleware</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional authentication middleware</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>handler = ASAPRequestHandler(RegistryHolder(registry), manifest, auth_middleware)
response = await handler.handle_message(request)</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/server.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ASAPRequestHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handler for processing ASAP protocol requests.</span>

<span class="sd">    Encapsulates the logic for:</span>
<span class="sd">    - Parsing and validating JSON-RPC requests</span>
<span class="sd">    - Authenticating requests based on manifest configuration</span>
<span class="sd">    - Validating sender identity</span>
<span class="sd">    - Dispatching to registered handlers</span>
<span class="sd">    - Building error responses</span>
<span class="sd">    - Recording metrics</span>

<span class="sd">    This class is instantiated by create_app() and used to handle</span>
<span class="sd">    incoming requests on the /asap endpoint.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        registry: Handler registry for payload dispatch</span>
<span class="sd">        manifest: Agent manifest for context</span>
<span class="sd">        auth_middleware: Optional authentication middleware</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; handler = ASAPRequestHandler(RegistryHolder(registry), manifest, auth_middleware)</span>
<span class="sd">        &gt;&gt;&gt; response = await handler.handle_message(request)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">registry_holder</span><span class="p">:</span> <span class="n">RegistryHolder</span><span class="p">,</span>
        <span class="n">manifest</span><span class="p">:</span> <span class="n">Manifest</span><span class="p">,</span>
        <span class="n">auth_middleware</span><span class="p">:</span> <span class="n">AuthenticationMiddleware</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_request_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MAX_REQUEST_SIZE</span><span class="p">,</span>
        <span class="n">nonce_store</span><span class="p">:</span> <span class="n">NonceStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry_holder</span> <span class="o">=</span> <span class="n">registry_holder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span> <span class="o">=</span> <span class="n">manifest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_middleware</span> <span class="o">=</span> <span class="n">auth_middleware</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span> <span class="o">=</span> <span class="n">max_request_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nonce_store</span> <span class="o">=</span> <span class="n">nonce_store</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_payload_type_for_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry_holder</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">has_handler</span><span class="p">(</span><span class="n">payload_type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">payload_type</span>
        <span class="k">return</span> <span class="s2">&quot;other&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_error_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span><span class="p">:</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="n">JsonRpcErrorResponse</span><span class="p">(</span>
            <span class="n">error</span><span class="o">=</span><span class="n">JsonRpcError</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">),</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">error_response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">record_error_metrics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">metrics</span><span class="p">:</span> <span class="n">MetricsCollector</span><span class="p">,</span>
        <span class="n">payload_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">error_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">duration_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Normalize payload_type to prevent cardinality explosion</span>
        <span class="n">normalized_payload_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_payload_type_for_metrics</span><span class="p">(</span><span class="n">payload_type</span><span class="p">)</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span>
            <span class="s2">&quot;asap_requests_total&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">normalized_payload_type</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span>
            <span class="s2">&quot;asap_requests_error_total&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">normalized_payload_type</span><span class="p">,</span> <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">observe_histogram</span><span class="p">(</span>
            <span class="s2">&quot;asap_request_duration_seconds&quot;</span><span class="p">,</span>
            <span class="n">duration_seconds</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">normalized_payload_type</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># Specific error counters for observability</span>
        <span class="k">if</span> <span class="n">error_type</span> <span class="o">==</span> <span class="s2">&quot;parse_error&quot;</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="s2">&quot;asap_parse_errors_total&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error_type</span> <span class="o">==</span> <span class="s2">&quot;auth_failed&quot;</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="s2">&quot;asap_auth_failures_total&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error_type</span> <span class="o">==</span> <span class="s2">&quot;invalid_timestamp&quot;</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="s2">&quot;asap_invalid_timestamp_total&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error_type</span> <span class="o">==</span> <span class="s2">&quot;invalid_nonce&quot;</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="s2">&quot;asap_invalid_nonce_total&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error_type</span> <span class="o">==</span> <span class="s2">&quot;sender_mismatch&quot;</span><span class="p">:</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="s2">&quot;asap_sender_mismatch_total&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">error_type</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;invalid_envelope&quot;</span><span class="p">,</span>
            <span class="s2">&quot;missing_envelope&quot;</span><span class="p">,</span>
            <span class="s2">&quot;invalid_params&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span><span class="s2">&quot;asap_validation_errors_total&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_envelope</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">RequestContext</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Envelope</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JSONResponse</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">rpc_request</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">rpc_request</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rpc_request</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.request.invalid_params_type&quot;</span><span class="p">,</span>
                <span class="n">params_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">rpc_request</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">INVALID_PARAMS</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;JSON-RPC &#39;params&#39; must be an object&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;received_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">rpc_request</span><span class="o">.</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
                <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                <span class="s2">&quot;invalid_params&quot;</span><span class="p">,</span>
                <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

        <span class="c1"># Extract envelope from params</span>
        <span class="n">envelope_data</span> <span class="o">=</span> <span class="n">rpc_request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;envelope&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">envelope_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.missing_envelope&quot;</span><span class="p">)</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">INVALID_PARAMS</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Missing &#39;envelope&#39; in params&quot;</span><span class="p">},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
                <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                <span class="s2">&quot;missing_envelope&quot;</span><span class="p">,</span>
                <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">envelope_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.request.invalid_envelope_type&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">envelope_data</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">INVALID_PARAMS</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;envelope&#39; must be a JSON object&quot;</span><span class="p">},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
                <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                <span class="s2">&quot;invalid_envelope&quot;</span><span class="p">,</span>
                <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">envelope</span> <span class="o">=</span> <span class="n">Envelope</span><span class="p">(</span><span class="o">**</span><span class="n">envelope_data</span><span class="p">)</span>
            <span class="n">payload_type</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span>
            <span class="k">return</span> <span class="n">envelope</span><span class="p">,</span> <span class="n">payload_type</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid envelope structure&quot;</span><span class="p">,</span>
                <span class="s2">&quot;validation_errors&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">(),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_debug_mode</span><span class="p">():</span>
                <span class="n">log_data</span> <span class="o">=</span> <span class="n">sanitize_for_logging</span><span class="p">(</span><span class="n">log_data</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.invalid_envelope&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_data</span><span class="p">)</span>
            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="s2">&quot;invalid_envelope&quot;</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="p">)</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">INVALID_PARAMS</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid envelope structure&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;validation_errors&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">(),</span>
                <span class="p">},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_dispatch_to_handler</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">envelope</span><span class="p">:</span> <span class="n">Envelope</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">RequestContext</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Envelope</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JSONResponse</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispatch envelope to registered handler.</span>

<span class="sd">        Looks up and executes the handler for the envelope&#39;s payload type.</span>
<span class="sd">        Handles HandlerNotFoundError and converts it to JSON-RPC error response.</span>

<span class="sd">        Args:</span>
<span class="sd">            envelope: Validated ASAP envelope</span>
<span class="sd">            ctx: Request context with rpc_request, start_time, and metrics</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (response_envelope, payload_type) if successful,</span>
<span class="sd">            or (None, error_response) if handler not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload_type</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_envelope</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry_holder</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">dispatch_async</span><span class="p">(</span>
                <span class="n">envelope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">response_envelope</span><span class="p">,</span> <span class="n">payload_type</span>
        <span class="k">except</span> <span class="n">ThreadPoolExhaustedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Thread pool exhausted - service temporarily unavailable</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.request.thread_pool_exhausted&quot;</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">max_threads</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                <span class="n">active_threads</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">active_threads</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Record error metric</span>
            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">,</span> <span class="s2">&quot;thread_pool_exhausted&quot;</span><span class="p">,</span> <span class="n">duration_seconds</span>
            <span class="p">)</span>
            <span class="c1"># Return HTTP 503 Service Unavailable (not JSON-RPC error)</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="n">JSONResponse</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Service Temporarily Unavailable&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>
        <span class="k">except</span> <span class="n">HandlerNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># No handler registered for this payload type</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.request.handler_not_found&quot;</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">payload_type</span><span class="p">,</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Record error metric</span>
            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">,</span> <span class="s2">&quot;handler_not_found&quot;</span><span class="p">,</span> <span class="n">duration_seconds</span>
            <span class="p">)</span>
            <span class="n">handler_error</span> <span class="o">=</span> <span class="n">JsonRpcErrorResponse</span><span class="p">(</span>
                <span class="n">error</span><span class="o">=</span><span class="n">JsonRpcError</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span>
                    <span class="n">METHOD_NOT_FOUND</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">payload_type</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">),</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="n">JSONResponse</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="n">handler_error</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_authenticate_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">RequestContext</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HandlerResult</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_middleware</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">authenticated_agent_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_middleware</span><span class="o">.</span><span class="n">verify_authentication</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">authenticated_agent_id</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">HTTPException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Authentication failed - return JSON-RPC error</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.request.auth_failed&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">detail</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Map HTTP status to JSON-RPC error code</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="n">INVALID_REQUEST</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">401</span> <span class="k">else</span> <span class="n">INVALID_PARAMS</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">error_code</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">detail</span><span class="p">),</span> <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">status_code</span><span class="p">},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span>
                <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                <span class="s2">&quot;auth_failed&quot;</span><span class="p">,</span>
                <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_verify_sender_matches_auth</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">authenticated_agent_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">envelope</span><span class="p">:</span> <span class="n">Envelope</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">RequestContext</span><span class="p">,</span>
        <span class="n">payload_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_middleware</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auth_middleware</span><span class="o">.</span><span class="n">verify_sender_matches_auth</span><span class="p">(</span><span class="n">authenticated_agent_id</span><span class="p">,</span> <span class="n">envelope</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">HTTPException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Sender mismatch - return JSON-RPC error</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.request.sender_mismatch&quot;</span><span class="p">,</span>
                <span class="n">authenticated_agent</span><span class="o">=</span><span class="n">authenticated_agent_id</span><span class="p">,</span>
                <span class="n">envelope_sender</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">INVALID_PARAMS</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">detail</span><span class="p">),</span> <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">status_code</span><span class="p">},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">,</span> <span class="s2">&quot;sender_mismatch&quot;</span><span class="p">,</span> <span class="n">duration_seconds</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">error_response</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_success_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">response_envelope</span><span class="p">:</span> <span class="n">Envelope</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">RequestContext</span><span class="p">,</span>
        <span class="n">payload_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span><span class="p">:</span>
        <span class="n">response_envelope</span> <span class="o">=</span> <span class="n">inject_envelope_trace_context</span><span class="p">(</span><span class="n">response_envelope</span><span class="p">)</span>
        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span>
        <span class="n">duration_ms</span> <span class="o">=</span> <span class="n">duration_seconds</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="c1"># Normalize payload_type to prevent cardinality explosion</span>
        <span class="n">normalized_payload_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_payload_type_for_metrics</span><span class="p">(</span><span class="n">payload_type</span><span class="p">)</span>

        <span class="c1"># Record success metrics</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span>
            <span class="s2">&quot;asap_requests_total&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">normalized_payload_type</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span>
            <span class="s2">&quot;asap_requests_success_total&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">normalized_payload_type</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">observe_histogram</span><span class="p">(</span>
            <span class="s2">&quot;asap_request_duration_seconds&quot;</span><span class="p">,</span>
            <span class="n">duration_seconds</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">normalized_payload_type</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Log successful processing</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.request.processed&quot;</span><span class="p">,</span>
            <span class="n">envelope_id</span><span class="o">=</span><span class="n">response_envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">response_envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">trace_id</span><span class="o">=</span><span class="n">response_envelope</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
            <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
            <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Wrap response in JSON-RPC</span>
        <span class="c1"># JsonRpcResponse requires id to be str | int, not None</span>
        <span class="n">response_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span> <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">rpc_response</span> <span class="o">=</span> <span class="n">JsonRpcResponse</span><span class="p">(</span>
            <span class="n">result</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;envelope&quot;</span><span class="p">:</span> <span class="n">response_envelope</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)},</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">response_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">rpc_response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_internal_error</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span>
        <span class="n">ctx</span><span class="p">:</span> <span class="n">RequestContext</span><span class="p">,</span>
        <span class="n">payload_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span><span class="p">:</span>
        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span>
        <span class="n">duration_ms</span> <span class="o">=</span> <span class="n">duration_seconds</span> <span class="o">*</span> <span class="mi">1000</span>

        <span class="c1"># Record error metrics (normalized to prevent cardinality explosion)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">,</span> <span class="s2">&quot;internal_error&quot;</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="p">)</span>

        <span class="c1"># Always log full error server-side for diagnostics</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s2">&quot;asap.request.error&quot;</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Production: generic error to client; debug: full error and stack trace</span>
        <span class="k">if</span> <span class="n">is_debug_mode</span><span class="p">():</span>
            <span class="n">error_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s2">&quot;traceback&quot;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Internal server error&quot;</span><span class="p">}</span>

        <span class="n">internal_error</span> <span class="o">=</span> <span class="n">JsonRpcErrorResponse</span><span class="p">(</span>
            <span class="n">error</span><span class="o">=</span><span class="n">JsonRpcError</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">INTERNAL_ERROR</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">error_data</span><span class="p">),</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">internal_error</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_request_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_request</span><span class="p">:</span> <span class="n">JsonRpcRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log full JSON-RPC request when ASAP_DEBUG_LOG is enabled (structured JSON).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_debug_log_mode</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">request_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_request</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_debug_mode</span><span class="p">():</span>
            <span class="n">request_dict</span> <span class="o">=</span> <span class="n">sanitize_for_logging</span><span class="p">(</span><span class="n">request_dict</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;asap.request.debug_request&quot;</span><span class="p">,</span> <span class="n">request_json</span><span class="o">=</span><span class="n">request_dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_log_response_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">JSONResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Log full response when ASAP_DEBUG_LOG is enabled (structured JSON).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_debug_log_mode</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_bytes</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
            <span class="c1"># Handle both bytes and memoryview</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">):</span>
                <span class="n">body_bytes</span> <span class="o">=</span> <span class="n">body_bytes</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
            <span class="n">response_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">response_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_raw&quot;</span><span class="p">:</span> <span class="s2">&quot;(unable to decode response body)&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_debug_mode</span><span class="p">():</span>
            <span class="n">response_dict</span> <span class="o">=</span> <span class="n">sanitize_for_logging</span><span class="p">(</span><span class="n">response_dict</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.request.debug_response&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">response_json</span><span class="o">=</span><span class="n">response_dict</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_parse_and_validate_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HandlerResult</span><span class="p">[</span><span class="n">JsonRpcRequest</span><span class="p">]:</span>
        <span class="c1"># Parse JSON body</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_json_body</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HTTPException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># HTTPException (e.g., 413 Payload Too Large) should be returned directly</span>
            <span class="c1"># Don&#39;t convert to JSON-RPC error response</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONResponse</span>

            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JSONResponse</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">detail</span><span class="p">},</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">headers</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Invalid JSON - return parse error</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">PARSE_ERROR</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Create temporary context for metrics (before we have rpc_request)</span>
            <span class="n">temp_metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span><span class="n">temp_metrics</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="s2">&quot;parse_error&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">INVALID_REQUEST</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;JSON-RPC request must be an object&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;received_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">temp_metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span><span class="n">temp_metrics</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="s2">&quot;invalid_request&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

        <span class="n">rpc_request</span><span class="p">,</span> <span class="n">validation_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_jsonrpc_request</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">validation_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span><span class="n">temp_metrics</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="s2">&quot;invalid_request&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">validation_error</span>

        <span class="k">if</span> <span class="n">rpc_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">INTERNAL_ERROR</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Internal validation error&quot;</span><span class="p">},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">temp_metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                <span class="n">temp_metrics</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="s2">&quot;internal_error&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

        <span class="k">return</span> <span class="n">rpc_request</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_request_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">max_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that request size does not exceed maximum.</span>

<span class="sd">        Checks Content-Length header first, then validates actual body size</span>
<span class="sd">        if available. Raises HTTPException(413) if request is too large.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: FastAPI request object</span>
<span class="sd">            max_size: Maximum allowed request size in bytes</span>

<span class="sd">        Raises:</span>
<span class="sd">            HTTPException: If request size exceeds maximum (413 Payload Too Large)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-length&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content_length</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.request.size_exceeded&quot;</span><span class="p">,</span>
                        <span class="n">content_length</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                        <span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="mi">413</span><span class="p">,</span>
                        <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Request size (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> bytes) exceeds maximum (</span><span class="si">{</span><span class="n">max_size</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;asap.request.invalid_content_length&quot;</span><span class="p">,</span> <span class="n">content_length</span><span class="o">=</span><span class="n">content_length</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">parse_json_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse JSON body from request with size validation and decompression.</span>

<span class="sd">        Validates request size before parsing to prevent DoS attacks.</span>
<span class="sd">        Checks both Content-Length header and actual body size.</span>
<span class="sd">        Automatically decompresses gzip/brotli encoded requests.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: FastAPI request object</span>

<span class="sd">        Returns:</span>
<span class="sd">            Parsed JSON body</span>

<span class="sd">        Raises:</span>
<span class="sd">            HTTPException: If request size exceeds maximum (413)</span>
<span class="sd">            HTTPException: If Content-Encoding is unsupported (415)</span>
<span class="sd">            ValueError: If JSON is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">content_encoding</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-encoding&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">supported_encodings</span> <span class="o">=</span> <span class="n">get_supported_encodings</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">content_encoding</span> <span class="ow">and</span> <span class="n">content_encoding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_encodings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.request.unsupported_encoding&quot;</span><span class="p">,</span>
                <span class="n">content_encoding</span><span class="o">=</span><span class="n">content_encoding</span><span class="p">,</span>
                <span class="n">supported</span><span class="o">=</span><span class="n">supported_encodings</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">415</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unsupported Content-Encoding: </span><span class="si">{</span><span class="n">content_encoding</span><span class="si">}</span><span class="s2">. Supported: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_supported_encodings</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">body_bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">stream</span><span class="p">():</span>
                <span class="n">body_bytes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.request.size_exceeded&quot;</span><span class="p">,</span>
                        <span class="n">actual_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">),</span>
                        <span class="n">max_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="mi">413</span><span class="p">,</span>
                        <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Request size (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes) exceeds maximum (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># Decompress if Content-Encoding is specified</span>
            <span class="k">if</span> <span class="n">content_encoding</span> <span class="ow">and</span> <span class="n">content_encoding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">compressed_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">)</span>
                    <span class="n">body_bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">decompress_payload</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">),</span> <span class="n">content_encoding</span><span class="p">))</span>
                    <span class="n">decompressed_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;asap.request.decompressed&quot;</span><span class="p">,</span>
                        <span class="n">content_encoding</span><span class="o">=</span><span class="n">content_encoding</span><span class="p">,</span>
                        <span class="n">compressed_size</span><span class="o">=</span><span class="n">compressed_size</span><span class="p">,</span>
                        <span class="n">decompressed_size</span><span class="o">=</span><span class="n">decompressed_size</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">decompressed_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="p">:</span>
                        <span class="n">compression_ratio</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">decompressed_size</span> <span class="o">/</span> <span class="n">compressed_size</span> <span class="k">if</span> <span class="n">compressed_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;asap.request.decompressed_size_exceeded&quot;</span><span class="p">,</span>
                            <span class="n">decompressed_size</span><span class="o">=</span><span class="n">decompressed_size</span><span class="p">,</span>
                            <span class="n">original_compressed_size</span><span class="o">=</span><span class="n">compressed_size</span><span class="p">,</span>
                            <span class="n">compression_ratio</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">compression_ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="n">max_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                            <span class="n">status_code</span><span class="o">=</span><span class="mi">413</span><span class="p">,</span>
                            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Decompressed request size (</span><span class="si">{</span><span class="n">decompressed_size</span><span class="si">}</span><span class="s2"> bytes) exceeds maximum (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Decompression failed (invalid compressed data or unsupported encoding)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.request.decompression_failed&quot;</span><span class="p">,</span>
                        <span class="n">content_encoding</span><span class="o">=</span><span class="n">content_encoding</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                        <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to decompress request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Invalid gzip/brotli data (OSError) or truncated data (EOFError)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.request.invalid_compressed_data&quot;</span><span class="p">,</span>
                        <span class="n">content_encoding</span><span class="o">=</span><span class="n">content_encoding</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                        <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid compressed data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

            <span class="c1"># Parse JSON from bytes</span>
            <span class="n">body</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">body</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.invalid_encoding&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid UTF-8 encoding: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.invalid_json&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_jsonrpc_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">JsonRpcRequest</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JSONResponse</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate JSON-RPC request structure and method.</span>

<span class="sd">        Args:</span>
<span class="sd">            body: Parsed JSON body</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (JsonRpcRequest, None) if valid, or (None, error_response) if invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rpc_request</span> <span class="o">=</span> <span class="n">JsonRpcRequest</span><span class="p">(</span><span class="o">**</span><span class="n">body</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="n">INVALID_REQUEST</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Invalid JSON-RPC structure&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
                <span class="c1"># If params validation failed with dict_type error, use INVALID_PARAMS</span>
                <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;loc&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">,)</span> <span class="ow">and</span> <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;dict_type&quot;</span><span class="p">:</span>
                        <span class="n">error_code</span> <span class="o">=</span> <span class="n">INVALID_PARAMS</span>
                        <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;JSON-RPC &#39;params&#39; must be an object&quot;</span>
                        <span class="k">break</span>

            <span class="n">log_struct</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_message</span><span class="p">,</span>
                <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s2">&quot;validation_errors&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">)</span>
                    <span class="k">else</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;type_error&quot;</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">(),</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]</span>
                <span class="p">),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_debug_mode</span><span class="p">():</span>
                <span class="n">log_struct</span> <span class="o">=</span> <span class="n">sanitize_for_logging</span><span class="p">(</span><span class="n">log_struct</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.invalid_structure&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_struct</span><span class="p">)</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">error_code</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_message</span><span class="p">,</span>
                    <span class="s2">&quot;validation_errors&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">)</span>
                        <span class="k">else</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;type_error&quot;</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">(),</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]</span>
                    <span class="p">),</span>
                <span class="p">},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

        <span class="k">if</span> <span class="n">rpc_request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="n">ASAP_METHOD</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.unknown_method&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">rpc_request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                <span class="n">METHOD_NOT_FOUND</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">rpc_request</span><span class="o">.</span><span class="n">method</span><span class="p">},</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">rpc_request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

        <span class="k">return</span> <span class="n">rpc_request</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle ASAP messages wrapped in JSON-RPC 2.0.</span>

<span class="sd">        This method:</span>
<span class="sd">        1. Receives JSON-RPC wrapped ASAP envelopes</span>
<span class="sd">        2. Validates the request structure</span>
<span class="sd">        3. Extracts and processes the ASAP envelope</span>
<span class="sd">        4. Returns response wrapped in JSON-RPC</span>
<span class="sd">        5. Records metrics for observability</span>

<span class="sd">        Args:</span>
<span class="sd">            request: FastAPI request object with JSON body</span>

<span class="sd">        Returns:</span>
<span class="sd">            JSON-RPC response or error response</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; response = await handler.handle_message(request)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
        <span class="n">payload_type</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">parse_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_and_validate_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">rpc_request</span><span class="p">,</span> <span class="n">parse_error</span> <span class="o">=</span> <span class="n">parse_result</span>
            <span class="k">if</span> <span class="n">parse_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">parse_error</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">parse_error</span>
            <span class="k">if</span> <span class="n">rpc_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal error: rpc_request is None after validation&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log_request_debug</span><span class="p">(</span><span class="n">rpc_request</span><span class="p">)</span>

            <span class="n">ctx</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span>
                <span class="n">request_id</span><span class="o">=</span><span class="n">rpc_request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                <span class="n">rpc_request</span><span class="o">=</span><span class="n">rpc_request</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">auth_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticate_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
            <span class="n">authenticated_agent_id</span><span class="p">,</span> <span class="n">auth_error</span> <span class="o">=</span> <span class="n">auth_result</span>
            <span class="k">if</span> <span class="n">auth_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">auth_error</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">auth_error</span>

            <span class="n">envelope_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_envelope</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
            <span class="n">envelope_or_none</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">envelope_result</span>
            <span class="k">if</span> <span class="n">envelope_or_none</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">error_resp</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">JSONResponse</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">error_resp</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">error_resp</span>
            <span class="n">envelope</span> <span class="o">=</span> <span class="n">envelope_or_none</span>
            <span class="n">payload_type</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

            <span class="n">trace_token</span> <span class="o">=</span> <span class="n">extract_and_activate_envelope_trace_context</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sender_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_sender_matches_auth</span><span class="p">(</span>
                    <span class="n">authenticated_agent_id</span><span class="p">,</span>
                    <span class="n">envelope</span><span class="p">,</span>
                    <span class="n">ctx</span><span class="p">,</span>
                    <span class="n">payload_type</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">sender_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">sender_error</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">sender_error</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">validate_envelope_timestamp</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InvalidTimestampError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log_ts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;envelope_id&quot;</span><span class="p">:</span> <span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                        <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_debug_mode</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">log_ts</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sanitize_for_logging</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.invalid_timestamp&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_ts</span><span class="p">)</span>
                    <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">,</span> <span class="s2">&quot;invalid_timestamp&quot;</span><span class="p">,</span> <span class="n">duration_seconds</span>
                    <span class="p">)</span>
                    <span class="n">err_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                        <span class="n">INVALID_PARAMS</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid envelope timestamp&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">err_resp</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">err_resp</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">validate_envelope_nonce</span><span class="p">(</span><span class="n">envelope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce_store</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">InvalidNonceError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Sanitize nonce in logs to prevent full value exposure</span>
                    <span class="n">nonce_sanitized</span> <span class="o">=</span> <span class="n">sanitize_nonce</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span> <span class="k">if</span> <span class="n">is_debug_mode</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;Duplicate nonce detected&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.request.invalid_nonce&quot;</span><span class="p">,</span>
                        <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">nonce</span><span class="o">=</span><span class="n">nonce_sanitized</span><span class="p">,</span>
                        <span class="n">error</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">,</span> <span class="s2">&quot;invalid_nonce&quot;</span><span class="p">,</span> <span class="n">duration_seconds</span>
                    <span class="p">)</span>
                    <span class="n">err_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                        <span class="n">INVALID_PARAMS</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid envelope nonce&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                        <span class="p">},</span>
                        <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">err_resp</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">err_resp</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;asap.request.received&quot;</span><span class="p">,</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">trace_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
                    <span class="n">payload_type</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span><span class="p">,</span>
                    <span class="n">sender</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
                    <span class="n">recipient</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">recipient</span><span class="p">,</span>
                    <span class="n">authenticated</span><span class="o">=</span><span class="n">authenticated_agent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">dispatch_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_to_handler</span><span class="p">(</span><span class="n">envelope</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
                <span class="n">response_or_none</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">dispatch_result</span>
                <span class="k">if</span> <span class="n">response_or_none</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">error_resp</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">JSONResponse</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">error_resp</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">error_resp</span>
                <span class="n">response_envelope</span> <span class="o">=</span> <span class="n">response_or_none</span>
                <span class="n">payload_type</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

                <span class="n">success_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_success_response</span><span class="p">(</span><span class="n">response_envelope</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">success_resp</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">success_resp</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="n">trace_token</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Create minimal context for error handling if we don&#39;t have rpc_request yet</span>
            <span class="k">if</span> <span class="s2">&quot;ctx&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="c1"># Fallback: create context with minimal info</span>
                <span class="n">temp_metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
                <span class="c1"># JsonRpcRequest requires id to be str | int, use empty string as fallback</span>
                <span class="n">temp_rpc_request</span> <span class="o">=</span> <span class="n">JsonRpcRequest</span><span class="p">(</span>
                    <span class="n">jsonrpc</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">ASAP_METHOD</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                <span class="p">)</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span>
                    <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                    <span class="n">metrics</span><span class="o">=</span><span class="n">temp_metrics</span><span class="p">,</span>
                    <span class="n">rpc_request</span><span class="o">=</span><span class="n">temp_rpc_request</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">err_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_internal_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">err_resp</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">err_resp</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.transport.ASAPRequestHandler.handle_message" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_message</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Handle ASAP messages wrapped in JSON-RPC 2.0.</p>
<p>This method:
1. Receives JSON-RPC wrapped ASAP envelopes
2. Validates the request structure
3. Extracts and processes the ASAP envelope
4. Returns response wrapped in JSON-RPC
5. Records metrics for observability</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><span title="fastapi.Request">Request</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>FastAPI request object with JSON body</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="fastapi.responses.JSONResponse">JSONResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON-RPC response or error response</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>response = await handler.handle_message(request)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle ASAP messages wrapped in JSON-RPC 2.0.</span>

<span class="sd">    This method:</span>
<span class="sd">    1. Receives JSON-RPC wrapped ASAP envelopes</span>
<span class="sd">    2. Validates the request structure</span>
<span class="sd">    3. Extracts and processes the ASAP envelope</span>
<span class="sd">    4. Returns response wrapped in JSON-RPC</span>
<span class="sd">    5. Records metrics for observability</span>

<span class="sd">    Args:</span>
<span class="sd">        request: FastAPI request object with JSON body</span>

<span class="sd">    Returns:</span>
<span class="sd">        JSON-RPC response or error response</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; response = await handler.handle_message(request)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
    <span class="n">payload_type</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">parse_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_and_validate_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">rpc_request</span><span class="p">,</span> <span class="n">parse_error</span> <span class="o">=</span> <span class="n">parse_result</span>
        <span class="k">if</span> <span class="n">parse_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">parse_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">parse_error</span>
        <span class="k">if</span> <span class="n">rpc_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Internal error: rpc_request is None after validation&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_request_debug</span><span class="p">(</span><span class="n">rpc_request</span><span class="p">)</span>

        <span class="n">ctx</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">rpc_request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
            <span class="n">rpc_request</span><span class="o">=</span><span class="n">rpc_request</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">auth_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authenticate_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
        <span class="n">authenticated_agent_id</span><span class="p">,</span> <span class="n">auth_error</span> <span class="o">=</span> <span class="n">auth_result</span>
        <span class="k">if</span> <span class="n">auth_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">auth_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">auth_error</span>

        <span class="n">envelope_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_envelope</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="n">envelope_or_none</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">envelope_result</span>
        <span class="k">if</span> <span class="n">envelope_or_none</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_resp</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">JSONResponse</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">error_resp</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">error_resp</span>
        <span class="n">envelope</span> <span class="o">=</span> <span class="n">envelope_or_none</span>
        <span class="n">payload_type</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="n">trace_token</span> <span class="o">=</span> <span class="n">extract_and_activate_envelope_trace_context</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sender_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_sender_matches_auth</span><span class="p">(</span>
                <span class="n">authenticated_agent_id</span><span class="p">,</span>
                <span class="n">envelope</span><span class="p">,</span>
                <span class="n">ctx</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sender_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">sender_error</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">sender_error</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">validate_envelope_timestamp</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InvalidTimestampError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log_ts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;envelope_id&quot;</span><span class="p">:</span> <span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_debug_mode</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">log_ts</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sanitize_for_logging</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.invalid_timestamp&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_ts</span><span class="p">)</span>
                <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">,</span> <span class="s2">&quot;invalid_timestamp&quot;</span><span class="p">,</span> <span class="n">duration_seconds</span>
                <span class="p">)</span>
                <span class="n">err_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                    <span class="n">INVALID_PARAMS</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid envelope timestamp&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                        <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">err_resp</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">err_resp</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">validate_envelope_nonce</span><span class="p">(</span><span class="n">envelope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce_store</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InvalidNonceError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Sanitize nonce in logs to prevent full value exposure</span>
                <span class="n">nonce_sanitized</span> <span class="o">=</span> <span class="n">sanitize_nonce</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span> <span class="k">if</span> <span class="n">is_debug_mode</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;Duplicate nonce detected&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;asap.request.invalid_nonce&quot;</span><span class="p">,</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">nonce</span><span class="o">=</span><span class="n">nonce_sanitized</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">ctx</span><span class="o">.</span><span class="n">start_time</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">record_error_metrics</span><span class="p">(</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">,</span> <span class="s2">&quot;invalid_nonce&quot;</span><span class="p">,</span> <span class="n">duration_seconds</span>
                <span class="p">)</span>
                <span class="n">err_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
                    <span class="n">INVALID_PARAMS</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid envelope nonce&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                        <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">details</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">request_id</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">err_resp</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">err_resp</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;asap.request.received&quot;</span><span class="p">,</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">trace_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
                <span class="n">recipient</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">recipient</span><span class="p">,</span>
                <span class="n">authenticated</span><span class="o">=</span><span class="n">authenticated_agent_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">dispatch_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_to_handler</span><span class="p">(</span><span class="n">envelope</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
            <span class="n">response_or_none</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">dispatch_result</span>
            <span class="k">if</span> <span class="n">response_or_none</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">error_resp</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">JSONResponse</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">error_resp</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">error_resp</span>
            <span class="n">response_envelope</span> <span class="o">=</span> <span class="n">response_or_none</span>
            <span class="n">payload_type</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

            <span class="n">success_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_success_response</span><span class="p">(</span><span class="n">response_envelope</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">success_resp</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success_resp</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">detach</span><span class="p">(</span><span class="n">trace_token</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Create minimal context for error handling if we don&#39;t have rpc_request yet</span>
        <span class="k">if</span> <span class="s2">&quot;ctx&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="c1"># Fallback: create context with minimal info</span>
            <span class="n">temp_metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
            <span class="c1"># JsonRpcRequest requires id to be str | int, use empty string as fallback</span>
            <span class="n">temp_rpc_request</span> <span class="o">=</span> <span class="n">JsonRpcRequest</span><span class="p">(</span>
                <span class="n">jsonrpc</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">ASAP_METHOD</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span>
                <span class="n">request_id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                <span class="n">metrics</span><span class="o">=</span><span class="n">temp_metrics</span><span class="p">,</span>
                <span class="n">rpc_request</span><span class="o">=</span><span class="n">temp_rpc_request</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">err_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_internal_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_response_debug</span><span class="p">(</span><span class="n">err_resp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">err_resp</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.transport.ASAPRequestHandler.parse_json_body" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_json_body</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Parse JSON body from request with size validation and decompression.</p>
<p>Validates request size before parsing to prevent DoS attacks.
Checks both Content-Length header and actual body size.
Automatically decompresses gzip/brotli encoded requests.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><span title="fastapi.Request">Request</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>FastAPI request object</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parsed JSON body</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="fastapi.HTTPException">HTTPException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If request size exceeds maximum (413)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="fastapi.HTTPException">HTTPException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If Content-Encoding is unsupported (415)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If JSON is invalid</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">parse_json_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse JSON body from request with size validation and decompression.</span>

<span class="sd">    Validates request size before parsing to prevent DoS attacks.</span>
<span class="sd">    Checks both Content-Length header and actual body size.</span>
<span class="sd">    Automatically decompresses gzip/brotli encoded requests.</span>

<span class="sd">    Args:</span>
<span class="sd">        request: FastAPI request object</span>

<span class="sd">    Returns:</span>
<span class="sd">        Parsed JSON body</span>

<span class="sd">    Raises:</span>
<span class="sd">        HTTPException: If request size exceeds maximum (413)</span>
<span class="sd">        HTTPException: If Content-Encoding is unsupported (415)</span>
<span class="sd">        ValueError: If JSON is invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">content_encoding</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-encoding&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">supported_encodings</span> <span class="o">=</span> <span class="n">get_supported_encodings</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">content_encoding</span> <span class="ow">and</span> <span class="n">content_encoding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_encodings</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;asap.request.unsupported_encoding&quot;</span><span class="p">,</span>
            <span class="n">content_encoding</span><span class="o">=</span><span class="n">content_encoding</span><span class="p">,</span>
            <span class="n">supported</span><span class="o">=</span><span class="n">supported_encodings</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">415</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unsupported Content-Encoding: </span><span class="si">{</span><span class="n">content_encoding</span><span class="si">}</span><span class="s2">. Supported: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_supported_encodings</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">body_bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">stream</span><span class="p">():</span>
            <span class="n">body_bytes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;asap.request.size_exceeded&quot;</span><span class="p">,</span>
                    <span class="n">actual_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">),</span>
                    <span class="n">max_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="mi">413</span><span class="p">,</span>
                    <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Request size (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes) exceeds maximum (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Decompress if Content-Encoding is specified</span>
        <span class="k">if</span> <span class="n">content_encoding</span> <span class="ow">and</span> <span class="n">content_encoding</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">compressed_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">)</span>
                <span class="n">body_bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">decompress_payload</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">),</span> <span class="n">content_encoding</span><span class="p">))</span>
                <span class="n">decompressed_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">body_bytes</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;asap.request.decompressed&quot;</span><span class="p">,</span>
                    <span class="n">content_encoding</span><span class="o">=</span><span class="n">content_encoding</span><span class="p">,</span>
                    <span class="n">compressed_size</span><span class="o">=</span><span class="n">compressed_size</span><span class="p">,</span>
                    <span class="n">decompressed_size</span><span class="o">=</span><span class="n">decompressed_size</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">decompressed_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="p">:</span>
                    <span class="n">compression_ratio</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">decompressed_size</span> <span class="o">/</span> <span class="n">compressed_size</span> <span class="k">if</span> <span class="n">compressed_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;asap.request.decompressed_size_exceeded&quot;</span><span class="p">,</span>
                        <span class="n">decompressed_size</span><span class="o">=</span><span class="n">decompressed_size</span><span class="p">,</span>
                        <span class="n">original_compressed_size</span><span class="o">=</span><span class="n">compressed_size</span><span class="p">,</span>
                        <span class="n">compression_ratio</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">compression_ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="n">max_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                        <span class="n">status_code</span><span class="o">=</span><span class="mi">413</span><span class="p">,</span>
                        <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Decompressed request size (</span><span class="si">{</span><span class="n">decompressed_size</span><span class="si">}</span><span class="s2"> bytes) exceeds maximum (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_request_size</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Decompression failed (invalid compressed data or unsupported encoding)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;asap.request.decompression_failed&quot;</span><span class="p">,</span>
                    <span class="n">content_encoding</span><span class="o">=</span><span class="n">content_encoding</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                    <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Failed to decompress request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Invalid gzip/brotli data (OSError) or truncated data (EOFError)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;asap.request.invalid_compressed_data&quot;</span><span class="p">,</span>
                    <span class="n">content_encoding</span><span class="o">=</span><span class="n">content_encoding</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                    <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid compressed data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="c1"># Parse JSON from bytes</span>
        <span class="n">body</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">body</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.invalid_encoding&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid UTF-8 encoding: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.invalid_json&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.transport.ASAPRequestHandler.validate_jsonrpc_request" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_jsonrpc_request</span><span class="p">(</span><span class="n">body</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Validate JSON-RPC request structure and method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>body</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parsed JSON body</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<a class="autorefs autorefs-internal" title="JsonRpcRequest (asap.transport.jsonrpc.JsonRpcRequest)" href="#asap.transport.JsonRpcRequest">JsonRpcRequest</a> | None, <span title="fastapi.responses.JSONResponse">JSONResponse</span> | None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (JsonRpcRequest, None) if valid, or (None, error_response) if invalid</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_jsonrpc_request</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">JsonRpcRequest</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">JSONResponse</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate JSON-RPC request structure and method.</span>

<span class="sd">    Args:</span>
<span class="sd">        body: Parsed JSON body</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (JsonRpcRequest, None) if valid, or (None, error_response) if invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rpc_request</span> <span class="o">=</span> <span class="n">JsonRpcRequest</span><span class="p">(</span><span class="o">**</span><span class="n">body</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">ValidationError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="n">INVALID_REQUEST</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Invalid JSON-RPC structure&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
            <span class="c1"># If params validation failed with dict_type error, use INVALID_PARAMS</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;loc&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">,)</span> <span class="ow">and</span> <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;dict_type&quot;</span><span class="p">:</span>
                    <span class="n">error_code</span> <span class="o">=</span> <span class="n">INVALID_PARAMS</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;JSON-RPC &#39;params&#39; must be an object&quot;</span>
                    <span class="k">break</span>

        <span class="n">log_struct</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_message</span><span class="p">,</span>
            <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;validation_errors&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;type_error&quot;</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">(),</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]</span>
            <span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_debug_mode</span><span class="p">():</span>
            <span class="n">log_struct</span> <span class="o">=</span> <span class="n">sanitize_for_logging</span><span class="p">(</span><span class="n">log_struct</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.invalid_structure&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">log_struct</span><span class="p">)</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
            <span class="n">error_code</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_message</span><span class="p">,</span>
                <span class="s2">&quot;validation_errors&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">)</span>
                    <span class="k">else</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;type_error&quot;</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="p">(),</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]</span>
                <span class="p">),</span>
            <span class="p">},</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">body</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

    <span class="k">if</span> <span class="n">rpc_request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="n">ASAP_METHOD</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;asap.request.unknown_method&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">rpc_request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
        <span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_error_response</span><span class="p">(</span>
            <span class="n">METHOD_NOT_FOUND</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">rpc_request</span><span class="o">.</span><span class="n">method</span><span class="p">},</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">rpc_request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">error_response</span>

    <span class="k">return</span> <span class="n">rpc_request</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.ASAPTimeoutError" class="doc doc-heading">
            <code>ASAPTimeoutError</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="Exception">Exception</span></code></p>



        <p>Raised when request to remote agent times out.</p>
<p>This error occurs when the HTTP request exceeds the configured
timeout duration.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPTimeoutError.message">message</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error description</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ASAPTimeoutError.timeout">timeout</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeout value in seconds</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/client.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ASAPTimeoutError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when request to remote agent times out.</span>

<span class="sd">    This error occurs when the HTTP request exceeds the configured</span>
<span class="sd">    timeout duration.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        message: Error description</span>
<span class="sd">        timeout: Timeout value in seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.CompressionAlgorithm" class="doc doc-heading">
            <code>CompressionAlgorithm</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="str">str</span></code>, <code><span title="enum.Enum">Enum</span></code></p>



        <p>Supported compression algorithms.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/compression.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompressionAlgorithm</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Supported compression algorithms.&quot;&quot;&quot;</span>

    <span class="n">GZIP</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span>
    <span class="n">BROTLI</span> <span class="o">=</span> <span class="s2">&quot;br&quot;</span>
    <span class="n">IDENTITY</span> <span class="o">=</span> <span class="s2">&quot;identity&quot;</span>  <span class="c1"># No compression</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.DeadLetterEntry" class="doc doc-heading">
            <code>DeadLetterEntry</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">



        <p>Permanently failed webhook: url, payload, last_result, attempts, created_at.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/webhook.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DeadLetterEntry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Permanently failed webhook: url, payload, last_result, attempts, created_at.&quot;&quot;&quot;</span>

    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">last_result</span><span class="p">:</span> <span class="n">WebhookResult</span>
    <span class="n">attempts</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.HandlerNotFoundError" class="doc doc-heading">
            <code>HandlerNotFoundError</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="asap.errors.ASAPError">ASAPError</span></code></p>



        <p>Raised when no handler is registered for a payload type.</p>
<p>This error occurs when attempting to dispatch an envelope with
a payload_type that has no registered handler.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.HandlerNotFoundError.payload_type">payload_type</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The payload type that has no handler</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>try:
...     raise HandlerNotFoundError("task.request")
... except HandlerNotFoundError as exc:
...     exc.payload_type
'task.request'</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/handlers.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HandlerNotFoundError</span><span class="p">(</span><span class="n">ASAPError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when no handler is registered for a payload type.</span>

<span class="sd">    This error occurs when attempting to dispatch an envelope with</span>
<span class="sd">    a payload_type that has no registered handler.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        payload_type: The payload type that has no handler</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; try:</span>
<span class="sd">        ...     raise HandlerNotFoundError(&quot;task.request&quot;)</span>
<span class="sd">        ... except HandlerNotFoundError as exc:</span>
<span class="sd">        ...     exc.payload_type</span>
<span class="sd">        &#39;task.request&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No handler registered for payload type: </span><span class="si">{</span><span class="n">payload_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="s2">&quot;asap:transport/handler_not_found&quot;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">payload_type</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payload_type</span> <span class="o">=</span> <span class="n">payload_type</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.HandlerRegistry" class="doc doc-heading">
            <code>HandlerRegistry</code>


</h3>


    <div class="doc doc-contents ">



        <p>Registry for ASAP payload handlers.</p>
<p>HandlerRegistry manages the mapping between payload types and their
corresponding handlers. It provides methods for registration, dispatch,
and discovery of handlers.</p>


<details class="thread-safety" open>
  <summary>Thread Safety</summary>
  <p>All public methods are thread-safe. The registry uses an internal
RLock to protect concurrent access to the handler mapping. This
allows safe concurrent registration and dispatch operations from
multiple threads.</p>
</details>

<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.HandlerRegistry._handlers">_handlers</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="asap.transport.handlers.Handler">Handler</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Internal mapping of payload_type to handler function</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.HandlerRegistry._lock">_lock</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reentrant lock for thread-safe operations</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.HandlerRegistry._executor">_executor</span></code></td>
            <td>
                  <code><span title="concurrent.futures.Executor">Executor</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional executor for running sync handlers (for DoS prevention)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>registry = HandlerRegistry()
registry.register("task.request", my_handler)
registry.has_handler("task.request")
True
response = registry.dispatch(envelope, manifest)</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/handlers.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HandlerRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registry for ASAP payload handlers.</span>

<span class="sd">    HandlerRegistry manages the mapping between payload types and their</span>
<span class="sd">    corresponding handlers. It provides methods for registration, dispatch,</span>
<span class="sd">    and discovery of handlers.</span>

<span class="sd">    Thread Safety:</span>
<span class="sd">        All public methods are thread-safe. The registry uses an internal</span>
<span class="sd">        RLock to protect concurrent access to the handler mapping. This</span>
<span class="sd">        allows safe concurrent registration and dispatch operations from</span>
<span class="sd">        multiple threads.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _handlers: Internal mapping of payload_type to handler function</span>
<span class="sd">        _lock: Reentrant lock for thread-safe operations</span>
<span class="sd">        _executor: Optional executor for running sync handlers (for DoS prevention)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; registry = HandlerRegistry()</span>
<span class="sd">        &gt;&gt;&gt; registry.register(&quot;task.request&quot;, my_handler)</span>
<span class="sd">        &gt;&gt;&gt; registry.has_handler(&quot;task.request&quot;)</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; response = registry.dispatch(envelope, manifest)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">executor</span><span class="p">:</span> <span class="n">Executor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">metering_store</span><span class="p">:</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Handler</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="p">:</span> <span class="n">Executor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">executor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metering_store</span> <span class="o">=</span> <span class="n">metering_store</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Handler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">validate_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">is_override</span> <span class="o">=</span> <span class="n">payload_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">payload_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;asap.handler.registered&quot;</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                <span class="n">handler_name</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">handler</span><span class="p">),</span>
                <span class="n">is_override</span><span class="o">=</span><span class="n">is_override</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">payload_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_metering_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set MeteringStore for usage recording (optional).</span>

<span class="sd">        When set, task.request completions are recorded to the store.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metering_store</span> <span class="o">=</span> <span class="n">store</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envelope</span><span class="p">:</span> <span class="n">Envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">:</span> <span class="n">Manifest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Envelope</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispatch an envelope to its registered handler.</span>

<span class="sd">        Looks up the handler for the envelope&#39;s payload_type and</span>
<span class="sd">        invokes it with the envelope and manifest.</span>

<span class="sd">        This method is thread-safe for handler lookup. The handler</span>
<span class="sd">        execution itself is not protected by the lock.</span>

<span class="sd">        Args:</span>
<span class="sd">            envelope: The incoming ASAP envelope</span>
<span class="sd">            manifest: The server&#39;s manifest for context</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response envelope from the handler</span>

<span class="sd">        Raises:</span>
<span class="sd">            HandlerNotFoundError: If no handler is registered for the payload type</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; registry = create_default_registry()</span>
<span class="sd">            &gt;&gt;&gt; response = registry.dispatch(envelope, manifest)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload_type</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">payload_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;asap.handler.not_found&quot;</span><span class="p">,</span>
                    <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">HandlerNotFoundError</span><span class="p">(</span><span class="n">payload_type</span><span class="p">)</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">payload_type</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;asap.handler.dispatch&quot;</span><span class="p">,</span>
            <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
            <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">handler_name</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">handler</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isawaitable</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutine</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Handler </span><span class="si">{</span><span class="n">handler</span><span class="si">}</span><span class="s2"> returned awaitable in sync dispatch(). &quot;</span>
                    <span class="s2">&quot;Use dispatch_async() for async handlers.&quot;</span>
                <span class="p">)</span>
            <span class="n">response</span><span class="p">:</span> <span class="n">Envelope</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;asap.handler.completed&quot;</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">response_id</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;asap.handler.error&quot;</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envelope</span><span class="p">:</span> <span class="n">Envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">:</span> <span class="n">Manifest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Envelope</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispatch an envelope to its registered handler (async version).</span>

<span class="sd">        This method supports both synchronous and asynchronous handlers.</span>
<span class="sd">        When called from an async context (e.g., FastAPI endpoint), this</span>
<span class="sd">        method will properly await async handlers and run sync handlers</span>
<span class="sd">        in a thread pool to avoid blocking the event loop.</span>

<span class="sd">        Args:</span>
<span class="sd">            envelope: The ASAP envelope to dispatch</span>
<span class="sd">            manifest: The server&#39;s manifest for context</span>

<span class="sd">        Returns:</span>
<span class="sd">            Response envelope from the handler</span>

<span class="sd">        Raises:</span>
<span class="sd">            HandlerNotFoundError: If no handler is registered for the payload type</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; registry = create_default_registry()</span>
<span class="sd">            &gt;&gt;&gt; response = await registry.dispatch_async(envelope, manifest)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload_type</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">payload_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;asap.handler.not_found&quot;</span><span class="p">,</span>
                    <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">HandlerNotFoundError</span><span class="p">(</span><span class="n">payload_type</span><span class="p">)</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">payload_type</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;asap.handler.dispatch&quot;</span><span class="p">,</span>
            <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
            <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">handler_name</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">handler</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">agent_urn</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">id</span>
        <span class="k">with</span> <span class="n">handler_span_context</span><span class="p">(</span>
            <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
            <span class="n">agent_urn</span><span class="o">=</span><span class="n">agent_urn</span><span class="p">,</span>
            <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span><span class="p">:</span> <span class="n">Envelope</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
                    <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">result</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
                        <span class="n">executor</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="n">manifest</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isawaitable</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">result</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Envelope</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

                <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">duration_ms</span> <span class="o">/</span> <span class="mf">1000.0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;asap.handler.completed&quot;</span><span class="p">,</span>
                    <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">response_id</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
                <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span>
                    <span class="s2">&quot;asap_handler_executions_total&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">payload_type</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="n">metrics</span><span class="o">.</span><span class="n">observe_histogram</span><span class="p">(</span>
                    <span class="s2">&quot;asap_handler_duration_seconds&quot;</span><span class="p">,</span>
                    <span class="n">duration_seconds</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">payload_type</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metering_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="kn">from</span><span class="w"> </span><span class="nn">asap.state.metering</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeteringStore</span>

                    <span class="k">await</span> <span class="n">record_task_usage</span><span class="p">(</span>
                        <span class="n">cast</span><span class="p">(</span><span class="n">MeteringStore</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metering_store</span><span class="p">),</span>
                        <span class="n">envelope</span><span class="p">,</span>
                        <span class="n">response</span><span class="p">,</span>
                        <span class="n">duration_ms</span><span class="p">,</span>
                        <span class="n">manifest</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="n">get_metrics</span><span class="p">()</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span>
                    <span class="s2">&quot;asap_handler_errors_total&quot;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">payload_type</span><span class="p">},</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s2">&quot;asap.handler.error&quot;</span><span class="p">,</span>
                    <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                    <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all registered payload types.</span>

<span class="sd">        This method is thread-safe. Returns a copy of the keys list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of payload type strings that have registered handlers</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; registry = create_default_registry()</span>
<span class="sd">            &gt;&gt;&gt; registry.list_handlers()</span>
<span class="sd">            [&#39;task.request&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.transport.HandlerRegistry.dispatch" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dispatch</span><span class="p">(</span><span class="n">envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Dispatch an envelope to its registered handler.</p>
<p>Looks up the handler for the envelope's payload_type and
invokes it with the envelope and manifest.</p>
<p>This method is thread-safe for handler lookup. The handler
execution itself is not protected by the lock.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>envelope</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Envelope (asap.models.envelope.Envelope)" href="#asap.models.envelope.Envelope">Envelope</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The incoming ASAP envelope</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>manifest</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Manifest (asap.models.entities.Manifest)" href="#asap.models.entities.Manifest">Manifest</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The server's manifest for context</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Envelope (asap.models.envelope.Envelope)" href="#asap.models.envelope.Envelope">Envelope</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response envelope from the handler</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="HandlerNotFoundError (asap.transport.handlers.HandlerNotFoundError)" href="#asap.transport.HandlerNotFoundError">HandlerNotFoundError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no handler is registered for the payload type</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>registry = create_default_registry()
response = registry.dispatch(envelope, manifest)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/handlers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envelope</span><span class="p">:</span> <span class="n">Envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">:</span> <span class="n">Manifest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Envelope</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dispatch an envelope to its registered handler.</span>

<span class="sd">    Looks up the handler for the envelope&#39;s payload_type and</span>
<span class="sd">    invokes it with the envelope and manifest.</span>

<span class="sd">    This method is thread-safe for handler lookup. The handler</span>
<span class="sd">    execution itself is not protected by the lock.</span>

<span class="sd">    Args:</span>
<span class="sd">        envelope: The incoming ASAP envelope</span>
<span class="sd">        manifest: The server&#39;s manifest for context</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response envelope from the handler</span>

<span class="sd">    Raises:</span>
<span class="sd">        HandlerNotFoundError: If no handler is registered for the payload type</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; registry = create_default_registry()</span>
<span class="sd">        &gt;&gt;&gt; response = registry.dispatch(envelope, manifest)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">payload_type</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">payload_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.handler.not_found&quot;</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">HandlerNotFoundError</span><span class="p">(</span><span class="n">payload_type</span><span class="p">)</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">payload_type</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;asap.handler.dispatch&quot;</span><span class="p">,</span>
        <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
        <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">handler_name</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">handler</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isawaitable</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutine</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Handler </span><span class="si">{</span><span class="n">handler</span><span class="si">}</span><span class="s2"> returned awaitable in sync dispatch(). &quot;</span>
                <span class="s2">&quot;Use dispatch_async() for async handlers.&quot;</span>
            <span class="p">)</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">Envelope</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;asap.handler.completed&quot;</span><span class="p">,</span>
            <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
            <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">response_id</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="s2">&quot;asap.handler.error&quot;</span><span class="p">,</span>
            <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
            <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.transport.HandlerRegistry.dispatch_async" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dispatch_async</span><span class="p">(</span><span class="n">envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Dispatch an envelope to its registered handler (async version).</p>
<p>This method supports both synchronous and asynchronous handlers.
When called from an async context (e.g., FastAPI endpoint), this
method will properly await async handlers and run sync handlers
in a thread pool to avoid blocking the event loop.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>envelope</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Envelope (asap.models.envelope.Envelope)" href="#asap.models.envelope.Envelope">Envelope</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ASAP envelope to dispatch</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>manifest</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Manifest (asap.models.entities.Manifest)" href="#asap.models.entities.Manifest">Manifest</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The server's manifest for context</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Envelope (asap.models.envelope.Envelope)" href="#asap.models.envelope.Envelope">Envelope</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response envelope from the handler</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="HandlerNotFoundError (asap.transport.handlers.HandlerNotFoundError)" href="#asap.transport.HandlerNotFoundError">HandlerNotFoundError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no handler is registered for the payload type</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>registry = create_default_registry()
response = await registry.dispatch_async(envelope, manifest)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/handlers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envelope</span><span class="p">:</span> <span class="n">Envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">:</span> <span class="n">Manifest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Envelope</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dispatch an envelope to its registered handler (async version).</span>

<span class="sd">    This method supports both synchronous and asynchronous handlers.</span>
<span class="sd">    When called from an async context (e.g., FastAPI endpoint), this</span>
<span class="sd">    method will properly await async handlers and run sync handlers</span>
<span class="sd">    in a thread pool to avoid blocking the event loop.</span>

<span class="sd">    Args:</span>
<span class="sd">        envelope: The ASAP envelope to dispatch</span>
<span class="sd">        manifest: The server&#39;s manifest for context</span>

<span class="sd">    Returns:</span>
<span class="sd">        Response envelope from the handler</span>

<span class="sd">    Raises:</span>
<span class="sd">        HandlerNotFoundError: If no handler is registered for the payload type</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; registry = create_default_registry()</span>
<span class="sd">        &gt;&gt;&gt; response = await registry.dispatch_async(envelope, manifest)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">payload_type</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">.</span><span class="n">payload_type</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">payload_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.handler.not_found&quot;</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">HandlerNotFoundError</span><span class="p">(</span><span class="n">payload_type</span><span class="p">)</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">payload_type</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;asap.handler.dispatch&quot;</span><span class="p">,</span>
        <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
        <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">handler_name</span><span class="o">=</span><span class="n">handler</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">handler</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">agent_urn</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">id</span>
    <span class="k">with</span> <span class="n">handler_span_context</span><span class="p">(</span>
        <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
        <span class="n">agent_urn</span><span class="o">=</span><span class="n">agent_urn</span><span class="p">,</span>
        <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span><span class="p">:</span> <span class="n">Envelope</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
                <span class="n">executor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">result</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
                    <span class="n">executor</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="n">manifest</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isawaitable</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Envelope</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

            <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">duration_ms</span> <span class="o">/</span> <span class="mf">1000.0</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;asap.handler.completed&quot;</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">response_id</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span>
                <span class="s2">&quot;asap_handler_executions_total&quot;</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">payload_type</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">observe_histogram</span><span class="p">(</span>
                <span class="s2">&quot;asap_handler_duration_seconds&quot;</span><span class="p">,</span>
                <span class="n">duration_seconds</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">payload_type</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metering_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">asap.state.metering</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeteringStore</span>

                <span class="k">await</span> <span class="n">record_task_usage</span><span class="p">(</span>
                    <span class="n">cast</span><span class="p">(</span><span class="n">MeteringStore</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metering_store</span><span class="p">),</span>
                    <span class="n">envelope</span><span class="p">,</span>
                    <span class="n">response</span><span class="p">,</span>
                    <span class="n">duration_ms</span><span class="p">,</span>
                    <span class="n">manifest</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">duration_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">get_metrics</span><span class="p">()</span><span class="o">.</span><span class="n">increment_counter</span><span class="p">(</span>
                <span class="s2">&quot;asap_handler_errors_total&quot;</span><span class="p">,</span>
                <span class="p">{</span><span class="s2">&quot;payload_type&quot;</span><span class="p">:</span> <span class="n">payload_type</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;asap.handler.error&quot;</span><span class="p">,</span>
                <span class="n">payload_type</span><span class="o">=</span><span class="n">payload_type</span><span class="p">,</span>
                <span class="n">envelope_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">duration_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.transport.HandlerRegistry.list_handlers" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_handlers</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>List all registered payload types.</p>
<p>This method is thread-safe. Returns a copy of the keys list.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of payload type strings that have registered handlers</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>registry = create_default_registry()
registry.list_handlers()
['task.request']</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/handlers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all registered payload types.</span>

<span class="sd">    This method is thread-safe. Returns a copy of the keys list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of payload type strings that have registered handlers</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; registry = create_default_registry()</span>
<span class="sd">        &gt;&gt;&gt; registry.list_handlers()</span>
<span class="sd">        [&#39;task.request&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="asap.transport.HandlerRegistry.set_metering_store" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_metering_store</span><span class="p">(</span><span class="n">store</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set MeteringStore for usage recording (optional).</p>
<p>When set, task.request completions are recorded to the store.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/handlers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_metering_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set MeteringStore for usage recording (optional).</span>

<span class="sd">    When set, task.request completions are recorded to the store.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_metering_store</span> <span class="o">=</span> <span class="n">store</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.JsonRpcError" class="doc doc-heading">
            <code>JsonRpcError</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>JSON-RPC 2.0 error object.</p>
<p>Represents an error that occurred during request processing.
Follows JSON-RPC 2.0 specification for error responses.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcError.code">code</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Integer error code (standard or application-defined)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcError.message">message</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Short error description</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcError.data">data</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional additional error information</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>error = JsonRpcError(
...     code=-32602,
...     message="Invalid params",
...     data={"missing_field": "task_id"}
... )
error.code
-32602</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/jsonrpc.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">JsonRpcError</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JSON-RPC 2.0 error object.</span>

<span class="sd">    Represents an error that occurred during request processing.</span>
<span class="sd">    Follows JSON-RPC 2.0 specification for error responses.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        code: Integer error code (standard or application-defined)</span>
<span class="sd">        message: Short error description</span>
<span class="sd">        data: Optional additional error information</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; error = JsonRpcError(</span>
<span class="sd">        ...     code=-32602,</span>
<span class="sd">        ...     message=&quot;Invalid params&quot;,</span>
<span class="sd">        ...     data={&quot;missing_field&quot;: &quot;task_id&quot;}</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; error.code</span>
<span class="sd">        -32602</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Error code (negative integer)&quot;</span><span class="p">)</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Short error description&quot;</span><span class="p">)</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Optional additional error information&quot;</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_code</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;JsonRpcError&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create error from standard error code.</span>

<span class="sd">        Args:</span>
<span class="sd">            code: Standard JSON-RPC error code</span>
<span class="sd">            data: Optional additional error information</span>

<span class="sd">        Returns:</span>
<span class="sd">            JsonRpcError instance with standard message</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; error = JsonRpcError.from_code(INVALID_PARAMS, data={&quot;field&quot;: &quot;task_id&quot;})</span>
<span class="sd">            &gt;&gt;&gt; error.message</span>
<span class="sd">            &#39;Invalid params&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">ERROR_MESSAGES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JsonRpcError</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.transport.JsonRpcError.from_code" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Create error from standard error code.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>code</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Standard JSON-RPC error code</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional additional error information</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>&#39;JsonRpcError&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JsonRpcError instance with standard message</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>error = JsonRpcError.from_code(INVALID_PARAMS, data={"field": "task_id"})
error.message
'Invalid params'</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/jsonrpc.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_code</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;JsonRpcError&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create error from standard error code.</span>

<span class="sd">    Args:</span>
<span class="sd">        code: Standard JSON-RPC error code</span>
<span class="sd">        data: Optional additional error information</span>

<span class="sd">    Returns:</span>
<span class="sd">        JsonRpcError instance with standard message</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; error = JsonRpcError.from_code(INVALID_PARAMS, data={&quot;field&quot;: &quot;task_id&quot;})</span>
<span class="sd">        &gt;&gt;&gt; error.message</span>
<span class="sd">        &#39;Invalid params&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">ERROR_MESSAGES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">JsonRpcError</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.JsonRpcErrorResponse" class="doc doc-heading">
            <code>JsonRpcErrorResponse</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>JSON-RPC 2.0 error response.</p>
<p>Returned when a request fails or cannot be processed.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcErrorResponse.jsonrpc">jsonrpc</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;2.0&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Protocol version (always "2.0")</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcErrorResponse.error">error</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="JsonRpcError (asap.transport.jsonrpc.JsonRpcError)" href="#asap.transport.JsonRpcError">JsonRpcError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Error object with code, message, and optional data</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcErrorResponse.id">id</span></code></td>
            <td>
                  <code><span title="str">str</span> | <span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request identifier (matches request, or null if id unavailable)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>error_response = JsonRpcErrorResponse(
...     error=JsonRpcError(code=-32602, message="Invalid params"),
...     id="req-123"
... )
error_response.error.code
-32602</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/jsonrpc.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">JsonRpcErrorResponse</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JSON-RPC 2.0 error response.</span>

<span class="sd">    Returned when a request fails or cannot be processed.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        jsonrpc: Protocol version (always &quot;2.0&quot;)</span>
<span class="sd">        error: Error object with code, message, and optional data</span>
<span class="sd">        id: Request identifier (matches request, or null if id unavailable)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; error_response = JsonRpcErrorResponse(</span>
<span class="sd">        ...     error=JsonRpcError(code=-32602, message=&quot;Invalid params&quot;),</span>
<span class="sd">        ...     id=&quot;req-123&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; error_response.error.code</span>
<span class="sd">        -32602</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">jsonrpc</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;2.0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;JSON-RPC protocol version (always &#39;2.0&#39;)&quot;</span>
    <span class="p">)</span>
    <span class="n">error</span><span class="p">:</span> <span class="n">JsonRpcError</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Error object&quot;</span><span class="p">)</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Request identifier (or null)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.JsonRpcRequest" class="doc doc-heading">
            <code>JsonRpcRequest</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>JSON-RPC 2.0 request.</p>
<p>Wraps an ASAP Envelope in a JSON-RPC request structure.
The envelope is passed in the params field.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcRequest.jsonrpc">jsonrpc</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;2.0&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Protocol version (always "2.0")</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcRequest.method">method</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RPC method name (typically "asap.send")</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcRequest.params">params</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request parameters (contains ASAP envelope)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcRequest.id">id</span></code></td>
            <td>
                  <code><span title="str">str</span> | <span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request identifier for correlation</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>request = JsonRpcRequest(
...     method="asap.send",
...     params={"envelope": {...}},
...     id="req-123"
... )
request.jsonrpc
'2.0'</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/jsonrpc.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">JsonRpcRequest</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JSON-RPC 2.0 request.</span>

<span class="sd">    Wraps an ASAP Envelope in a JSON-RPC request structure.</span>
<span class="sd">    The envelope is passed in the params field.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        jsonrpc: Protocol version (always &quot;2.0&quot;)</span>
<span class="sd">        method: RPC method name (typically &quot;asap.send&quot;)</span>
<span class="sd">        params: Request parameters (contains ASAP envelope)</span>
<span class="sd">        id: Request identifier for correlation</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; request = JsonRpcRequest(</span>
<span class="sd">        ...     method=&quot;asap.send&quot;,</span>
<span class="sd">        ...     params={&quot;envelope&quot;: {...}},</span>
<span class="sd">        ...     id=&quot;req-123&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; request.jsonrpc</span>
<span class="sd">        &#39;2.0&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">jsonrpc</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;2.0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;JSON-RPC protocol version (always &#39;2.0&#39;)&quot;</span>
    <span class="p">)</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;RPC method name&quot;</span><span class="p">)</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Request parameters&quot;</span><span class="p">)</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Request identifier for correlation&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.JsonRpcResponse" class="doc doc-heading">
            <code>JsonRpcResponse</code>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="ASAPBaseModel (asap.models.base.ASAPBaseModel)" href="#asap.models.base.ASAPBaseModel">ASAPBaseModel</a></code></p>



        <p>JSON-RPC 2.0 successful response.</p>
<p>Wraps an ASAP Envelope response or other result data.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcResponse.jsonrpc">jsonrpc</span></code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;2.0&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Protocol version (always "2.0")</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcResponse.result">result</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Response data (ASAP envelope or other result)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.JsonRpcResponse.id">id</span></code></td>
            <td>
                  <code><span title="str">str</span> | <span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request identifier (matches original request)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>response = JsonRpcResponse(
...     result={"envelope": {...}},
...     id="req-123"
... )
response.jsonrpc
'2.0'</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/jsonrpc.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">JsonRpcResponse</span><span class="p">(</span><span class="n">ASAPBaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JSON-RPC 2.0 successful response.</span>

<span class="sd">    Wraps an ASAP Envelope response or other result data.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        jsonrpc: Protocol version (always &quot;2.0&quot;)</span>
<span class="sd">        result: Response data (ASAP envelope or other result)</span>
<span class="sd">        id: Request identifier (matches original request)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; response = JsonRpcResponse(</span>
<span class="sd">        ...     result={&quot;envelope&quot;: {...}},</span>
<span class="sd">        ...     id=&quot;req-123&quot;</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; response.jsonrpc</span>
<span class="sd">        &#39;2.0&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">jsonrpc</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;2.0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;JSON-RPC protocol version (always &#39;2.0&#39;)&quot;</span>
    <span class="p">)</span>
    <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Response data&quot;</span><span class="p">)</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Request identifier (matches request)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.ManifestCache" class="doc doc-heading">
            <code>ManifestCache</code>


</h3>


    <div class="doc doc-contents ">



        <p>Thread-safe in-memory LRU cache for agent manifests.</p>
<p>Provides TTL-based expiration, LRU eviction when max_size is reached,
and methods for cache management. Thread-safe for concurrent access
from multiple async tasks.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ManifestCache._cache">_cache</span></code></td>
            <td>
                  <code><span title="collections.OrderedDict">OrderedDict</span>[<span title="str">str</span>, <span title="asap.transport.cache.CacheEntry">CacheEntry</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>OrderedDict mapping URL to CacheEntry (maintains LRU order)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ManifestCache._lock">_lock</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lock for thread-safe access</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ManifestCache._default_ttl">_default_ttl</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Default TTL in seconds</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.ManifestCache._max_size">_max_size</span></code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of entries (0 for unlimited)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>cache = ManifestCache(default_ttl=300.0, max_size=100)
cache.set("http://agent.example.com/manifest.json", manifest, ttl=300.0)
cached = cache.get("http://agent.example.com/manifest.json")
if cached:
...     print(cached.id)</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/cache.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ManifestCache</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Thread-safe in-memory LRU cache for agent manifests.</span>

<span class="sd">    Provides TTL-based expiration, LRU eviction when max_size is reached,</span>
<span class="sd">    and methods for cache management. Thread-safe for concurrent access</span>
<span class="sd">    from multiple async tasks.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        _cache: OrderedDict mapping URL to CacheEntry (maintains LRU order)</span>
<span class="sd">        _lock: Lock for thread-safe access</span>
<span class="sd">        _default_ttl: Default TTL in seconds</span>
<span class="sd">        _max_size: Maximum number of entries (0 for unlimited)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; cache = ManifestCache(default_ttl=300.0, max_size=100)</span>
<span class="sd">        &gt;&gt;&gt; cache.set(&quot;http://agent.example.com/manifest.json&quot;, manifest, ttl=300.0)</span>
<span class="sd">        &gt;&gt;&gt; cached = cache.get(&quot;http://agent.example.com/manifest.json&quot;)</span>
<span class="sd">        &gt;&gt;&gt; if cached:</span>
<span class="sd">        ...     print(cached.id)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">default_ttl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_TTL</span><span class="p">,</span>
        <span class="n">max_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_SIZE</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CacheEntry</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_ttl</span> <span class="o">=</span> <span class="n">default_ttl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_size</span> <span class="o">=</span> <span class="n">max_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Manifest</span><span class="p">]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_expired</span><span class="p">():</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="n">manifest</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">manifest</span><span class="p">:</span> <span class="n">Manifest</span><span class="p">,</span> <span class="n">ttl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ttl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ttl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_ttl</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">popitem</span><span class="p">(</span><span class="n">last</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">CacheEntry</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">ttl</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">max_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all expired entries from cache.</span>

<span class="sd">        Holds the lock for O(N). For very large max_size, prefer lazy eviction</span>
<span class="sd">        in get() or call less frequently.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Number of expired entries removed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
            <span class="n">expired_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span> <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_expired</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">expired_urls</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">expired_urls</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.transport.ManifestCache.cleanup_expired" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">cleanup_expired</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Remove all expired entries from cache.</p>
<p>Holds the lock for O(N). For very large max_size, prefer lazy eviction
in get() or call less frequently.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of expired entries removed</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/cache.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">cleanup_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove all expired entries from cache.</span>

<span class="sd">    Holds the lock for O(N). For very large max_size, prefer lazy eviction</span>
<span class="sd">    in get() or call less frequently.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Number of expired entries removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
        <span class="n">expired_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span> <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">is_expired</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">expired_urls</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">expired_urls</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.RetryConfig" class="doc doc-heading">
            <code>RetryConfig</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">



        <p>Configuration for retry logic and circuit breaker.</p>
<p>Groups retry and circuit breaker parameters to simplify client initialization
and avoid boolean trap issues.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.RetryConfig.max_retries">max_retries</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum retry attempts for transient failures (default: 3)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.RetryConfig.base_delay">base_delay</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base delay in seconds for exponential backoff (default: 1.0)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.RetryConfig.max_delay">max_delay</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum delay in seconds for exponential backoff (default: 60.0)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.RetryConfig.jitter">jitter</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to add random jitter to backoff delays (default: True)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.RetryConfig.circuit_breaker_enabled">circuit_breaker_enabled</span></code></td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Enable circuit breaker pattern (default: False)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.RetryConfig.circuit_breaker_threshold">circuit_breaker_threshold</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of consecutive failures before opening circuit (default: 5)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="asap.transport.RetryConfig.circuit_breaker_timeout">circuit_breaker_timeout</span></code></td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Seconds before transitioning OPEN -&gt; HALF_OPEN (default: 60.0)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/client.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RetryConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for retry logic and circuit breaker.</span>

<span class="sd">    Groups retry and circuit breaker parameters to simplify client initialization</span>
<span class="sd">    and avoid boolean trap issues.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        max_retries: Maximum retry attempts for transient failures (default: 3)</span>
<span class="sd">        base_delay: Base delay in seconds for exponential backoff (default: 1.0)</span>
<span class="sd">        max_delay: Maximum delay in seconds for exponential backoff (default: 60.0)</span>
<span class="sd">        jitter: Whether to add random jitter to backoff delays (default: True)</span>
<span class="sd">        circuit_breaker_enabled: Enable circuit breaker pattern (default: False)</span>
<span class="sd">        circuit_breaker_threshold: Number of consecutive failures before opening circuit (default: 5)</span>
<span class="sd">        circuit_breaker_timeout: Seconds before transitioning OPEN -&gt; HALF_OPEN (default: 60.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_RETRIES</span>
    <span class="n">base_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_BASE_DELAY</span>
    <span class="n">max_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_DELAY</span>
    <span class="n">jitter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">circuit_breaker_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">circuit_breaker_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_CIRCUIT_BREAKER_THRESHOLD</span>
    <span class="n">circuit_breaker_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_CIRCUIT_BREAKER_TIMEOUT</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.RetryPolicy" class="doc doc-heading">
            <code>RetryPolicy</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">



        <p>Webhook retry: max_retries, base_delay, max_delay, rate_per_second.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/webhook.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RetryPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Webhook retry: max_retries, base_delay, max_delay, rate_per_second.&quot;&quot;&quot;</span>

    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_RETRIES</span>
    <span class="n">base_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_RETRY_BASE_DELAY</span>
    <span class="n">max_delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_RETRY_MAX_DELAY</span>
    <span class="n">rate_per_second</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_WEBHOOK_RATE_PER_SECOND</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">backoff_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;min(base_delay * 2^attempt, max_delay) seconds.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">attempt</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.transport.RetryPolicy.backoff_delay" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">backoff_delay</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>min(base_delay * 2^attempt, max_delay) seconds.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/webhook.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">backoff_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;min(base_delay * 2^attempt, max_delay) seconds.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_delay</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">attempt</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_delay</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.WebhookDelivery" class="doc doc-heading">
            <code>WebhookDelivery</code>


</h3>


    <div class="doc doc-contents ">



        <p>Delivers webhook payloads via POST to registered callback URLs.</p>
<p>Validates callback URLs to prevent SSRF, signs payloads with HMAC-SHA256,
and supports configurable timeouts.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>import asyncio
delivery = WebhookDelivery(secret=b"my-secret", require_https=False)
result = asyncio.run(delivery.deliver(
...     "http://receiver.example.com/hook",
...     {"event": "task.completed", "task_id": "abc-123"},
... ))
print(result.success, result.status_code)</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/webhook.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">WebhookDelivery</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delivers webhook payloads via POST to registered callback URLs.</span>

<span class="sd">    Validates callback URLs to prevent SSRF, signs payloads with HMAC-SHA256,</span>
<span class="sd">    and supports configurable timeouts.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; import asyncio</span>
<span class="sd">        &gt;&gt;&gt; delivery = WebhookDelivery(secret=b&quot;my-secret&quot;, require_https=False)</span>
<span class="sd">        &gt;&gt;&gt; result = asyncio.run(delivery.deliver(</span>
<span class="sd">        ...     &quot;http://receiver.example.com/hook&quot;,</span>
<span class="sd">        ...     {&quot;event&quot;: &quot;task.completed&quot;, &quot;task_id&quot;: &quot;abc-123&quot;},</span>
<span class="sd">        ... ))</span>
<span class="sd">        &gt;&gt;&gt; print(result.success, result.status_code)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">secret</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">DEFAULT_WEBHOOK_TIMEOUT</span><span class="p">,</span>
        <span class="n">require_https</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_secret</span> <span class="o">=</span> <span class="n">secret</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout_seconds</span> <span class="o">=</span> <span class="n">timeout_seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_require_https</span> <span class="o">=</span> <span class="n">require_https</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_external_client</span> <span class="o">=</span> <span class="n">client</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Public API</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">validate_callback_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">require_https</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_require_https</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">deliver</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">extra_headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebhookResult</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">),</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>

        <span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_secret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="n">X_ASAP_SIGNATURE_HEADER</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_signature</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_secret</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_headers</span><span class="p">)</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_external_client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout_seconds</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">success</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">300</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;webhook.delivered&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span>
                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">WebhookResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span>
                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">TimeoutException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;webhook.timeout&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout_seconds</span><span class="p">,</span>
                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">WebhookResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Timeout after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout_seconds</span><span class="si">}</span><span class="s2">s: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;webhook.delivery_failed&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">WebhookResult</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="asap.transport.WebhookRetryManager" class="doc doc-heading">
            <code>WebhookRetryManager</code>


</h3>


    <div class="doc doc-contents ">



        <p>Delivers webhooks with automatic retry, exponential backoff, per-URL rate limiting, and DLQ.</p>
<p>Wraps a <code>WebhookDelivery</code> instance and adds reliability:
    * <strong>Retry queue</strong> â€” failed deliveries are re-queued automatically.
    * <strong>Exponential backoff</strong> â€” delays double per attempt (1 â†’ 2 â†’ 4 â†’ 8 â†’ 16 s).
    * <strong>Dead letter queue</strong> â€” after <code>max_retries</code> the entry is logged and the
      optional <code>on_dead_letter</code> callback is invoked.
    * <strong>Per-URL rate limit</strong> â€” token bucket prevents flooding a single receiver.</p>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>manager = WebhookRetryManager(delivery, policy=RetryPolicy(max_retries=3))
result = await manager.deliver_with_retry(url, payload)</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/asap/transport/webhook.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">WebhookRetryManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delivers webhooks with automatic retry, exponential backoff, per-URL rate limiting, and DLQ.</span>

<span class="sd">    Wraps a ``WebhookDelivery`` instance and adds reliability:</span>
<span class="sd">        * **Retry queue** â€” failed deliveries are re-queued automatically.</span>
<span class="sd">        * **Exponential backoff** â€” delays double per attempt (1 â†’ 2 â†’ 4 â†’ 8 â†’ 16 s).</span>
<span class="sd">        * **Dead letter queue** â€” after ``max_retries`` the entry is logged and the</span>
<span class="sd">          optional ``on_dead_letter`` callback is invoked.</span>
<span class="sd">        * **Per-URL rate limit** â€” token bucket prevents flooding a single receiver.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; manager = WebhookRetryManager(delivery, policy=RetryPolicy(max_retries=3))</span>
<span class="sd">        &gt;&gt;&gt; result = await manager.deliver_with_retry(url, payload)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">delivery</span><span class="p">:</span> <span class="n">WebhookDelivery</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">policy</span><span class="p">:</span> <span class="n">RetryPolicy</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">on_dead_letter</span><span class="p">:</span> <span class="n">DeadLetterCallback</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delivery</span> <span class="o">=</span> <span class="n">delivery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span> <span class="o">=</span> <span class="n">policy</span> <span class="ow">or</span> <span class="n">RetryPolicy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_dead_letter</span> <span class="o">=</span> <span class="n">on_dead_letter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dead_letters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DeadLetterEntry</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url_buckets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_URLTokenBucket</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_buckets</span> <span class="o">=</span> <span class="mi">10_000</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Public API</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dead_letters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">DeadLetterEntry</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dead_letters</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">deliver_with_retry</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">extra_headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebhookResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deliver with retry on 5xx/network error; no retry on 4xx; DLQ after max_retries.&quot;&quot;&quot;</span>
        <span class="n">last_result</span><span class="p">:</span> <span class="n">WebhookResult</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="c1"># Per-URL rate limiting â€” wait until a token is available.</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_rate_limit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

            <span class="n">last_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delivery</span><span class="o">.</span><span class="n">deliver</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">payload</span><span class="p">,</span>
                <span class="n">extra_headers</span><span class="o">=</span><span class="n">extra_headers</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">last_result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">last_result</span>

            <span class="c1"># 4xx â†’ do not retry (client error, the request itself is wrong).</span>
            <span class="k">if</span> <span class="n">last_result</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="n">_NON_RETRYABLE_STATUS_RANGE</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;webhook.retry.non_retryable&quot;</span><span class="p">,</span>
                    <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">last_result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                    <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">last_result</span>

            <span class="c1"># Last attempt â€” don&#39;t sleep, go straight to DLQ.</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">backoff_delay</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;webhook.retry.backoff&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
                <span class="n">delay_seconds</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">last_result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">error</span><span class="o">=</span><span class="n">last_result</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="c1"># All retries exhausted â†’ dead letter queue.</span>
        <span class="k">assert</span> <span class="n">last_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># At least one attempt was made.</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_to_dead_letter</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">last_result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">last_result</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Internal helpers</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_URLTokenBucket</span><span class="p">:</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_buckets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bucket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Evict oldest entry if at capacity to prevent unbounded growth.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url_buckets</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_buckets</span><span class="p">:</span>
                <span class="n">oldest_key</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url_buckets</span><span class="p">))</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_buckets</span><span class="p">[</span><span class="n">oldest_key</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;webhook.bucket_evicted&quot;</span><span class="p">,</span>
                    <span class="n">evicted_url</span><span class="o">=</span><span class="n">oldest_key</span><span class="p">,</span>
                    <span class="n">capacity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_buckets</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">_URLTokenBucket</span><span class="p">(</span><span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">rate_per_second</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_url_buckets</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="n">bucket</span>
        <span class="k">return</span> <span class="n">bucket</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for_rate_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bucket</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">bucket</span><span class="o">.</span><span class="n">consume</span><span class="p">():</span>
            <span class="n">wait</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">seconds_until_available</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;webhook.rate_limit.waiting&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">wait_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_to_dead_letter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">last_result</span><span class="p">:</span> <span class="n">WebhookResult</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">DeadLetterEntry</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
            <span class="n">last_result</span><span class="o">=</span><span class="n">last_result</span><span class="p">,</span>
            <span class="n">attempts</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dead_letters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;webhook.dead_letter&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">attempts</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">attempts</span><span class="p">,</span>
            <span class="n">last_status_code</span><span class="o">=</span><span class="n">last_result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">last_error</span><span class="o">=</span><span class="n">last_result</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_dead_letter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_dead_letter</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;webhook.dead_letter.callback_error&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="asap.transport.WebhookRetryManager.deliver_with_retry" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">deliver_with_retry</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">extra_headers</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Deliver with retry on 5xx/network error; no retry on 4xx; DLQ after max_retries.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/webhook.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">deliver_with_retry</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">extra_headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebhookResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deliver with retry on 5xx/network error; no retry on 4xx; DLQ after max_retries.&quot;&quot;&quot;</span>
    <span class="n">last_result</span><span class="p">:</span> <span class="n">WebhookResult</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
        <span class="c1"># Per-URL rate limiting â€” wait until a token is available.</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_rate_limit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="n">last_result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delivery</span><span class="o">.</span><span class="n">deliver</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">payload</span><span class="p">,</span>
            <span class="n">extra_headers</span><span class="o">=</span><span class="n">extra_headers</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">last_result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">last_result</span>

        <span class="c1"># 4xx â†’ do not retry (client error, the request itself is wrong).</span>
        <span class="k">if</span> <span class="n">last_result</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="n">_NON_RETRYABLE_STATUS_RANGE</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;webhook.retry.non_retryable&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">last_result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">last_result</span>

        <span class="c1"># Last attempt â€” don&#39;t sleep, go straight to DLQ.</span>
        <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">max_retries</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">backoff_delay</span><span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;webhook.retry.backoff&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">max_retries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_policy</span><span class="o">.</span><span class="n">max_retries</span><span class="p">,</span>
            <span class="n">delay_seconds</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">last_result</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="n">last_result</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

    <span class="c1"># All retries exhausted â†’ dead letter queue.</span>
    <span class="k">assert</span> <span class="n">last_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># At least one attempt was made.</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_to_dead_letter</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">last_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">last_result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="asap.transport.compress_payload" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compress_payload</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">preferred_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">COMPRESSION_THRESHOLD</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compress payload if it exceeds threshold.</p>
<p>Compresses the payload using the preferred algorithm if specified,
otherwise uses the best available algorithm (brotli &gt; gzip).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Raw bytes to compress</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>preferred_algorithm</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="CompressionAlgorithm (asap.transport.compression.CompressionAlgorithm)" href="#asap.transport.CompressionAlgorithm">CompressionAlgorithm</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional preferred compression algorithm.
If None, uses brotli if available, otherwise gzip.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Minimum payload size to trigger compression (default: 1KB).
Payloads smaller than this are returned as-is with IDENTITY encoding.</p>
              </div>
            </td>
            <td>
                  <code><span title="asap.transport.compression.COMPRESSION_THRESHOLD">COMPRESSION_THRESHOLD</span></code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple of (compressed_data, algorithm_used)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="CompressionAlgorithm (asap.transport.compression.CompressionAlgorithm)" href="#asap.transport.CompressionAlgorithm">CompressionAlgorithm</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If compression is skipped, returns (original_data, IDENTITY)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="bytes">bytes</span>, <a class="autorefs autorefs-internal" title="CompressionAlgorithm (asap.transport.compression.CompressionAlgorithm)" href="#asap.transport.CompressionAlgorithm">CompressionAlgorithm</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <blockquote>
<blockquote>
<blockquote>
<p>compressed, algorithm = compress_payload(data)</p>
</blockquote>
</blockquote>
</blockquote>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="bytes">bytes</span>, <a class="autorefs autorefs-internal" title="CompressionAlgorithm (asap.transport.compression.CompressionAlgorithm)" href="#asap.transport.CompressionAlgorithm">CompressionAlgorithm</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <blockquote>
<blockquote>
<blockquote>
<p>print(f"Compressed {len(data)} -&gt; {len(compressed)} bytes using {algorithm.value}")</p>
</blockquote>
</blockquote>
</blockquote>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Compression adds CPU overhead which may increase latency for very small payloads.
For extremely latency-sensitive scenarios, consider increasing the threshold
or disabling compression if payloads are typically small.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/compression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compress_payload</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
    <span class="n">preferred_algorithm</span><span class="p">:</span> <span class="n">CompressionAlgorithm</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">COMPRESSION_THRESHOLD</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">CompressionAlgorithm</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compress payload if it exceeds threshold.</span>

<span class="sd">    Compresses the payload using the preferred algorithm if specified,</span>
<span class="sd">    otherwise uses the best available algorithm (brotli &gt; gzip).</span>

<span class="sd">    Args:</span>
<span class="sd">        data: Raw bytes to compress</span>
<span class="sd">        preferred_algorithm: Optional preferred compression algorithm.</span>
<span class="sd">            If None, uses brotli if available, otherwise gzip.</span>
<span class="sd">        threshold: Minimum payload size to trigger compression (default: 1KB).</span>
<span class="sd">            Payloads smaller than this are returned as-is with IDENTITY encoding.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (compressed_data, algorithm_used)</span>
<span class="sd">        If compression is skipped, returns (original_data, IDENTITY)</span>

<span class="sd">        &gt;&gt;&gt; compressed, algorithm = compress_payload(data)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Compressed {len(data)} -&gt; {len(compressed)} bytes using {algorithm.value}&quot;)</span>

<span class="sd">    Note:</span>
<span class="sd">        Compression adds CPU overhead which may increase latency for very small payloads.</span>
<span class="sd">        For extremely latency-sensitive scenarios, consider increasing the threshold</span>
<span class="sd">        or disabling compression if payloads are typically small.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Skip compression for small payloads</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;asap.compression.skipped&quot;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;payload_below_threshold&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">IDENTITY</span>

    <span class="c1"># Determine algorithm to use</span>
    <span class="k">if</span> <span class="n">preferred_algorithm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">algorithm</span> <span class="o">=</span> <span class="n">preferred_algorithm</span>
    <span class="k">elif</span> <span class="n">is_brotli_available</span><span class="p">():</span>
        <span class="c1"># TODO: Add prefer_fast_compression option to prefer gzip even when brotli is available</span>
        <span class="n">algorithm</span> <span class="o">=</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">BROTLI</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">algorithm</span> <span class="o">=</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">GZIP</span>

    <span class="c1"># Skip if identity is requested</span>
    <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">IDENTITY</span>

    <span class="c1"># Compress using selected algorithm</span>
    <span class="n">original_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">algorithm</span> <span class="o">==</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">BROTLI</span><span class="p">:</span>
            <span class="n">compressed</span> <span class="o">=</span> <span class="n">compress_brotli</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compressed</span> <span class="o">=</span> <span class="n">compress_gzip</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">compressed_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>
        <span class="n">reduction_pct</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">compressed_size</span> <span class="o">/</span> <span class="n">original_size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;asap.compression.applied&quot;</span><span class="p">,</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">original_size</span><span class="o">=</span><span class="n">original_size</span><span class="p">,</span>
            <span class="n">compressed_size</span><span class="o">=</span><span class="n">compressed_size</span><span class="p">,</span>
            <span class="n">reduction_percent</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">reduction_pct</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Only use compression if it actually reduces size</span>
        <span class="k">if</span> <span class="n">compressed_size</span> <span class="o">&gt;=</span> <span class="n">original_size</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;asap.compression.ineffective&quot;</span><span class="p">,</span>
                <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">original_size</span><span class="o">=</span><span class="n">original_size</span><span class="p">,</span>
                <span class="n">compressed_size</span><span class="o">=</span><span class="n">compressed_size</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;compression_increased_size&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">IDENTITY</span>

        <span class="k">return</span> <span class="n">compressed</span><span class="p">,</span> <span class="n">algorithm</span>

    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="c1"># Brotli not available, fallback to gzip</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;asap.compression.fallback&quot;</span><span class="p">,</span>
            <span class="n">requested</span><span class="o">=</span><span class="n">algorithm</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">fallback</span><span class="o">=</span><span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;brotli_not_installed&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">compress_payload</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">GZIP</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Compression failed, return original</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;asap.compression.failed&quot;</span><span class="p">,</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">IDENTITY</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.transport.compute_signature" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_signature</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>HMAC-SHA256 of body with secret; returns <code>sha256=&lt;hex&gt;</code> (GitHub/Stripe convention).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/webhook.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_signature</span><span class="p">(</span><span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">secret</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HMAC-SHA256 of body with secret; returns ``sha256=&lt;hex&gt;`` (GitHub/Stripe convention).&quot;&quot;&quot;</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;sha256=</span><span class="si">{</span><span class="n">digest</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.transport.create_app" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_app</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">registry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">token_validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">oauth2_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rate_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_request_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">require_nonce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hot_reload</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">snapshot_store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metering_store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metering_storage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">websocket_message_rate_limit</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">mtls_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delegation_key_store</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delegation_storage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sla_storage</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create and configure a FastAPI application for ASAP protocol.</p>
<p>This factory function creates a FastAPI app with:
- POST /asap endpoint for handling ASAP messages via JSON-RPC
- WebSocket /asap/ws for real-time JSON-RPC (same protocol as POST /asap)
- GET /.well-known/asap/manifest.json for agent discovery
- GET /asap/metrics for Prometheus-compatible metrics
- Authentication middleware (if manifest.auth is configured)
- Error handling middleware
- Request validation
- Extensible handler registry for payload processing</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>manifest</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Manifest (asap.models.entities.Manifest)" href="#asap.models.entities.Manifest">Manifest</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The agent's manifest describing capabilities and endpoints</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>registry</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="HandlerRegistry (asap.transport.handlers.HandlerRegistry)" href="#asap.transport.HandlerRegistry">HandlerRegistry</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional handler registry for processing payloads.
If None, a default registry with echo handler is created.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>token_validator</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="str">str</span>], <span title="str">str</span> | None] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional function to validate Bearer tokens.
Required if manifest.auth is configured. Should return agent ID
if token is valid, None otherwise.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>oauth2_config</code>
            </td>
            <td>
                  <code><span title="asap.auth.OAuth2Config">OAuth2Config</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional OAuth2 config. When provided, OAuth2Middleware
is applied to all /asap/* routes (JWT validation via JWKS). If not
provided, /asap remains unauthenticated unless manifest.auth is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rate_limit</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional rate limit string (e.g., "10/second;100/minute").
Rate limiting is IP-based (per client IP address) to prevent DoS attacks.
Uses token bucket pattern: burst limit + sustained limit.
Defaults to ASAP_RATE_LIMIT environment variable or "10/second;100/minute".
<strong>Warning:</strong> The default storage is <code>memory://</code> (per-process). In
multi-worker deployments (e.g., Gunicorn with 4 workers), each worker
has isolated limits, so effective rate = limit Ã— workers (e.g.,
10/s â†’ 40/s). For production, use Redis-backed storage.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_request_size</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional maximum request size in bytes.
Defaults to ASAP_MAX_REQUEST_SIZE environment variable or 10MB.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_threads</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional maximum number of threads for sync handlers.
Defaults to ASAP_MAX_THREADS environment variable or min(32, cpu_count + 4).
Set to None to use unbounded executor (not recommended for production).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>require_nonce</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, enables nonce validation for replay attack prevention.
When enabled, creates an InMemoryNonceStore and validates nonces in envelopes.
Defaults to False (nonce validation is optional).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>hot_reload</code>
            </td>
            <td>
                  <code><span title="bool">bool</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, watch handlers.py and reload handler registry on file change
(development only). Defaults to ASAP_HOT_RELOAD env or False.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>snapshot_store</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SnapshotStore (asap.state.snapshot.SnapshotStore)" href="#asap.state.SnapshotStore">SnapshotStore</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional SnapshotStore for state persistence. If None, uses
create_snapshot_store() (ASAP_STORAGE_BACKEND and ASAP_STORAGE_PATH).
Stored on app.state.snapshot_store for handlers.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metering_store</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="MeteringStore (asap.state.metering.MeteringStore)" href="#asap.state.MeteringStore">MeteringStore</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional MeteringStore for usage recording. When set, task.request
completions are recorded (tokens, duration, api_calls from TaskResponse.metrics).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>websocket_message_rate_limit</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Max messages per second per WebSocket connection.
When set (default 10.0), connections exceeding this are sent an error frame
and closed. Set to None to disable WebSocket message rate limiting.</p>
              </div>
            </td>
            <td>
                  <code>10.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mtls_config</code>
            </td>
            <td>
                  <code><span title="asap.transport.mtls.MTLSConfig">MTLSConfig</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional mTLS config for server. When provided, store on app.state.mtls_config.
Use asap.transport.mtls.mtls_config_to_uvicorn_kwargs() when running uvicorn.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>delegation_key_store</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="str">str</span>], <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional callable (delegator_urn: str) -&gt; Ed25519PrivateKey for
signing delegation tokens. When provided together with oauth2_config, enables
POST /asap/delegations (creates JWT delegation token; authenticated agent is issuer).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>delegation_storage</code>
            </td>
            <td>
                  <code><span title="object">object</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional DelegationStorage for revocation. When provided with
delegation_key_store, enables DELETE /asap/delegations/{id} and registers issued
token IDs so only the delegator can revoke.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sla_storage</code>
            </td>
            <td>
                  <code><span title="object">object</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional SLAStorage for SLA metrics and breaches. When provided,
enables GET /sla, /sla/history, /sla/breaches for querying SLA status.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="fastapi.FastAPI">FastAPI</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Configured FastAPI application ready to run</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If manifest requires authentication but no token_validator provided</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>from asap.models.entities import Manifest, Capability, Endpoint, Skill, AuthScheme, SLADefinition
from asap.transport.handlers import HandlerRegistry
manifest = Manifest(
...     id="urn:asap:agent:test",
...     name="Test Agent",
...     version="1.0.0",
...     description="Test agent",
...     capabilities=Capability(
...         asap_version="0.1",
...         skills=[Skill(id="test", description="Test skill")],
...         state_persistence=False
...     ),
...     endpoints=Endpoint(asap="http://localhost:8000/asap")
... )
app = create_app(manifest)</p>
<h4 id="asap.transport.create_app--with-sla-optional-add-slasladefinitionavailability995-max_latency_p95_ms500">With SLA (optional): add sla=SLADefinition(availability="99.5%", max_latency_p95_ms=500)</h4>
<h4 id="asap.transport.create_app--with-authentication">With authentication:</h4>
<p>manifest_with_auth = Manifest(
...     ...,  # same as above
...     auth=AuthScheme(schemes=["bearer"])
... )
def my_token_validator(token: str) -&gt; str | None:
...     if token == "valid-token":
...         return "urn:asap:agent:client"
...     return None
app = create_app(manifest_with_auth, token_validator=my_token_validator)</p>
<h4 id="asap.transport.create_app--with-custom-registry">With custom registry:</h4>
<p>registry = HandlerRegistry()
registry.register("task.request", my_handler)
app = create_app(manifest, registry)</p>
<h4 id="asap.transport.create_app--run-with-uvicorn-uvicorn-moduleapp">Run with uvicorn: uvicorn module:app</h4>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_app</span><span class="p">(</span>
    <span class="n">manifest</span><span class="p">:</span> <span class="n">Manifest</span><span class="p">,</span>
    <span class="n">registry</span><span class="p">:</span> <span class="n">HandlerRegistry</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">token_validator</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">oauth2_config</span><span class="p">:</span> <span class="n">OAuth2Config</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rate_limit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_request_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">require_nonce</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">hot_reload</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">snapshot_store</span><span class="p">:</span> <span class="n">SnapshotStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metering_store</span><span class="p">:</span> <span class="n">MeteringStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">metering_storage</span><span class="p">:</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">websocket_message_rate_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="n">mtls_config</span><span class="p">:</span> <span class="n">MTLSConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">delegation_key_store</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">delegation_storage</span><span class="p">:</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">sla_storage</span><span class="p">:</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FastAPI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create and configure a FastAPI application for ASAP protocol.</span>

<span class="sd">    This factory function creates a FastAPI app with:</span>
<span class="sd">    - POST /asap endpoint for handling ASAP messages via JSON-RPC</span>
<span class="sd">    - WebSocket /asap/ws for real-time JSON-RPC (same protocol as POST /asap)</span>
<span class="sd">    - GET /.well-known/asap/manifest.json for agent discovery</span>
<span class="sd">    - GET /asap/metrics for Prometheus-compatible metrics</span>
<span class="sd">    - Authentication middleware (if manifest.auth is configured)</span>
<span class="sd">    - Error handling middleware</span>
<span class="sd">    - Request validation</span>
<span class="sd">    - Extensible handler registry for payload processing</span>

<span class="sd">    Args:</span>
<span class="sd">        manifest: The agent&#39;s manifest describing capabilities and endpoints</span>
<span class="sd">        registry: Optional handler registry for processing payloads.</span>
<span class="sd">            If None, a default registry with echo handler is created.</span>
<span class="sd">        token_validator: Optional function to validate Bearer tokens.</span>
<span class="sd">            Required if manifest.auth is configured. Should return agent ID</span>
<span class="sd">            if token is valid, None otherwise.</span>
<span class="sd">        oauth2_config: Optional OAuth2 config. When provided, OAuth2Middleware</span>
<span class="sd">            is applied to all /asap/* routes (JWT validation via JWKS). If not</span>
<span class="sd">            provided, /asap remains unauthenticated unless manifest.auth is used.</span>
<span class="sd">        rate_limit: Optional rate limit string (e.g., &quot;10/second;100/minute&quot;).</span>
<span class="sd">            Rate limiting is IP-based (per client IP address) to prevent DoS attacks.</span>
<span class="sd">            Uses token bucket pattern: burst limit + sustained limit.</span>
<span class="sd">            Defaults to ASAP_RATE_LIMIT environment variable or &quot;10/second;100/minute&quot;.</span>
<span class="sd">            **Warning:** The default storage is ``memory://`` (per-process). In</span>
<span class="sd">            multi-worker deployments (e.g., Gunicorn with 4 workers), each worker</span>
<span class="sd">            has isolated limits, so effective rate = limit Ã— workers (e.g.,</span>
<span class="sd">            10/s â†’ 40/s). For production, use Redis-backed storage.</span>
<span class="sd">        max_request_size: Optional maximum request size in bytes.</span>
<span class="sd">            Defaults to ASAP_MAX_REQUEST_SIZE environment variable or 10MB.</span>
<span class="sd">        max_threads: Optional maximum number of threads for sync handlers.</span>
<span class="sd">            Defaults to ASAP_MAX_THREADS environment variable or min(32, cpu_count + 4).</span>
<span class="sd">            Set to None to use unbounded executor (not recommended for production).</span>
<span class="sd">        require_nonce: If True, enables nonce validation for replay attack prevention.</span>
<span class="sd">            When enabled, creates an InMemoryNonceStore and validates nonces in envelopes.</span>
<span class="sd">            Defaults to False (nonce validation is optional).</span>
<span class="sd">        hot_reload: If True, watch handlers.py and reload handler registry on file change</span>
<span class="sd">            (development only). Defaults to ASAP_HOT_RELOAD env or False.</span>
<span class="sd">        snapshot_store: Optional SnapshotStore for state persistence. If None, uses</span>
<span class="sd">            create_snapshot_store() (ASAP_STORAGE_BACKEND and ASAP_STORAGE_PATH).</span>
<span class="sd">            Stored on app.state.snapshot_store for handlers.</span>
<span class="sd">        metering_store: Optional MeteringStore for usage recording. When set, task.request</span>
<span class="sd">            completions are recorded (tokens, duration, api_calls from TaskResponse.metrics).</span>
<span class="sd">        websocket_message_rate_limit: Max messages per second per WebSocket connection.</span>
<span class="sd">            When set (default 10.0), connections exceeding this are sent an error frame</span>
<span class="sd">            and closed. Set to None to disable WebSocket message rate limiting.</span>
<span class="sd">        mtls_config: Optional mTLS config for server. When provided, store on app.state.mtls_config.</span>
<span class="sd">            Use asap.transport.mtls.mtls_config_to_uvicorn_kwargs() when running uvicorn.</span>
<span class="sd">        delegation_key_store: Optional callable (delegator_urn: str) -&gt; Ed25519PrivateKey for</span>
<span class="sd">            signing delegation tokens. When provided together with oauth2_config, enables</span>
<span class="sd">            POST /asap/delegations (creates JWT delegation token; authenticated agent is issuer).</span>
<span class="sd">        delegation_storage: Optional DelegationStorage for revocation. When provided with</span>
<span class="sd">            delegation_key_store, enables DELETE /asap/delegations/{id} and registers issued</span>
<span class="sd">            token IDs so only the delegator can revoke.</span>
<span class="sd">        sla_storage: Optional SLAStorage for SLA metrics and breaches. When provided,</span>
<span class="sd">            enables GET /sla, /sla/history, /sla/breaches for querying SLA status.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Configured FastAPI application ready to run</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If manifest requires authentication but no token_validator provided</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; from asap.models.entities import Manifest, Capability, Endpoint, Skill, AuthScheme, SLADefinition</span>
<span class="sd">        &gt;&gt;&gt; from asap.transport.handlers import HandlerRegistry</span>
<span class="sd">        &gt;&gt;&gt; manifest = Manifest(</span>
<span class="sd">        ...     id=&quot;urn:asap:agent:test&quot;,</span>
<span class="sd">        ...     name=&quot;Test Agent&quot;,</span>
<span class="sd">        ...     version=&quot;1.0.0&quot;,</span>
<span class="sd">        ...     description=&quot;Test agent&quot;,</span>
<span class="sd">        ...     capabilities=Capability(</span>
<span class="sd">        ...         asap_version=&quot;0.1&quot;,</span>
<span class="sd">        ...         skills=[Skill(id=&quot;test&quot;, description=&quot;Test skill&quot;)],</span>
<span class="sd">        ...         state_persistence=False</span>
<span class="sd">        ...     ),</span>
<span class="sd">        ...     endpoints=Endpoint(asap=&quot;http://localhost:8000/asap&quot;)</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; app = create_app(manifest)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # With SLA (optional): add sla=SLADefinition(availability=&quot;99.5%&quot;, max_latency_p95_ms=500)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # With authentication:</span>
<span class="sd">        &gt;&gt;&gt; manifest_with_auth = Manifest(</span>
<span class="sd">        ...     ...,  # same as above</span>
<span class="sd">        ...     auth=AuthScheme(schemes=[&quot;bearer&quot;])</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; def my_token_validator(token: str) -&gt; str | None:</span>
<span class="sd">        ...     if token == &quot;valid-token&quot;:</span>
<span class="sd">        ...         return &quot;urn:asap:agent:client&quot;</span>
<span class="sd">        ...     return None</span>
<span class="sd">        &gt;&gt;&gt; app = create_app(manifest_with_auth, token_validator=my_token_validator)</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # With custom registry:</span>
<span class="sd">        &gt;&gt;&gt; registry = HandlerRegistry()</span>
<span class="sd">        &gt;&gt;&gt; registry.register(&quot;task.request&quot;, my_handler)</span>
<span class="sd">        &gt;&gt;&gt; app = create_app(manifest, registry)</span>
<span class="sd">        &gt;&gt;&gt; # Run with uvicorn: uvicorn module:app</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Configure thread pool executor for DoS prevention</span>
    <span class="n">executor</span><span class="p">:</span> <span class="n">BoundedExecutor</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">max_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_threads_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ASAP_MAX_THREADS&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_threads_env</span><span class="p">:</span>
            <span class="n">max_threads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_threads_env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_threads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="n">BoundedExecutor</span><span class="p">(</span><span class="n">max_threads</span><span class="o">=</span><span class="n">max_threads</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.server.bounded_executor_enabled&quot;</span><span class="p">,</span>
            <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">max_threads</span><span class="o">=</span><span class="n">max_threads</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Resolve metering: metering_storage takes precedence (enables usage API)</span>
    <span class="n">effective_metering_store</span><span class="p">:</span> <span class="n">MeteringStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">metering_store</span>
    <span class="k">if</span> <span class="n">metering_storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metering_storage</span><span class="p">,</span> <span class="n">MeteringStorage</span><span class="p">):</span>
        <span class="n">effective_metering_store</span> <span class="o">=</span> <span class="n">metering_storage_adapter</span><span class="p">(</span><span class="n">metering_storage</span><span class="p">)</span>

    <span class="c1"># Use default registry if none provided</span>
    <span class="n">use_default_registry</span> <span class="o">=</span> <span class="n">registry</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">registry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">registry</span> <span class="o">=</span> <span class="n">create_default_registry</span><span class="p">(</span><span class="n">metering_store</span><span class="o">=</span><span class="n">effective_metering_store</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">effective_metering_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">registry</span><span class="o">.</span><span class="n">set_metering_store</span><span class="p">(</span><span class="n">effective_metering_store</span><span class="p">)</span>

    <span class="c1"># Attach executor to registry if provided</span>
    <span class="k">if</span> <span class="n">executor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">registry</span><span class="o">.</span><span class="n">_executor</span> <span class="o">=</span> <span class="n">executor</span>

    <span class="c1"># Wrap registry in holder for hot reload support</span>
    <span class="n">registry_holder</span> <span class="o">=</span> <span class="n">RegistryHolder</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">executor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">registry_holder</span><span class="o">.</span><span class="n">_executor</span> <span class="o">=</span> <span class="n">executor</span>

    <span class="c1"># Resolve hot_reload from env if not specified</span>
    <span class="k">if</span> <span class="n">hot_reload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hot_reload</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">ENV_HOT_RELOAD</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">)</span>

    <span class="c1"># Create authentication middleware if auth is configured</span>
    <span class="n">auth_middleware</span><span class="p">:</span> <span class="n">AuthenticationMiddleware</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">manifest</span><span class="o">.</span><span class="n">auth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token_validator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;token_validator is required when manifest.auth is configured. &quot;</span>
                <span class="s2">&quot;Provide a function that validates tokens and returns agent IDs.&quot;</span>
            <span class="p">)</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">BearerTokenValidator</span><span class="p">(</span><span class="n">token_validator</span><span class="p">)</span>
        <span class="n">auth_middleware</span> <span class="o">=</span> <span class="n">AuthenticationMiddleware</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">validator</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.server.auth_enabled&quot;</span><span class="p">,</span>
            <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">schemes</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">schemes</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Configure max request size</span>
    <span class="k">if</span> <span class="n">max_request_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_request_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ASAP_MAX_REQUEST_SIZE&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">MAX_REQUEST_SIZE</span><span class="p">)))</span>

    <span class="c1"># Create nonce store if required</span>
    <span class="n">nonce_store</span><span class="p">:</span> <span class="n">NonceStore</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">require_nonce</span><span class="p">:</span>
        <span class="n">nonce_store</span> <span class="o">=</span> <span class="n">InMemoryNonceStore</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.server.nonce_validation_enabled&quot;</span><span class="p">,</span>
            <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Resolve snapshot store (env-based when not provided)</span>
    <span class="k">if</span> <span class="n">snapshot_store</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">snapshot_store</span> <span class="o">=</span> <span class="n">create_snapshot_store</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.server.snapshot_store_from_env&quot;</span><span class="p">,</span>
            <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">backend</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ASAP_STORAGE_BACKEND&quot;</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># Create request handler</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">ASAPRequestHandler</span><span class="p">(</span>
        <span class="n">registry_holder</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">auth_middleware</span><span class="p">,</span> <span class="n">max_request_size</span><span class="p">,</span> <span class="n">nonce_store</span>
    <span class="p">)</span>

    <span class="c1"># Start handler file watcher when hot reload is enabled (only with default registry)</span>
    <span class="k">if</span> <span class="n">hot_reload</span> <span class="ow">and</span> <span class="n">use_default_registry</span><span class="p">:</span>
        <span class="n">_handlers_module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;asap.transport.handlers&quot;</span><span class="p">)</span>
        <span class="n">_handlers_file</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_handlers_module</span><span class="p">,</span> <span class="s2">&quot;__file__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">_handlers_module</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_handlers_file</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">_handlers_file</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">watcher</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">_run_handler_watcher</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">registry_holder</span><span class="p">,</span> <span class="n">_handlers_file</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;asap-handler-watcher&quot;</span><span class="p">,</span>
                <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">watcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;asap.server.hot_reload_enabled&quot;</span><span class="p">,</span>
                <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">_handlers_file</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;asap.server.hot_reload_skipped&quot;</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;handlers module path not found&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Enable Swagger UI (/docs) and ReDoc (/redoc) only when ASAP_DEBUG=true</span>
    <span class="n">_docs_url</span> <span class="o">=</span> <span class="s2">&quot;/docs&quot;</span> <span class="k">if</span> <span class="n">is_debug_mode</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">_redoc_url</span> <span class="o">=</span> <span class="s2">&quot;/redoc&quot;</span> <span class="k">if</span> <span class="n">is_debug_mode</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">_openapi_url</span> <span class="o">=</span> <span class="s2">&quot;/openapi.json&quot;</span> <span class="k">if</span> <span class="n">is_debug_mode</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Track active WebSocket connections for graceful shutdown (close with reason)</span>
    <span class="n">_active_websockets</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">WebSocket</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c1"># Subset of connections subscribed to SLA breach notifications (v1.3)</span>
    <span class="n">_sla_breach_subscribers</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">WebSocket</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">yield</span>
        <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">_active_websockets</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">close</span><span class="p">(</span>
                    <span class="n">code</span><span class="o">=</span><span class="n">WS_CLOSE_GOING_AWAY</span><span class="p">,</span>
                    <span class="n">reason</span><span class="o">=</span><span class="n">WS_CLOSE_REASON_SHUTDOWN</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ASAP Protocol Server&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ASAP server for </span><span class="si">{</span><span class="n">manifest</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
        <span class="n">docs_url</span><span class="o">=</span><span class="n">_docs_url</span><span class="p">,</span>
        <span class="n">redoc_url</span><span class="o">=</span><span class="n">_redoc_url</span><span class="p">,</span>
        <span class="n">openapi_url</span><span class="o">=</span><span class="n">_openapi_url</span><span class="p">,</span>
        <span class="n">lifespan</span><span class="o">=</span><span class="n">_lifespan</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">websocket_connections</span> <span class="o">=</span> <span class="n">_active_websockets</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">sla_breach_subscribers</span> <span class="o">=</span> <span class="n">_sla_breach_subscribers</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">websocket_message_rate_limit</span> <span class="o">=</span> <span class="n">websocket_message_rate_limit</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">mtls_config</span> <span class="o">=</span> <span class="n">mtls_config</span>
    <span class="k">if</span> <span class="n">metering_storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metering_storage</span><span class="p">,</span> <span class="n">MeteringStorage</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">metering_storage</span> <span class="o">=</span> <span class="n">metering_storage</span>
        <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">create_usage_router</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;asap.server.usage_api_unauthenticated&quot;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Usage API (/usage) is enabled but unauthenticated. &quot;</span>
                <span class="s2">&quot;Intended for local/operator use only. Protect with OAuth2 or network controls when exposed.&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">mtls_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.server.mtls_enabled&quot;</span><span class="p">,</span>
            <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">cert_file</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">mtls_config</span><span class="o">.</span><span class="n">cert_file</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">sla_storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sla_storage</span><span class="p">,</span> <span class="n">SLAStorage</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">sla_storage</span> <span class="o">=</span> <span class="n">sla_storage</span>
        <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">manifest</span> <span class="o">=</span> <span class="n">manifest</span>
        <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">create_sla_router</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;asap.server.sla_api_unauthenticated&quot;</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;SLA API (/sla) is enabled but unauthenticated. &quot;</span>
                <span class="s2">&quot;Intended for local/operator use only. Protect with OAuth2 or network controls when exposed.&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">oauth2_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">delegation_key_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">delegation_key_store</span> <span class="o">=</span> <span class="n">delegation_key_store</span>
        <span class="k">if</span> <span class="n">delegation_storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">delegation_storage</span> <span class="o">=</span> <span class="n">delegation_storage</span>
        <span class="n">app</span><span class="o">.</span><span class="n">include_router</span><span class="p">(</span><span class="n">create_delegation_router</span><span class="p">(),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/asap&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.server.delegation_api_enabled&quot;</span><span class="p">,</span>
            <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Add size limit middleware (runs before routing)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">SizeLimitMiddleware</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="n">max_request_size</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">oauth2_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">middleware_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;jwks_uri&quot;</span><span class="p">:</span> <span class="n">oauth2_config</span><span class="o">.</span><span class="n">jwks_uri</span><span class="p">,</span>
            <span class="s2">&quot;required_scope&quot;</span><span class="p">:</span> <span class="n">oauth2_config</span><span class="o">.</span><span class="n">required_scope</span><span class="p">,</span>
            <span class="s2">&quot;path_prefix&quot;</span><span class="p">:</span> <span class="n">oauth2_config</span><span class="o">.</span><span class="n">path_prefix</span><span class="p">,</span>
            <span class="s2">&quot;manifest_id&quot;</span><span class="p">:</span> <span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;custom_claim&quot;</span><span class="p">:</span> <span class="n">oauth2_config</span><span class="o">.</span><span class="n">custom_claim</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">oauth2_config</span><span class="o">.</span><span class="n">jwks_fetcher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">middleware_kwargs</span><span class="p">[</span><span class="s2">&quot;jwks_fetcher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oauth2_config</span><span class="o">.</span><span class="n">jwks_fetcher</span>
        <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">OAuth2Middleware</span><span class="p">,</span> <span class="o">**</span><span class="n">middleware_kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;asap.server.oauth2_enabled&quot;</span><span class="p">,</span>
            <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">jwks_uri</span><span class="o">=</span><span class="n">oauth2_config</span><span class="o">.</span><span class="n">jwks_uri</span><span class="p">,</span>
            <span class="n">path_prefix</span><span class="o">=</span><span class="n">oauth2_config</span><span class="o">.</span><span class="n">path_prefix</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Configure rate limiting</span>
    <span class="k">if</span> <span class="n">rate_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default matches DD-012: Burst allowance for better UX with bursty agent traffic</span>
        <span class="n">rate_limit_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ASAP_RATE_LIMIT&quot;</span><span class="p">,</span> <span class="s2">&quot;10/second;100/minute&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rate_limit_str</span> <span class="o">=</span> <span class="n">rate_limit</span>

    <span class="c1"># Create isolated limiter instance for this app.</span>
    <span class="c1"># Each app instance gets its own rate limiter storage.</span>
    <span class="c1"># Tests can override via direct assignment to app.state.limiter.</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">limiter</span> <span class="o">=</span> <span class="n">create_limiter</span><span class="p">(</span>
        <span class="p">[</span><span class="n">rate_limit_str</span><span class="p">],</span>
        <span class="n">key_func</span><span class="o">=</span><span class="n">_get_sender_from_envelope</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">max_request_size</span> <span class="o">=</span> <span class="n">max_request_size</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">snapshot_store</span> <span class="o">=</span> <span class="n">snapshot_store</span>
    <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">metering_store</span> <span class="o">=</span> <span class="n">metering_store</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_exception_handler</span><span class="p">(</span><span class="n">RateLimitExceeded</span><span class="p">,</span> <span class="n">rate_limit_handler</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;asap.server.rate_limit_enabled&quot;</span><span class="p">,</span>
        <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">rate_limit</span><span class="o">=</span><span class="n">rate_limit_str</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;asap.server.max_request_size&quot;</span><span class="p">,</span>
        <span class="n">manifest_id</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">max_request_size</span><span class="o">=</span><span class="n">max_request_size</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Liveness probe: always OK if the process is running.</span>

<span class="sd">        Used by Kubernetes livenessProbe and Docker HEALTHCHECK.</span>
<span class="sd">        Returns 200 with {&quot;status&quot;: &quot;ok&quot;}.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JSONResponse with status ok</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">})</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/ready&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ready</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Readiness probe: OK when the server is ready to accept traffic.</span>

<span class="sd">        Used by Kubernetes readinessProbe. Returns 200 when the app</span>
<span class="sd">        is initialized and can serve requests.</span>

<span class="sd">        Returns:</span>
<span class="sd">            JSONResponse with status ok</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">})</span>

    <span class="n">server_started_at</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">manifest</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wellknown</span><span class="o">.</span><span class="n">WELLKNOWN_MANIFEST_PATH</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_manifest</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return the agent&#39;s manifest for discovery.</span>

<span class="sd">            This endpoint allows other agents to discover this agent&#39;s</span>
<span class="sd">            capabilities, skills, and communication endpoints.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">wellknown</span><span class="o">.</span><span class="n">get_manifest_response</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

        <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">discovery_health</span><span class="o">.</span><span class="n">WELLKNOWN_HEALTH_PATH</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_health</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return agent health/liveness status (200 healthy, 503 unhealthy).&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">discovery_health</span><span class="o">.</span><span class="n">get_health_response_async</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">server_started_at</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/asap/metrics&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_metrics_endpoint</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PlainTextResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return Prometheus-compatible metrics.</span>

<span class="sd">        This endpoint exposes server metrics in Prometheus text format,</span>
<span class="sd">        including request counts, error rates, and latency histograms.</span>

<span class="sd">        Returns:</span>
<span class="sd">            PlainTextResponse with metrics in Prometheus format</span>

<span class="sd">        Example:</span>
<span class="sd">            curl http://localhost:8000/asap/metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">PlainTextResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">metrics</span><span class="o">.</span><span class="n">export_prometheus</span><span class="p">(),</span>
            <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;application/openmetrics-text; version=1.0.0; charset=utf-8&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># OpenTelemetry tracing (zero-config via OTEL_* env vars)</span>
    <span class="n">configure_tracing</span><span class="p">(</span><span class="n">service_name</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/asap&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_asap_message</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSONResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle ASAP messages wrapped in JSON-RPC 2.0.</span>

<span class="sd">        This endpoint:</span>
<span class="sd">        1. Enforces rate limiting via ``app.state.limiter``</span>
<span class="sd">        2. Receives JSON-RPC wrapped ASAP envelopes</span>
<span class="sd">        3. Validates the request structure</span>
<span class="sd">        4. Extracts and processes the ASAP envelope</span>
<span class="sd">        5. Returns response wrapped in JSON-RPC</span>
<span class="sd">        6. Records metrics for observability</span>

<span class="sd">        Args:</span>
<span class="sd">            request: FastAPI request object with JSON body</span>

<span class="sd">        Returns:</span>
<span class="sd">            JSON-RPC response or error response</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Send JSON-RPC to POST /asap and receive JSON-RPC response.</span>
<span class="sd">            &gt;&gt;&gt; # See tests/transport/test_server.py for full request examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rate limit check â€” uses app.state.limiter so tests can override.</span>
        <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">limiter</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">handler</span><span class="o">.</span><span class="n">handle_message</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">websocket</span><span class="p">(</span><span class="s2">&quot;/asap/ws&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">websocket_asap</span><span class="p">(</span><span class="n">websocket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ASAP JSON-RPC over WebSocket; same handlers as POST /asap.&quot;&quot;&quot;</span>
        <span class="n">ws_rate_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;websocket_message_rate_limit&quot;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
        <span class="n">sla_subscribers</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">WebSocket</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;sla_breach_subscribers&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">handle_websocket_connection</span><span class="p">(</span>
            <span class="n">websocket</span><span class="p">,</span>
            <span class="n">handler</span><span class="p">,</span>
            <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">websocket_connections</span><span class="p">,</span>
            <span class="n">ws_message_rate_limit</span><span class="o">=</span><span class="n">ws_rate_limit</span><span class="p">,</span>
            <span class="n">sla_breach_subscribers</span><span class="o">=</span><span class="n">sla_subscribers</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.transport.create_default_registry" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_default_registry</span><span class="p">(</span><span class="n">metering_store</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a registry with default handlers.</p>
<p>Creates a HandlerRegistry pre-configured with standard handlers:
- task.request: Echo handler (for basic testing)</p>
<p>Additional handlers can be registered after creation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>metering_store</code>
            </td>
            <td>
                  <code><span title="object">object</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional MeteringStore for usage recording.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="HandlerRegistry (asap.transport.handlers.HandlerRegistry)" href="#asap.transport.HandlerRegistry">HandlerRegistry</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HandlerRegistry with default handlers registered</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>registry = create_default_registry()
registry.has_handler("task.request")
True</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/handlers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_default_registry</span><span class="p">(</span>
    <span class="n">metering_store</span><span class="p">:</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HandlerRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a registry with default handlers.</span>

<span class="sd">    Creates a HandlerRegistry pre-configured with standard handlers:</span>
<span class="sd">    - task.request: Echo handler (for basic testing)</span>

<span class="sd">    Additional handlers can be registered after creation.</span>

<span class="sd">    Args:</span>
<span class="sd">        metering_store: Optional MeteringStore for usage recording.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HandlerRegistry with default handlers registered</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; registry = create_default_registry()</span>
<span class="sd">        &gt;&gt;&gt; registry.has_handler(&quot;task.request&quot;)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="n">HandlerRegistry</span><span class="p">(</span><span class="n">metering_store</span><span class="o">=</span><span class="n">metering_store</span><span class="p">)</span>
    <span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;task.request&quot;</span><span class="p">,</span> <span class="n">create_echo_handler</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">registry</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.transport.create_echo_handler" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_echo_handler</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a synchronous echo handler that echoes TaskRequest input.</p>
<p>The echo handler is a simple implementation that:
- Receives a TaskRequest envelope
- Returns a TaskResponse with the input echoed back
- Preserves trace_id and sets correlation_id</p>
<p>Returns SyncHandler (not Handler) so tests can use it without casting.
This is useful for testing and as a base for custom handlers.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="asap.transport.handlers.SyncHandler">SyncHandler</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SyncHandler that echoes TaskRequest input</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>handler = create_echo_handler()
response = handler(request_envelope, manifest)</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/handlers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_echo_handler</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SyncHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a synchronous echo handler that echoes TaskRequest input.</span>

<span class="sd">    The echo handler is a simple implementation that:</span>
<span class="sd">    - Receives a TaskRequest envelope</span>
<span class="sd">    - Returns a TaskResponse with the input echoed back</span>
<span class="sd">    - Preserves trace_id and sets correlation_id</span>

<span class="sd">    Returns SyncHandler (not Handler) so tests can use it without casting.</span>
<span class="sd">    This is useful for testing and as a base for custom handlers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SyncHandler that echoes TaskRequest input</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; handler = create_echo_handler()</span>
<span class="sd">        &gt;&gt;&gt; response = handler(request_envelope, manifest)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">echo_handler</span><span class="p">(</span><span class="n">envelope</span><span class="p">:</span> <span class="n">Envelope</span><span class="p">,</span> <span class="n">manifest</span><span class="p">:</span> <span class="n">Manifest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Envelope</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Echo handler implementation.&quot;&quot;&quot;</span>
        <span class="c1"># Parse the TaskRequest payload</span>
        <span class="n">task_request</span> <span class="o">=</span> <span class="n">TaskRequest</span><span class="p">(</span><span class="o">**</span><span class="n">envelope</span><span class="o">.</span><span class="n">payload_dict</span><span class="p">)</span>

        <span class="c1"># Create response with echoed input</span>
        <span class="n">response_payload</span> <span class="o">=</span> <span class="n">TaskResponse</span><span class="p">(</span>
            <span class="n">task_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;task_</span><span class="si">{</span><span class="n">generate_id</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">TaskStatus</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;echoed&quot;</span><span class="p">:</span> <span class="n">task_request</span><span class="o">.</span><span class="n">input</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Create response envelope</span>
        <span class="k">return</span> <span class="n">Envelope</span><span class="p">(</span>
            <span class="n">asap_version</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">asap_version</span><span class="p">,</span>
            <span class="n">sender</span><span class="o">=</span><span class="n">manifest</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">recipient</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
            <span class="n">payload_type</span><span class="o">=</span><span class="s2">&quot;task.response&quot;</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="n">response_payload</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
            <span class="n">correlation_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">trace_id</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">echo_handler</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.transport.decompress_payload" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">decompress_payload</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Decompress payload based on Content-Encoding header.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compressed bytes</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>encoding</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Content-Encoding header value (e.g., "gzip", "br", "identity")</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bytes">bytes</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Decompressed bytes</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If encoding is not supported</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="OSError">OSError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If decompression fails (invalid compressed data)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>compressed_data = gzip.compress(b'{"message": "hello"}')
original = decompress_payload(compressed_data, "gzip")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/compression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">decompress_payload</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
    <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decompress payload based on Content-Encoding header.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: Compressed bytes</span>
<span class="sd">        encoding: Content-Encoding header value (e.g., &quot;gzip&quot;, &quot;br&quot;, &quot;identity&quot;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Decompressed bytes</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If encoding is not supported</span>
<span class="sd">        OSError: If decompression fails (invalid compressed data)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; compressed_data = gzip.compress(b&#39;{&quot;message&quot;: &quot;hello&quot;}&#39;)</span>
<span class="sd">        &gt;&gt;&gt; original = decompress_payload(compressed_data, &quot;gzip&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize encoding name</span>
    <span class="n">encoding_lower</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># Handle identity (no compression)</span>
    <span class="k">if</span> <span class="n">encoding_lower</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="n">original_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">encoding_lower</span> <span class="o">==</span> <span class="s2">&quot;gzip&quot;</span><span class="p">:</span>
            <span class="n">decompressed</span> <span class="o">=</span> <span class="n">decompress_gzip</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">encoding_lower</span> <span class="o">==</span> <span class="s2">&quot;br&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_brotli_available</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Brotli decompression requested but brotli package is not installed. &quot;</span>
                    <span class="s2">&quot;Install with: pip install brotli&quot;</span>
                <span class="p">)</span>
            <span class="n">decompressed</span> <span class="o">=</span> <span class="n">decompress_brotli</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported Content-Encoding: </span><span class="si">{</span><span class="n">encoding</span><span class="si">}</span><span class="s2">. Supported: gzip, br, identity&quot;</span>
            <span class="p">)</span>

        <span class="n">decompressed_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">decompressed</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;asap.decompression.applied&quot;</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding_lower</span><span class="p">,</span>
            <span class="n">compressed_size</span><span class="o">=</span><span class="n">original_size</span><span class="p">,</span>
            <span class="n">decompressed_size</span><span class="o">=</span><span class="n">decompressed_size</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">decompressed</span>

    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cannot decompress </span><span class="si">{</span><span class="n">encoding</span><span class="si">}</span><span class="s2">: required package not installed. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.transport.select_best_encoding" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">select_best_encoding</span><span class="p">(</span><span class="n">accept_encoding</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Select best compression algorithm based on Accept-Encoding header.</p>
<p>Parses the Accept-Encoding header and selects the best supported algorithm
based on client preferences and availability.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>accept_encoding</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Accept-Encoding header value (e.g., "gzip, br;q=0.9")
If None, returns IDENTITY (no compression).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="CompressionAlgorithm (asap.transport.compression.CompressionAlgorithm)" href="#asap.transport.CompressionAlgorithm">CompressionAlgorithm</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Best available compression algorithm</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>algorithm = select_best_encoding("br, gzip;q=0.9, identity;q=0.5")
print(algorithm.value)  # "br" if brotli available, else "gzip"</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/compression.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">select_best_encoding</span><span class="p">(</span><span class="n">accept_encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompressionAlgorithm</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select best compression algorithm based on Accept-Encoding header.</span>

<span class="sd">    Parses the Accept-Encoding header and selects the best supported algorithm</span>
<span class="sd">    based on client preferences and availability.</span>

<span class="sd">    Args:</span>
<span class="sd">        accept_encoding: Accept-Encoding header value (e.g., &quot;gzip, br;q=0.9&quot;)</span>
<span class="sd">            If None, returns IDENTITY (no compression).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Best available compression algorithm</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; algorithm = select_best_encoding(&quot;br, gzip;q=0.9, identity;q=0.5&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(algorithm.value)  # &quot;br&quot; if brotli available, else &quot;gzip&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">accept_encoding</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">IDENTITY</span>

    <span class="c1"># Parse Accept-Encoding header (simplified parser)</span>
    <span class="c1"># Format: encoding[;q=weight], encoding[;q=weight], ...</span>
    <span class="n">encodings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">accept_encoding</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
        <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Split encoding and quality</span>
        <span class="k">if</span> <span class="s2">&quot;;q=&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">encoding</span><span class="p">,</span> <span class="n">q_str</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;q=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">q_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">quality</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">quality</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">encoding</span><span class="p">:</span>
            <span class="n">encodings</span><span class="p">[</span><span class="n">encoding</span><span class="p">]</span> <span class="o">=</span> <span class="n">quality</span>

    <span class="c1"># Sort by quality (highest first) and filter to supported encodings</span>
    <span class="n">supported</span> <span class="o">=</span> <span class="n">get_supported_encodings</span><span class="p">()</span>
    <span class="n">candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">enc</span><span class="p">,</span> <span class="n">quality</span> <span class="ow">in</span> <span class="n">encodings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">supported</span> <span class="ow">or</span> <span class="n">enc</span> <span class="o">==</span> <span class="s2">&quot;identity&quot;</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">enc</span><span class="p">,</span> <span class="n">quality</span><span class="p">))</span>

    <span class="c1"># Sort by quality descending</span>
    <span class="n">candidates</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">IDENTITY</span>

    <span class="n">best_encoding</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">best_encoding</span> <span class="o">==</span> <span class="s2">&quot;br&quot;</span> <span class="ow">and</span> <span class="n">is_brotli_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">BROTLI</span>
    <span class="k">if</span> <span class="n">best_encoding</span> <span class="o">==</span> <span class="s2">&quot;gzip&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">GZIP</span>
    <span class="k">return</span> <span class="n">CompressionAlgorithm</span><span class="o">.</span><span class="n">IDENTITY</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.transport.validate_callback_url" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_callback_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">require_https</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Validate a webhook callback URL against SSRF rules.</p>
<p>Rejects non-HTTPS schemes (unless <em>require_https</em> is False), missing
hostnames, private/loopback/link-local IP literals, and hostnames that
resolve to any blocked IP range (anti DNS-rebinding).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/webhook.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_callback_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">require_https</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate a webhook callback URL against SSRF rules.</span>

<span class="sd">    Rejects non-HTTPS schemes (unless *require_https* is False), missing</span>
<span class="sd">    hostnames, private/loopback/link-local IP literals, and hostnames that</span>
<span class="sd">    resolve to any blocked IP range (anti DNS-rebinding).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># --- Scheme check ---</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">_ALLOWED_SCHEMES_STRICT</span> <span class="k">if</span> <span class="n">require_https</span> <span class="k">else</span> <span class="n">_ALLOWED_SCHEMES_RELAXED</span>
    <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">WebhookURLValidationError</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Scheme &#39;</span><span class="si">{</span><span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span><span class="si">}</span><span class="s2">&#39; is not allowed. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Allowed schemes: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">allowed</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># --- Hostname presence ---</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">hostname</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hostname</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">WebhookURLValidationError</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;URL must include a hostname&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># --- IP literal check (skip DNS for raw IPs) ---</span>
    <span class="k">if</span> <span class="n">_is_ip_blocked</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">WebhookURLValidationError</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">reason</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Host &#39;</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2">&#39; resolves to a blocked address range (private/loopback/link-local)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># --- DNS resolution check (anti DNS-rebinding) ---</span>
    <span class="n">resolved_ips</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_resolve_hostname</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ip_str</span> <span class="ow">in</span> <span class="n">resolved_ips</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_is_ip_blocked</span><span class="p">(</span><span class="n">ip_str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">WebhookURLValidationError</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">reason</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Host &#39;</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2">&#39; resolved to blocked IP &#39;</span><span class="si">{</span><span class="n">ip_str</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                    <span class="s2">&quot;(private/loopback/link-local)&quot;</span>
                <span class="p">),</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;resolved_ips&quot;</span><span class="p">:</span> <span class="n">resolved_ips</span><span class="p">},</span>
            <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;webhook.url_validated&quot;</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
        <span class="n">resolved_ips</span><span class="o">=</span><span class="n">resolved_ips</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="asap.transport.verify_signature" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">verify_signature</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Constant-time check that signature matches HMAC-SHA256 of body.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/asap/transport/webhook.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">verify_signature</span><span class="p">(</span><span class="n">body</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">secret</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">signature</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Constant-time check that signature matches HMAC-SHA256 of body.&quot;&quot;&quot;</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">compute_signature</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>