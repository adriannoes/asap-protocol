# Registration Action (IssueOps): validate agent registration issues and update registry.json
# Trigger: issues opened or edited with label "registration"
# Valid submissions: create PR for registry update (auto-merge), close issue
# Invalid: comment with errors, leave issue open

name: Register Agent

on:
  issues:
    types: [opened, edited]

concurrency:
  group: registry-update
  cancel-in-progress: false

jobs:
  process-registration:
    if: contains(github.event.issue.labels.*.name, 'registration')
    runs-on: ubuntu-latest
    permissions:
      contents: write   # required to push branch and create PR
      issues: write     # required to comment and close issues
      pull-requests: write  # required for gh pr create and gh pr merge

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --frozen

      - name: Process registration
        id: process
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          uv run python scripts/process_registration.py \
            --body "$ISSUE_BODY" \
            --issue-number "$ISSUE_NUMBER" \
            --author "$GITHUB_ACTOR" \
            --output result.json

      - name: Set process result output
        id: result
        run: |
          echo "valid=$(jq -r .valid result.json)" >> $GITHUB_OUTPUT

      - name: Create PR for registry update
        if: steps.result.outputs.valid == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="registry/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH"
          git add registry.json
          git commit -m "feat(registry): register agent from issue #${{ github.event.issue.number }}"
          git push origin "$BRANCH"
          gh pr create --title "feat(registry): register agent #${{ github.event.issue.number }}" \
            --body "Auto-generated from issue #${{ github.event.issue.number }}" \
            --base main --head "$BRANCH"
          gh pr merge "$BRANCH" --auto --squash

      - name: Comment and close on success
        if: steps.result.outputs.valid == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment "${{ github.event.issue.number }}" --repo "${{ github.repository }}" --body "✅ Registration validated! A PR has been created and will be merged when checks pass."
          gh issue close "${{ github.event.issue.number }}" --repo "${{ github.repository }}"

      - name: Comment on validation failure
        if: steps.result.outputs.valid == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ERRORS=$(jq -r '.errors // "Unknown error"' result.json)
          gh issue comment "${{ github.event.issue.number }}" --repo "${{ github.repository }}" --body "❌ Validation failed: $ERRORS"
