# Registration Action (IssueOps): validate agent registration issues and update registry.json
# Trigger: issues opened or edited with label "registration"
# Valid submissions: add entry to registry.json, commit to main, close issue
# Invalid: comment with errors, leave issue open

name: Register Agent

on:
  issues:
    types: [opened, edited]

jobs:
  process-registration:
    if: contains(github.event.issue.labels.*.name, 'registration')
    runs-on: ubuntu-latest
    permissions:
      contents: write   # required to push registry.json to main
      issues: write      # required to comment and close issues

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --frozen

      - name: Process registration
        id: process
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          uv run python scripts/process_registration.py \
            --body "$ISSUE_BODY" \
            --issue-number "$ISSUE_NUMBER" \
            --author "$GITHUB_ACTOR" \
            --output result.json

      - name: Set process result output
        id: result
        run: |
          echo "valid=$(jq -r .valid result.json)" >> $GITHUB_OUTPUT

      - name: Commit and push registry (valid registration)
        if: steps.result.outputs.valid == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add registry.json
          git commit -m "feat(registry): register agent from issue #${{ github.event.issue.number }}"
          git push origin main

      - name: Comment and close on success
        if: steps.result.outputs.valid == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment "${{ github.event.issue.number }}" --repo "${{ github.repository }}" --body "✅ Registered successfully! Agent added to the registry."
          gh issue close "${{ github.event.issue.number }}" --repo "${{ github.repository }}"

      - name: Comment on validation failure
        if: steps.result.outputs.valid == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ERRORS=$(jq -r '.errors // "Unknown error"' result.json)
          gh issue comment "${{ github.event.issue.number }}" --repo "${{ github.repository }}" --body "❌ Validation failed: $ERRORS"
