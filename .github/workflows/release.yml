# Runs only on tag push (e.g. v1.0.0): validates CHANGELOG, builds Docker image, publishes to PyPI and creates GitHub Release.
name: Release (PyPI + Docker)

on:
  push:
    tags:
      - "v*"

jobs:
  validate:
    name: Validate tag and CHANGELOG
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Check CHANGELOG has version section
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          if ! grep -qF "## [${VERSION}]" CHANGELOG.md; then
            echo "::error::CHANGELOG.md has no section ## [${VERSION}]"
            exit 1
          fi

  docker:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    needs: [ validate ]
    permissions:
      contents: read
      packages: write  # Push to ghcr.io

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Docker meta (tags)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            type=semver,pattern=v{{version}}
            type=semver,pattern=v{{major}}.{{minor}}
            type=semver,pattern=v{{major}}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-and-publish:
    name: Build and publish
    runs-on: ubuntu-latest
    needs: [ validate ]
    permissions:
      id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing API
      contents: write  # Required for creating GitHub releases

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for changelog generation

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Build asap-protocol
        run: uv build

      - name: Install asap-protocol for asap-compliance build
        run: uv pip install dist/asap_protocol-*.whl

      - name: Build asap-compliance
        run: |
          cd asap-compliance && uv build
          cp -v dist/* ../dist/

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
          attestations: false  # Disable PEP 740 attestations if they cause failures
          skip-existing: true  # Skip asap-compliance when unchanged (only asap-protocol bumped)
        # Publishes both asap-protocol and asap-compliance from dist/
        # Requires Trusted Publishing configured for BOTH projects on PyPI:
        #   - asap-protocol
        #   - asap-compliance

      - name: Extract version from tag
        id: tag_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes from CHANGELOG
        id: release_notes
        run: |
          VERSION="${{ steps.tag_version.outputs.VERSION }}"
          python3 << 'PYTHON_SCRIPT'
          import re
          import os
          
          version = os.environ.get('VERSION', '')
          repo = os.environ.get('GITHUB_REPOSITORY', '')
          
          with open('CHANGELOG.md', 'r') as f:
              content = f.read()
          
          # Find the section for this version (from ## [VERSION] to next ## or end)
          pattern = rf'^## \[{re.escape(version)}\](.*?)(?=^## \[|\Z)'
          match = re.search(pattern, content, re.MULTILINE | re.DOTALL)
          
          if match:
              notes = match.group(1).strip()
              notes += '\n\n---\n\n'
              notes += f'**Full Changelog**: https://github.com/{repo}/compare/v0.1.0...v{version}'
              
              with open('release_notes.md', 'w') as out:
                  out.write(notes)
          else:
              # Fallback: create basic release notes
              with open('release_notes.md', 'w') as out:
                  out.write(f'Release v{version}\n\n')
                  out.write(f'**Full Changelog**: https://github.com/{repo}/compare/v0.1.0...v{version}')
          PYTHON_SCRIPT
        env:
          VERSION: ${{ steps.tag_version.outputs.VERSION }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "v${{ steps.tag_version.outputs.VERSION }}"
          body_path: release_notes.md
          prerelease: false
          make_latest: true
          files: dist/*
