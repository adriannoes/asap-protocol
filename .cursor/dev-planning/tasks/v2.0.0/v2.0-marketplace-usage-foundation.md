# v2.0 Marketplace: Usage Storage & Control Foundation

> **Purpose**: Document the v1.3 usage metering architecture, storage decisions, and evolution path to v2.0 Marketplace. Serves as reference when building central marketplace infrastructure.
>
> **Created**: 2026-02-16
> **Context**: Sprint E1 (Usage Metering) implementation; pre-v2.0 planning
> **Related**: [ADR-13](../../../product-specs/decision-records/01-architecture.md) (State Management), [deferred-backlog.md](../../../product-specs/strategy/deferred-backlog.md), [vision-agent-marketplace.md](../../../product-specs/strategy/vision-agent-marketplace.md)

---

## 1. Executive Summary

v1.3 implements **observability metering** with **local storage** at each agent. Usage data (tokens, duration, API calls) is stored where the agent runs. This document captures:

- Where and how usage is stored today
- Who controls usage and how
- Value delivered vs. gaps
- Evolution path to v2.0 Marketplace (central dashboard, unified view)
- Technical decisions for v2.0 implementation

---

## 2. Storage Location (v1.3)

### 2.1 SQLite Storage

| Aspect | Value |
|--------|-------|
| **Default file** | `asap_state.db` (current working directory) |
| **Configurable path** | `SQLiteMeteringStore(db_path=...)` |
| **Environment** | `ASAP_STORAGE_PATH` (used by SnapshotStore; MeteringStore will align in Task 1.3) |
| **Table** | `usage_events` |
| **Shared with** | SnapshotStore uses same DB file (`snapshots` table) |

**Source**: `src/asap/state/stores/sqlite.py`

```python
DEFAULT_DB_PATH = "asap_state.db"
USAGE_EVENTS_TABLE = "usage_events"
```

### 2.2 Storage Backends

| Backend | Use Case | Persistence |
|---------|----------|-------------|
| **InMemoryMeteringStore** | Tests, development | None (lost on restart) |
| **SQLiteMeteringStore** | Single-agent, dev, small prod | File-based, persistent |
| **PostgreSQL** (future) | Production, multi-agent | Via MeteringStore adapter |

### 2.3 Data Ownership

Per **ADR-13** (Hybrid Strategy):

- **Usage events** are stored by the **agent** (agent's infrastructure)
- **Marketplace metadata** (manifests, trust, SLA) is central
- **Usage data** is NOT central in v1.3 — each agent owns its usage store

---

## 3. Heartbeat vs. Health Endpoint

Two distinct concepts; often confused:

| Concept | Purpose | Where | Sprint |
|---------|---------|-------|--------|
| **Heartbeat (WebSocket)** | Keepalive for WebSocket connections | `transport/websocket.py` | v1.1.0 S3 ✅ |
| **Health endpoint** | Liveness/readiness for agent availability | `discovery/health.py` | v1.1.0 S2 ✅ |
| **SLA monitoring** | Uses health endpoint for uptime measurement | — | v1.3.0 E3 |

### 3.1 Heartbeat (WebSocket)

- **Interval**: 30 seconds (ping from server, pong from client)
- **Purpose**: Detect stale connections, avoid silent disconnects
- **Scope**: Transport layer only — does NOT indicate agent "health" for discovery
- **Constants**: `HEARTBEAT_PING_INTERVAL`, `HEARTBEAT_FRAME_TYPE_PING`, `HEARTBEAT_FRAME_TYPE_PONG`

### 3.2 Health Endpoint

- **URL**: `GET /.well-known/asap/health`
- **Purpose**: Registry liveness, SLA availability monitoring
- **Per ADR-14**: Agents SHOULD expose this; manifests SHOULD include `ttl_seconds`
- **SLA Framework (E3)**: Uses health checks to measure uptime vs. promised SLA

---

## 4. Usage Control Model (v1.3)

### 4.1 Who Controls What

| Persona | Visibility | Control Mechanism |
|---------|------------|-------------------|
| **Agent Provider** | Full usage (tokens, duration, API calls per task) | Local storage + GET /usage (Task 1.4) |
| **Agent Consumer** | Own usage per agent | Query GET /usage?consumer_id=X on each agent |
| **Enterprise Admin** | Limits via delegation | Delegation tokens (Sprint E2) with scopes/expiration |

### 4.2 How Control Works

1. **Delegation tokens** (E2): Admin creates token with limits (e.g., `max_cost_usd`, `expires_at`)
2. **Consumer** uses token when calling agent (Bearer or custom header)
3. **Agent** validates token and checks limits against **local usage** (MeteringStore)
4. **Enforcement**: Agent rejects request if limit exceeded

**Key point**: Control is **local** — the agent enforces limits using its own MeteringStore. No central authority checks usage before the request reaches the agent.

### 4.3 Value Delivered Today

| Persona | Value | Gap |
|---------|-------|-----|
| Provider | Optimize costs, understand patterns | ✅ |
| Consumer (1 agent) | Query GET /usage for own usage | ✅ |
| Consumer (N agents) | Must query each agent separately | ❌ No unified view |
| Admin | Delegation limits enforced at agent | ✅ |
| Marketplace | — | ❌ No central dashboard yet |

---

## 5. Evolution Path to v2.0 Marketplace

### 5.1 Deferred Components (from deferred-backlog.md)

| Feature | Deferred To | Trigger |
|---------|-------------|---------|
| Registry API Backend | v2.1 | 500+ agents in Lite Registry |
| Audit Logging | v2.1+ | Enterprise customer or billing disputes |
| Economy Settlement / Credits | v3.0 | Revenue > $5k/mo + user demand |
| Payment Processing | v3.0 | 100+ Verified Agents |

### 5.2 Options for Central Usage (v2.0+)

#### Option A: Foundation-First (Current Path)

- v1.3: Local storage, GET /usage, delegation
- v2.0: Marketplace API (registry, discovery)
- v2.x: Add "report to marketplace" — agents push usage to central API when configured
- v3.0: Billing, credits, central dashboard

**Pros**: No premature infrastructure; agents own data until marketplace exists  
**Cons**: Consumer has no unified view until v2.x

#### Option B: Reporting Hook (Recommended Addition)

- Add optional `ASAP_USAGE_REPORT_URL` (or `usage_report_webhook` in config)
- When agent records usage, also POST to URL if configured
- Marketplace (when built) provides endpoint; agents opt-in
- No central storage required until v2.0 exists

**Pros**: Prepares for v2.0 without building it now; opt-in  
**Cons**: Adds config surface; agents must implement webhook call

#### Option C: Consumer-Side Aggregator

- "Usage Dashboard" app discovers agents from registry
- For each agent consumer uses, calls GET /usage?consumer_id=X
- Aggregates client-side
- Works without central storage

**Pros**: No backend changes; works with v1.3  
**Cons**: Consumer must know which agents they use; no real-time; trust (agent could lie)

### 5.3 Recommended v2.0 Implementation Checklist

When building v2.0 Marketplace:

1. **Central Usage API**
   - `POST /usage/events` — agents report usage (from Option B hook)
   - `GET /usage/consumer/:id` — aggregated view for consumer
   - `GET /usage/agent/:id` — provider view (or pull from agent)

2. **Storage**
   - PostgreSQL (or equivalent) for usage events
   - Indexed by: `consumer_id`, `agent_id`, `timestamp`
   - Retention policy (e.g., 90 days raw, aggregates forever)

3. **Dashboard**
   - Consumer: "My usage across all agents"
   - Provider: "Usage of my agent"
   - Admin: "Usage by team/consumer"

4. **Delegation Enforcement** (optional v2.x)
   - Pre-check: Marketplace validates "consumer X under limit?" before agent sees request
   - Requires agent to check with marketplace OR marketplace as proxy
   - Current model (agent enforces locally) remains valid

---

## 6. Technical Reference for v2.0

### 6.1 Usage Event Schema (from economics layer)

```json
{
  "task_id": "task_123",
  "agent_id": "urn:asap:agent:provider",
  "consumer_id": "urn:asap:agent:consumer",
  "metrics": {
    "tokens_in": 1500,
    "tokens_out": 2300,
    "duration_ms": 4500,
    "api_calls": 3
  },
  "timestamp": "2026-02-06T12:00:00Z"
}
```

**Models**: `asap.economics.UsageMetrics`, `asap.state.metering.UsageEvent`

### 6.2 GET /usage Query Params (Task 1.4)

- `agent_id` — filter by agent
- `consumer_id` — filter by consumer (for consumer view)
- `start`, `end` — time range
- Pagination: `limit`, `offset`

### 6.3 Aggregation Models (economics layer)

- `UsageAggregateByAgent` — totals per agent, period
- `UsageAggregateByConsumer` — totals per consumer, period
- `UsageAggregateByPeriod` — totals per period, unique agents/consumers

---

## 7. Decision Log

| Date | Decision |
|------|----------|
| 2026-02-16 | Document created; v1.3 uses local storage; central usage is v2.0+ |
| 2026-02-16 | Option B (reporting hook) recommended for future consideration |
| 2026-02-16 | GET /usage must support `consumer_id` filter for consumer self-service |

---

## 8. Related Documents

- [ADR-13: State Management](../../../product-specs/decision-records/01-architecture.md) — Hybrid strategy, MeteringStore interface
- [ADR-14: Agent Liveness](../../../product-specs/decision-records/01-architecture.md) — Health endpoint
- [deferred-backlog.md](../../../product-specs/strategy/deferred-backlog.md) — Audit, Economy Settlement
- [vision-agent-marketplace.md](../../../product-specs/strategy/vision-agent-marketplace.md) — Economy Layer
- [sprint-E1-usage-metering.md](../v1.3.0/sprint-E1-usage-metering.md) — Implementation tasks
