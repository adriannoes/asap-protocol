# Sprint M3: Developer Experience (IssueOps)

> **Goal**: Low-friction Agent Registration via IssueOps
> **Prerequisites**: Sprint M2 completed (Web App Features)
> **Parent Roadmap**: [tasks-v2.0.0-roadmap.md](./tasks-v2.0.0-roadmap.md)

---

## Relevant Files

- `.github/ISSUE_TEMPLATE/register_agent.yml` - Registration Form Definition
- `.github/workflows/register-agent.yml` - Registration Action
- `apps/web/app/register/page.tsx` - Web Registration Form
- `apps/web/app/verify/page.tsx` - Verification Request Form
- `apps/web/lib/github-issues.ts` - Issue Submission Logic

---

## Context

This sprint optimizes the **Developer Experience** for registering agents by migrating from a PR-based flow to an IssueOps flow.
**Why the change?** The M2 automated PR flow requires the NextAuth GitHub App to request `public_repo` permissions, which gives the web app write access to all of a user's repositories. This creates massive friction and trust issues for developers trying to register.
By providing a **Web Form** that generates a pre-filled GitHub Issue (which the user submits themselves on GitHub.com), we can downgrade the NextAuth scope to just `read:user`.
A **GitHub Action** then processes this Issue to validate the agent and automatically merge it into `registry.json`.

---

## Task 3.1: GitHub Issue Template

### Sub-tasks

- [ ] 3.1.1 Create `register_agent.yml`
  - **Inputs**: Must directly map to the `Manifest` fields:
    - Name (slug-friendly)
    - Description
    - Manifest URL
    - HTTP Endpoint
    - WebSocket Endpoint (Optional)
    - Skills (comma-separated)
  - **Validation**: Regex for URLs, required fields
  - **Labels**: `registration`, `pending-review`

**Acceptance Criteria**:
- [ ] Users can open a new Issue using the template
- [ ] Template enforces required fields

---

## Task 3.2: Web Registration Form

### Sub-tasks

- [ ] 3.2.1 Update NextAuth Scopes (`apps/web/src/auth.ts`)
  - **Action**: Remove `public_repo` or `repo` scopes from the GitHub provider.
  - **Goal**: Only request `read:user` (or `user:email`) to restore developer trust.

- [ ] 3.2.2 Refactor `/dashboard/register/page.tsx`
  - **Form Framework**: React Hook Form + Zod (Keep existing layout)
  - **Fields**: Match Issue Template exactly.

- [ ] 3.2.3 Client-side Validation (Zod) & Reachability (Keep existing)
  - Schema: `ManifestSchema` (shared)
  - **Reachability**: Keep the existing SSR/Server Action reachability check.

- [ ] 3.2.4 "Submit" Logic Pivot
  - **Action**: Remove the `octokit.rest.pulls.create` logic from `actions.ts`.
  - **New Action**: Construct GitHub Issue URL with query params matching the YAML template inputs.
    - Example: `https://github.com/adriannoes/asap-protocol/issues/new?template=register_agent.yml&title=Register:+<name>&name=<name>&description=<description>&manifest_url=...`
  - **Redirect**: Open GitHub in a new tab so the user can click "Submit new issue".

- [ ] 3.2.5 Unit Tests for Registration Form (Vitest)
  - **Action**: Create `apps/web/src/app/dashboard/register/register-form.test.tsx`.
  - **Tests**: 
    - Verify Zod schema validation (e.g., regex constraints, required fields).
    - Mock GitHub Issue URL generation and ensure it matches the expected template.

**Acceptance Criteria**:
- [ ] Form validates inputs locally
- [ ] "Submit" opens correct GitHub Issue URL with pre-filled data

---

## Task 3.3: Registration Action (The "Ops")

### Sub-tasks

- [ ] 3.3.1 Create `.github/workflows/register-agent.yml`
  - **Trigger**: `issues: [opened, edited]`
  - **Condition**: Label `registration` present

- [ ] 3.3.2 Parsing Script (`scripts/process_registration.py`)
  - **Input**: Issue Body (Markdown/YAML)
  - **Parsing**: Use regex to extract data under markdown headers generated by the GitHub Issue Form.
  - **Output**: JSON Agent Object matching `Manifest` schema.

- [ ] 3.3.3 Validation Steps
  - **Schema**: Validate against the `Manifest` Pydantic model (`src/asap/models/entities.py`).
  - **Network**: Fetch the Manifest URL to ensure it is alive.
  - **Identity**: Ensure `id` matches `urn:asap:agent:<github_username>:<name>`.
  - **Uniqueness**: Check if `id` exists in `registry.json` (prevent duplicate names for the same user).

- [ ] 3.3.4 Auto-Merge Logic
  - **Permissions**: The workflow needs `permissions: contents: write` to push to `main` (if branch protections allow).
  - **If Valid**:
    - Add to `registry.json`.
    - Commit directly to `main`: `feat(registry): register <agent_id>`.
    - Close Issue with comment: "✅ Registered successfully!" via `gh issue close`.
  - **If Invalid**:
    - Comment on Issue: "❌ Validation failed: <errors>" via `gh issue comment`.
    - Leave Issue open for edits.

- [ ] 3.3.5 Unit Tests for Parsing Script (pytest)
  - **Action**: Create `tests/scripts/test_process_registration.py`.
  - **Tests**:
    - Parse valid and invalid markdown issue templates.
    - Mock network calls for Manifest reachability.
    - Verify strict schema validation logic using the `Manifest` Pydantic model.

**Acceptance Criteria**:
- [ ] Valid Issue -> Agent added to `registry.json` -> Issue Closed
- [ ] Invalid Issue -> Error Comment -> Issue Open

---

## Task 3.4: Developer Dashboard Integration

### Sub-tasks

- [ ] 3.4.1 "My Agents" Logic
  - **Filter**: `registry.json` where `agent.id` is `urn:asap:agent:<github_username>:<name>`. (Manifest has no `maintainers` field!).
  - **Status**:
    - "Listed": Fetch from `registry.json`.
    - "Pending": Use Octokit (read-only) to fetch open issues in `asap-protocol` created by `author:<github_username>` with label `registration`.
    - "Verified": Agent has `verification.status === 'verified'` in `registry.json` (Requires Task 3.6).

- [ ] 3.4.2 Dashboard UI Updates
  - Show "Pending Registration" cards
  - Show "Apply for Verified" button on eligible agents (Listed + Unverified)

**Acceptance Criteria**:
- [ ] Dashboard shows true status of all agents

---

## Task 3.5: Verified Badge Request (IssueOps)

### Sub-tasks

- [ ] 3.5.1 Create `request_verification.yml` Issue Template
  - **Inputs**: Agent ID, Evidence of reliability (links, uptime stats), Contact info
  - **Labels**: `verification-request`, `pending-review`

- [ ] 3.5.2 Verification Form (Web)
  - **Route**: `/dashboard/verify?agent_id=...`
  - **Fields**: "Why should this agent be verified?", "How long has it been running?"
  - **Action**: Redirects to pre-filled GitHub Issue

- [ ] 3.5.3 Admin Review Process (Manual)
  - **Documentation**: Guide for admins on how to vet agents (uptime check, code review if open source).
  - **Action**: Admin manually edits `registry.json` to add `verification` details.

- [ ] 3.5.4 Unit Tests for Verification Form (Vitest)
  - **Action**: Create tests for the verification form logic.
  - **Tests**: Assert correctly parameterized GitHub Issue URL generation.

---

## Task 3.6: Update Protocol Schema (IssueOps Pre-requisite)

> **Context**: The `verification` field does not exist in `src/asap/models/entities.py`, so adding it to `registry.json` would break Python validation and TypeScript models.

### Sub-tasks

- [ ] 3.6.1 Update `src/asap/models/entities.py`
  - Add a `VerificationStatus` model (`status: str`, `verified_at: str`).
  - Add `verification: Optional[VerificationStatus] = None` to the `Manifest` class.

- [ ] 3.6.2 Regenerate TypeScript Types
  - Run `python scripts/generate_types.py` so the web app can use `agent.verification`.

**Acceptance Criteria**:
- [ ] Users can submit verification request via Dashboard
- [ ] Issue template specifically for verification exists

---

## Sprint M3 Definition of Done

- [ ] Registration flow (Web -> Issue -> Action) working end-to-end
- [ ] Developers can register agents without manual Git commands
- [ ] Invalid registrations are automatically rejected with feedback

**Total Sub-tasks**: ~12

## Documentation Updates
- [ ] **Update Roadmap**: Mark completed items in [v2.0.0 Roadmap](./tasks-v2.0.0-roadmap.md)
