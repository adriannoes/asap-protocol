# v1.1 Security Model

> Trust model, identity binding, and security limitations for ASAP Protocol v1.1.  
> See [ADR-17](../../.cursor/product-specs/ADR.md#question-17-trust-model-and-identity-binding-in-v11) for the decision record.

---

## Summary

| What v1.1 provides | What v1.1 does NOT provide |
|:-------------------|:----------------------------|
| **Authentication** — valid credentials from an IdP (OAuth2/OIDC) | **Identity verification** — proof that the client is the agent it claims to be |
| **Authorization** — scopes (e.g. `asap:execute`) | **Cryptographic binding** — that binding comes in v1.2 (Ed25519 signed manifests) |
| **Identity mapping** — Custom Claims or allowlist to map JWT → agent URN | **Impersonation prevention** — without signed manifests, trust is “valid token + claim/match” only |

This is the same trust model as most web APIs today: OAuth2 is analogous to **API keys with scopes**. Real identity verification (PKI) is layered in later (v1.2).

---

## v1.1 Trust Model

### Authentication (what you get)

- The server validates the Bearer JWT using the IdP’s JWKS (signature, expiry, issuer/audience if configured).
- If the token is valid, the request is **authenticated**: the caller has valid credentials from the IdP.
- Optional **scope** checks (e.g. `required_scope="asap:execute"`) enforce **authorization**.

### What is NOT guaranteed

- **Identity verification**: v1.1 does not prove that the caller “is” the agent URN it sends in the envelope. It only proves “this token was issued by the IdP and (optionally) carries a claim or allowlist mapping to this agent.”
- **Impersonation**: A compromised token or a misconfigured IdP could allow one agent to act under another’s URN until you add v1.2 signed manifests and (optionally) mTLS.

### Analogy: Stripe-style trust

- **v1.0**: API key → “whoever has the key can call the API.”
- **v1.1**: OAuth2 + Custom Claims → “whoever has a valid token with the right claim/allowlist can act as this agent.” (Same as “API key + scope” in practice.)
- **v1.2**: Signed manifests (Ed25519) → “only the holder of the private key for this manifest can prove they are this agent.” (KYC/identity layer.)

Documenting this explicitly avoids false expectations that v1.1 alone gives “verified agent identity.”

---

## Threat Model (v1.1)

### In scope and mitigated

| Threat | Mitigation |
|:-------|:-----------|
| Forged or expired tokens | JWT validation (signature, `exp`); JWKS from IdP |
| Missing or insufficient scope | `required_scope` in OAuth2Config |
| Sender ≠ authenticated agent | Envelope `sender` must match authenticated agent (Custom Claim or allowlist) |
| Replay (optional) | Nonce validation when `require_nonce=True` |
| SSRF on webhooks | URL validation (private IPs, localhost blocked; HTTPS in production) |
| Abuse / DoS | Rate limiting (per-sender, configurable) |

### Known limitations (v1.1)

| Limitation | Mitigation |
|:-----------|:-----------|
| No cryptographic proof of agent identity | Use v1.2 signed manifests (Ed25519) when available |
| IdP misconfiguration can map wrong `sub` to agent | Rely on Custom Claims where possible; restrict allowlist; audit IdP config |
| Token theft = full agent capability | Short-lived tokens; secure storage; consider v1.2 + mTLS for high-assurance |

---

## Configuring Custom Claims

Identity binding maps the JWT to the ASAP agent URN so that the server can enforce “envelope `sender` = authenticated agent.”

### Option 1: Custom Claim (recommended)

- The IdP adds a **custom claim** to the JWT whose value is the agent URN (e.g. `urn:asap:agent:research-v1`).
- The ASAP server reads this claim and checks it equals the manifest `id`. If not, the request is rejected (403).

**Environment variable**

- `ASAP_AUTH_CUSTOM_CLAIM`: JWT claim key (URI or string).  
- Default (if unset): `https://github.com/adriannoes/asap-protocol/agent_id`  
- Example: `ASAP_AUTH_CUSTOM_CLAIM=https://asap.ai/agent_id`

**Code**

When creating the app, pass `OAuth2Config(..., manifest_id=manifest.id)`. The middleware uses `manifest_id` for this check. You can override the claim key with `OAuth2Config(..., custom_claim="https://asap.ai/agent_id")`.

### Option 2: Allowlist fallback

When the IdP cannot add custom claims, you can map “manifest id → allowed `sub` (or list of subs)” via environment.

**Environment variable**

- `ASAP_AUTH_SUBJECT_MAP`: JSON object. Keys = agent URNs (manifest id), values = single `sub` string or list of `sub` strings.

**Example**

```bash
export ASAP_AUTH_SUBJECT_MAP='{"urn:asap:agent:research-v1":"auth0|abc123"}'
```

Multiple subs for one agent:

```bash
export ASAP_AUTH_SUBJECT_MAP='{"urn:asap:agent:bot":["auth0|id1","auth0|id2"]}'
```

If the JWT has no custom claim (or the claim key is missing), the server falls back to this map. If `sub` is in the allowlist for this manifest id, the request is accepted. Prefer Custom Claims where possible; allowlist is for environments that cannot emit custom claims.

---

## Custom Claims: Provider-specific guides

### Auth0

1. In the Auth0 Dashboard, go to **Applications** → your Application → **Settings**.
2. Use **Rules** (Classic) or **Actions** (recommended) to add a claim to the token.
3. Add the agent URN to `idToken` and/or `accessToken` under the claim name that matches `ASAP_AUTH_CUSTOM_CLAIM` (e.g. `https://asap.ai/agent_id`).

**Example Rule (Classic)**:

```javascript
function addAgentId(user, context, callback) {
  context.idToken['https://asap.ai/agent_id'] = 'urn:asap:agent:my-bot';
  context.accessToken['https://asap.ai/agent_id'] = 'urn:asap:agent:my-bot';
  callback(null, user, context);
}
```

**Actions**: Create an Action that runs at “Login / Post Login”, and set `event.idToken['https://asap.ai/agent_id'] = 'urn:asap:agent:my-bot'` (and same for `event.accessToken` if you use access tokens for ASAP).  
See [Auth0 Rules](https://auth0.com/docs/rules) and [Actions](https://auth0.com/docs/customize/actions).

### Keycloak

1. Go to **Client Scopes** (or your client’s scopes).
2. Create or select a scope and add a **Mapper** (e.g. “By configuration” → “User Attribute” or “Hardcoded claim”).
3. Set **Token Claim Name** to the same value as `ASAP_AUTH_CUSTOM_CLAIM` (e.g. `https://asap.ai/agent_id`).
4. Set the claim value to the agent URN (e.g. from a user attribute or hardcoded for machine-to-machine).

For client credentials / service accounts, a “Hardcoded claim” mapper with value `urn:asap:agent:my-bot` is typical.  
See [Keycloak Client Scopes](https://www.keycloak.org/docs/latest/server_admin/#_client_scopes) and [Protocol Mappers](https://www.keycloak.org/docs/latest/server_admin/#_protocol-mappers).

### Azure AD (Microsoft Entra ID)

1. **App registration** → your app → **Token configuration** (or **Optional claims** for ID tokens).
2. Add an optional claim or use **App roles** to encode which agent can act.
3. For a custom claim name matching `ASAP_AUTH_CUSTOM_CLAIM`, you can use **Application claims** (e.g. via custom security attributes or claims mapping).

Alternatively, use **App roles** (e.g. role name = agent URN or a short id) and map that role to a claim; then in ASAP you could use the allowlist to map `sub` + role to agent URN. For a direct custom claim:
- **Optional claims**: Add a custom claim (name = your `ASAP_AUTH_CUSTOM_CLAIM` URI) if your tenant supports it.
- **Claims mapping**: In the app manifest, define `optionalClaims` or use claims mapping policies to emit `https://asap.ai/agent_id` (or your chosen URI) with value `urn:asap:agent:my-bot`.

See [Optional claims](https://learn.microsoft.com/en-us/entra/identity-platform/optional-claims) and [App roles](https://learn.microsoft.com/en-us/entra/identity-platform/howto-add-app-roles-in-azure-ad-apps).

---

## Migration path to v1.2

- **v1.1**: Identity is “valid token + Custom Claim or allowlist.” No cryptographic proof of agent identity.
- **v1.2**: Signed manifests (Ed25519) allow the registry and other agents to verify that a given manifest (and thus agent URN) is bound to a key. That adds **identity verification** on top of OAuth2.
- Recommendation: Use v1.1 OAuth2 + Custom Claims (or allowlist) now; plan to adopt v1.2 signed manifests and (optionally) mTLS for high-assurance deployments.

---

## References

- [ADR-17: Trust Model and Identity Binding](https://github.com/adriannoes/asap-protocol/blob/main/.cursor/product-specs/ADR.md#question-17-trust-model-and-identity-binding-in-v11)
- [Security Guide](../security.md) — general ASAP security (rate limits, nonce, HTTPS, etc.)
- [Transport](https://github.com/adriannoes/asap-protocol/blob/main/docs/transport.md) — OAuth2 middleware and `create_app` usage
